<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å‘¨å°ç™½</title>
  
  
  <link href="http://baixiaozhou.github.io/atom.xml" rel="self"/>
  
  <link href="http://baixiaozhou.github.io/"/>
  <updated>2024-08-19T11:17:06.384Z</updated>
  <id>http://baixiaozhou.github.io/</id>
  
  <author>
    <name>baixiaozhou</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ansibleå·¥å…·ä½¿ç”¨</title>
    <link href="http://baixiaozhou.github.io/p/ansible%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/"/>
    <id>http://baixiaozhou.github.io/p/ansible%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/</id>
    <published>2024-08-19T11:09:34.000Z</published>
    <updated>2024-08-19T11:17:06.384Z</updated>
    
    <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a>ansibleå·¥å…·ä½¿ç”¨</h1><p>This article was written by baixiaozhou on 1724065774000.</p><!-- Your content starts here -->]]></content>
    
    
    <summary type="html">A brief description of the content</summary>
    
    
    
    <category term="Technology" scheme="http://baixiaozhou.github.io/categories/Technology/"/>
    
    
    <category term="Programming" scheme="http://baixiaozhou.github.io/tags/Programming/"/>
    
    <category term="Hexo" scheme="http://baixiaozhou.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ä¸Šæ•…éšœæ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»</title>
    <link href="http://baixiaozhou.github.io/p/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/"/>
    <id>http://baixiaozhou.github.io/p/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/</id>
    <published>2024-08-15T03:12:21.000Z</published>
    <updated>2024-08-19T10:55:52.568Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><ul><li><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2">å†™åœ¨å‰é¢</a></li><li><a href="#cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E9%A3%99%E5%8D%87">CPUä½¿ç”¨ç‡é£™å‡</a><ul><li><a href="#%E5%A6%82%E4%BD%95%E8%AE%A9cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E9%A3%99%E5%8D%87">å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡</a></li><li><a href="#%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E5%92%8C%E5%8F%91%E7%8E%B0cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E9%A3%99%E5%8D%87">å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡</a></li><li><a href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9Acpu%E9%A3%99%E5%8D%87%E7%9A%84%E6%A0%B9%E6%BA%90">å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº</a><ul><li><a href="#perf%E5%91%BD%E4%BB%A4">perfå‘½ä»¤</a></li><li><a href="#jstack">jstack</a></li><li><a href="#%E7%81%AB%E7%84%B0%E5%9B%BE">ç«ç„°å›¾</a></li></ul></li></ul></li><li><a href="#%E8%B4%9F%E8%BD%BD%E9%A3%99%E5%8D%87">è´Ÿè½½é£™å‡</a><ul><li><a href="#%E8%B4%9F%E8%BD%BD%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E8%B4%9F%E8%BD%BD">è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½</a></li><li><a href="#%E5%A6%82%E4%BD%95%E8%AE%A9%E7%B3%BB%E7%BB%9F%E8%B4%9F%E8%BD%BD%E9%A3%99%E9%AB%98">å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜</a><ul><li><a href="#%E7%BA%AF%E8%AE%A1%E7%AE%97%E4%BB%BB%E5%8A%A1%E5%AF%B9%E8%B4%9F%E8%BD%BD%E7%9A%84%E5%BD%B1%E5%93%8D">çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“</a></li><li><a href="#%E7%A3%81%E7%9B%98-io-%E5%AF%B9%E8%B4%9F%E8%BD%BD%E7%9A%84%E5%BD%B1%E5%93%8D">ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“</a></li><li><a href="#%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C-io-%E6%A8%A1%E6%8B%9F-d-%E7%8A%B6%E6%80%81%E8%BF%9B%E7%A8%8B%E8%A7%82%E5%AF%9F%E8%B4%9F%E8%BD%BD%E5%BD%B1%E5%93%8D">é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“</a></li></ul></li><li><a href="#%E8%B4%9F%E8%BD%BD%E9%A3%99%E5%8D%87%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5">è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥</a></li></ul></li></ul><h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>åœ¨å¾ˆå¤šæ–‡ç« ä¸­ï¼Œæ¯å½“æåˆ°å»è§£å†³çº¿ä¸Šé—®é¢˜çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†çš„å¤„ç†æ–¹å¼å°±æ˜¯ç™»å½•ç¯å¢ƒï¼Œå“å“å„ç§æ•²å‘½ä»¤ã€‚æ“ä½œæœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—è¿™ç§åšæ³•å…¶å®æ˜¯æœ¬æœ«å€’ç½®çš„ï¼Œè¿‡äºåœ¨ä¹å»å¿«é€ŸæŠ“ä½é‡ç‚¹é—®é¢˜ï¼Œè€Œå¿½ç•¥äº†ä»å…¨å±€å»çœ‹é—®é¢˜ã€‚é‚£ä¹ˆå¦‚æœæœ€å¼€å§‹ä¸å»æ“ä½œå„ç§å‘½ä»¤ï¼Œé‚£åº”è¯¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><em><strong>çœ‹ç›‘æ§ï¼ï¼ï¼ï¼</strong></em></p><p>é¦–å…ˆä¸è¦è§‰å¾—è¿™ä¸ªæ˜¯åºŸè¯ï¼Œå¯¹äºå¾ˆå¤šåœºæ™¯æ¥è¯´ï¼Œä¸šåŠ¡è§„æ¨¡æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæœ‰çš„æ—¶å€™å¹¶å‘è¶…è¿‡äº†æé™çš„æ€§èƒ½ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹éƒ½æ²¡æœ‰å¿…è¦å»åå°è¿›è¡Œå„ç§æŸ¥è¯¢ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡å¦‚è¯´æŸå¥—ä¸šåŠ¡ç³»ç»Ÿï¼Œæœ¬èº«åªèƒ½æ”¯æŒ 500 å¹¶å‘ï¼Œç°åœ¨å®é™…ä¸Šçš„é‡åˆ°äº† 2000ï¼Œå¯¼è‡´çº¿ä¸Šå„ç§å†…å­˜ã€CPUã€è´Ÿè½½çš„å‘Šè­¦ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜æœ‰å¿…è¦å»åå°æ•²<code>top</code>ã€<code>free</code>å—ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è€ƒè™‘å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œå¿«é€Ÿçš„æ‰©å®¹ç­‰ã€‚</p><p>çœ‹ç›‘æ§çš„æ„ä¹‰åœ¨äºå°½å¯èƒ½çš„æ‰¾åˆ°æ›´å¤šçš„æ€§èƒ½ç“¶é¢ˆæˆ–è€…å¼‚å¸¸çš„ç‚¹ï¼Œä»å…¨å±€å‡ºå‘ï¼Œå¯¹ç³»ç»Ÿå½“å‰å­˜åœ¨çš„é—®é¢˜å’Œå¼‚å¸¸ç‚¹æœ‰å…¨é¢çš„äº†è§£ã€‚</p><p>ç›‘æ§ç³»ç»Ÿå¤šç§å¤šæ ·ï¼Œä»è¾ƒæ—©çš„ zabbix åˆ°ç°åœ¨æ¯”è¾ƒæµè¡Œçš„prometheus+grafanaï¼ˆä¸¾ä¸¤ä¸ªå¸¸ç”¨çš„ä¾‹å­ï¼‰ï¼Œå¯¹äºç³»ç»Ÿä¸šåŠ¡éƒ½æœ‰æ¯”è¾ƒå®Œå–„çš„ç›‘æ§ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ å…·ä½“çš„äº†è§£åˆ°ç³»ç»Ÿè¿è¡Œå…¨è²Œã€‚å¦‚æœä½ å¯¹è¿™äº›éƒ½ä¸å–œæ¬¢ï¼Œé‚£ä¹ˆä½ è‡ªå·±å†™ä¸€ä¸ªç›‘æ§ç³»ç»Ÿä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å½“æˆ‘ä»¬çœ‹å®Œç›‘æ§ä¹‹åï¼ˆå‡è®¾ä½ çœŸçš„çœ‹äº†ï¼‰ï¼Œæ¥ä¸‹æ¥è¿›å…¥å®é™…æ“ä½œç¯èŠ‚ï¼Œæˆ‘ä¼šä»è¿™äº›æŒ‡æ ‡çš„è¯¦ç»†å«ä¹‰å‡ºå‘ï¼Œç„¶åå°½å¯èƒ½åœ°å°†å„ç§å¤„ç†æ–¹å¼åˆ†äº«ç»™å¤§å®¶ã€‚</p><h2 id="CPUä½¿ç”¨ç‡é£™å‡"><a href="#CPUä½¿ç”¨ç‡é£™å‡" class="headerlink" title="CPUä½¿ç”¨ç‡é£™å‡"></a>CPUä½¿ç”¨ç‡é£™å‡</h2><h3 id="å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡"><a href="#å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡" class="headerlink" title="å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡"></a>å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡</h3><p>è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œåªè¦æœ‰è®¡ç®—ä»»åŠ¡ä¸€ç›´å­˜åœ¨ï¼Œè®© CPU ä¸€ç›´å¤„äºç¹å¿™ä¹‹ä¸­ï¼Œé‚£ä¹ˆ CPU å¿…ç„¶é£™å‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—çš„å·¥å…·å»æ¨¡æ‹Ÿè¿™ä¸ªæƒ…å†µã€‚</p><p><a href="https://github.com/baixiaozhou/SysStress">github SysStress</a> è¿™æ˜¯æˆ‘è‡ªå·±ç”¨ golang å†™çš„å‹æµ‹å·¥å…·(è¿˜åœ¨å¼€å‘ä¸­ï¼Œå¯ä»¥ç‚¹ä¸ª star è®©æˆ‘æ›´æœ‰åŠ¨åŠ›ğŸ˜‚)</p><p>ä½¿ç”¨æ–¹æ³•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sysstress cpu --cpu-number 10 --duration 10m</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ˜¯æ¨¡æ‹Ÿå ç”¨ 10 æ ¸å¿ƒçš„ CPU å¹¶æŒç»­ 10minï¼Œå½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„å‹æµ‹å·¥å…·ï¼Œæ¯”å¦‚<code>stress-ng</code></p><h3 id="å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡"><a href="#å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡" class="headerlink" title="å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡"></a>å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œè·Ÿ CPU ä½¿ç”¨ç‡ç›¸å…³çš„æœ‰å“ªäº›æŒ‡æ ‡ã€‚æˆ‘ä»¬é€šè¿‡ <code>top</code> å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„ä¿¡æ¯</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/top.png" alt="top" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">top</span></div></div><!-- ![top](../images/top.png) --><p>è¿™äº›è¾“å‡ºä¸­æœ‰ä¸€è¡Œæ˜¯ <code>%Cpu(s)</code>, è¿™è¡Œå±•ç¤ºäº† CPU çš„æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”çš„å½¢å¼ï¼Œæˆ‘ä»¬è¯¦ç»†é˜è¿°ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">us, user    : time running un-niced user processes   æœªé™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´</span><br><span class="line">sy, system  : time running kernel processes          å†…æ ¸è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´</span><br><span class="line">ni, nice    : time running niced user processes      é™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´</span><br><span class="line">id, idle    : time spent in the kernel idle handler  ç©ºé—²çš„æ—¶é—´</span><br><span class="line">wa, IO-wait : time waiting for I/O completion        ç­‰å¾… I/O æ“ä½œå®Œæˆæ‰€èŠ±è´¹çš„æ—¶é—´</span><br><span class="line">hi : time spent servicing hardware interrupts        å¤„ç†ç¡¬ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´</span><br><span class="line">si : time spent servicing software interrupts        å¤„ç†è½¯ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´</span><br><span class="line">st : time stolen from this vm by the hypervisor      è¢«è™šæ‹Ÿæœºç®¡ç†ç¨‹åºä»æ­¤è™šæ‹Ÿæœºä¸­çªƒå–çš„æ—¶é—´</span><br></pre></td></tr></table></figure><p>åœ¨è¿™äº›æŒ‡æ ‡ä¸­ï¼Œä¸€èˆ¬å…³æ³¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ usã€syã€idã€waï¼ˆå…¶ä»–å‡ ä¸ªæŒ‡æ ‡å¾ˆé«˜çš„æƒ…å†µæˆ‘ä¸ªäººç›®å‰åŸºæœ¬ä¸Šæ²¡æœ‰é‡åˆ°è¿‡ï¼‰</p><p>ä¸Šè¿°æŒ‡æ ‡åæ˜ äº†ç³»ç»Ÿæ•´ä½“çš„ CPU æƒ…å†µã€‚è€Œç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­å®é™…ä¸Šæ˜¯ä»¥ä¸€ä¸ªä¸ªçš„è¿›ç¨‹å­˜åœ¨çš„ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•ç¡®å®šåˆ°å ç”¨ CPU é«˜çš„è¿›ç¨‹å‘¢ï¼Ÿè®©æˆ‘ä»¬çš„ç›®å…‰ä» top çš„å¤´éƒ¨ä¿¡æ¯å¾€ä¸‹ç§»åŠ¨ï¼Œä¸‹é¢å°±å±•ç¤ºäº†è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/top-process.png" alt="top-process" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">top-process</span></div></div><!-- ![top-process](../images/top-process.png) --><p>è¿™äº›ç¨‹åºé»˜è®¤æ˜¯æŒ‰ç…§ CPU çš„ä½¿ç”¨ç‡ä»é«˜åˆ°åº•è¿›è¡Œæ’åºçš„ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨<code>top</code>çš„æ—¶å€™è¾“å…¥<code>P</code>è¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ¶ˆè€— CPU èµ„æºçš„è¯¦ç»†è¿›ç¨‹ä¿¡æ¯</p><p>ä¸Šé¢æ˜¯æˆ‘é€šè¿‡ <code>./sysstress cpu --cpu-number 10 --duration 10m</code> å‹æµ‹ç¨‹åºè·‘å‡ºæ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ sysstress ç¨‹åºå ç”¨äº† 1002 çš„ %CPUï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬ä¸Šæ˜¯ 10 ä¸ªæ ¸å¿ƒï¼Œé‚£æˆ‘ä»¬è·‘ä¸€ä¸ªæ›´é«˜çš„ï¼Œå°†<code>--cpu-number</code>åŠ åˆ° 60 çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</p><!-- ![stress-cpu](../images/stress-cpu.png) --><div class="tag-plugin image"><div class="image-bg"><img src="/images/stress-cpu.png" alt="stress-cpu" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">stress-cpu</span></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¬¡%CPUæ‰“åˆ°äº† 6000ï¼Œé‚£å¾ˆå¤šäººå°±å¥½å¥‡æˆ‘æ—¥å¸¸çš„ç¨‹åºè·‘åˆ°å¤šé«˜ç®—é«˜å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼Œç°åœ¨çš„æœåŠ¡å™¨ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤šæ ¸å¿ƒ CPUï¼ˆ1C2Gè¿™ç§è‡ªå·±ç”¨æ¥ç©çš„å¿½ç•¥ï¼‰ï¼ŒCPU çš„æ ¸å¿ƒæ•°å†³å®šäº†æˆ‘ä»¬ç¨‹åºåœ¨åŒä¸€æ—¶é—´èƒ½å¤Ÿæ‰§è¡Œå¤šå°‘ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé«˜ä¸é«˜æ˜¯ç›¸å¯¹äºæœºå™¨é…ç½®è€Œè¨€çš„ã€‚å¦‚æœä½ çš„æœºå™¨åªæœ‰ 16Cï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 1000ï¼Œé‚£ä¹ˆå…¶å®å·²ç»ç®—æ˜¯æ¯”è¾ƒé«˜äº†ã€‚å¦‚æœæ˜¯ 256C çš„CPUï¼ˆåœŸè±ªçº§é…ç½®ï¼‰ï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 6000ï¼Œå¯¹äºç³»ç»Ÿçš„ç¨³å®šæ€§å½±å“å°±æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚</p><p>ä¸Šè¿°æˆ‘ä»¬è¯´çš„æƒ…å†µæ˜¯è¿›ç¨‹å ç”¨ CPU å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œé‚£ä¹ˆè¿›ç¨‹å ç”¨çš„ CPU å¯¹ç³»ç»Ÿçš„å½±å“ä¸å¤§å°±ä»£è¡¨è¿™ä¸ªç¨‹åºä¸€å®šæ²¡æœ‰é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯æœªå¿…çš„ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯è¦å›å½’åˆ°ä¸šåŠ¡æœ¬èº«ï¼Œå¦‚æœè¿›ç¨‹çš„ CPU å ç”¨åœ¨ä¸šåŠ¡å˜åŠ¨ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿäº†å¼‚å¸¸æ³¢åŠ¨ï¼Œæˆ–è€…æ­£å¸¸æƒ…å†µä¸‹ä¸šåŠ¡ä¸ä¼šæ¶ˆè€—è¿™ä¹ˆé«˜çš„ CPUï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»§ç»­æ’æŸ¥äº†ã€‚</p><h3 id="å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº"><a href="#å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº" class="headerlink" title="å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº"></a>å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº</h3><p>è¿™ä¸ªé—®é¢˜çš„ æ ¸å¿ƒæ˜¯ CPU ä¸Šåœ¨è¿è¡Œä»€ä¹ˆä¸œè¥¿ã€‚ å¤šæ ¸å¿ƒCPU ä¸‹ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½å¯ä»¥æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šä¸€ä¸ªè¿›ç¨‹ä¸­é‚£äº›æ–¹æ³•åœ¨æ¶ˆè€— CPU å‘¢ï¼Ÿä»è€Œå¼•ç”³ä¸‹é¢è¯¦ç»†çš„é—®é¢˜:</p><ol><li>ç¨‹åºçš„è°ƒç”¨æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li><li>è°ƒç”¨æ ˆä¿¡æ¯ä¸­å“ªäº›æ˜¯éœ€è¦å…³æ³¨çš„ï¼Œé‚£äº›æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Ÿ</li><li>çƒ­ç‚¹å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><p>è€è¯è¯´å¾—å¥½ï¼Œâ€å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨â€, æˆ‘ä»¬éœ€è¦è¿™äº›ä¸œè¥¿ï¼Œå°±å¿…é¡»äº†è§£åˆ°ä»€ä¹ˆæ ·çš„å·¥å…·å¯ä»¥æ‹¿åˆ°ä¸Šé¢æˆ‘æåˆ°çš„ä¸€äº›ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘å°†é€šè¿‡å¸¸ç”¨çš„åç«¯è¯­è¨€ï¼š<code>golang</code> å’Œ <code>java</code> ä¸ºä¾‹æ„é€ ä¸€äº›é«˜ CPU çš„ç¨‹åºæ¥è¿›è¡Œå±•ç¤ºã€‚</p><h4 id="perfå‘½ä»¤"><a href="#perfå‘½ä»¤" class="headerlink" title="perfå‘½ä»¤"></a>perfå‘½ä»¤</h4><p><strong>perfæ˜¯ä¸€æ¬¾Linuxæ€§èƒ½åˆ†æå·¥å…·ã€‚Linuxæ€§èƒ½è®¡æ•°å™¨æ˜¯ä¸€ä¸ªæ–°çš„åŸºäºå†…æ ¸çš„å­ç³»ç»Ÿï¼Œå®ƒæä¾›ä¸€ä¸ªæ€§èƒ½åˆ†ææ¡†æ¶ï¼Œæ¯”å¦‚ç¡¬ä»¶ï¼ˆCPUã€PMU(Performance Monitoring Unit)ï¼‰åŠŸèƒ½å’Œè½¯ä»¶(è½¯ä»¶è®¡æ•°å™¨ã€tracepoint)åŠŸèƒ½ã€‚</strong></p><p>å®‰è£…:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install perf   #Centos</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆçœ‹ä¸‹ <code>perf</code>çš„ç”¨æ³•ï¼Œè¿™é‡Œä¸å±•å¼€å…·ä½“ç”¨æ³•ï¼Œåªåˆ—å‡ºæˆ‘å¹³å¸¸ä½¿ç”¨çš„å‡ ä¸ªå‘½ä»¤:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top        System profiling tool.               #å¯¹ç³»ç»Ÿæ€§èƒ½è¿›è¡Œå®æ—¶åˆ†æã€‚</span><br><span class="line">record     Run a command and record its profile into perf.data     #æ”¶é›†é‡‡æ ·ä¿¡æ¯</span><br><span class="line">report     Read perf.data (created by perf record) and display the profile  #åˆ†æé‡‡æ ·ä¿¡æ¯ï¼Œå’Œrecordé…åˆä½¿ç”¨</span><br></pre></td></tr></table></figure><p>record å’Œ report çš„ä½¿ç”¨æ›´å¤šåœ¨äº dump å½“å‰ç¯å¢ƒçš„ä¿¡æ¯ç”¨äºåç»­åˆ†æï¼Œå¦‚æœåœ¨è‡ªå·±ç¯å¢ƒä¸Šæµ‹è¯•ï¼Œå¯ä»¥ç”¨ top è¿›è¡Œä¸€äº›ç®€å•çš„å®æ—¶åˆ†æï¼ˆç±»ä¼¼äº top å‘½ä»¤ï¼‰ã€‚</p><p>è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‹æµ‹å·¥å…·ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ª 10 æ ¸å¿ƒçš„ 10min çš„å‹æµ‹åœºæ™¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./sysstress cpu --cpu-number 10 --duration 10m &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼Œè®©å‹æµ‹ç¨‹åºåœ¨åå°æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬é€šè¿‡<code>perf top</code>æŸ¥çœ‹å…·ä½“çš„æƒ…å†µï¼ˆå¯ä»¥é€šè¿‡-p æŒ‡å®š pidï¼‰</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/perftop.png" alt="perf top," data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">perf top,</span></div></div><!-- ![perf top](../images/perftop.png) --><p>ä»æˆªå›¾çš„ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å ç”¨èµ„æºæœ€å¤šçš„ä¸€äº›æ–¹æ³•ï¼ŒåŒ…æ‹¬ sysstress è¿›ç¨‹çš„å„ç§æ–¹æ³•(ä»å›¾ç‰‡ä¸­åŸºæœ¬ä¸Šå°±å¯ä»¥ç¡®å®šé«˜æ¶ˆè€—çš„æ–¹æ³•åœ¨å“ªé‡Œ)ä»¥åŠåº•å±‚çš„ <code>__vdso_clock_gettime</code>, é‚£å†ç»“åˆå‹æµ‹å·¥å…·çš„ä»£ç åˆ†æä¸‹:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">burnCpu</span><span class="params">(wg *sync.WaitGroup, start time.Time, durSec <span class="type">int64</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">_ = <span class="number">1</span> * <span class="number">1</span></span><br><span class="line">now := time.Now()</span><br><span class="line"><span class="keyword">if</span> now.Sub(start) &gt; time.Duration(durSec)*time.Second &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æ–¹æ³•çš„æ ¸å¿ƒï¼Œå…¶å®å°±æ˜¯åšæ— æ„ä¹‰çš„è®¡ç®—ï¼Œå¤–åŠ æ—¶é—´çš„åˆ¤æ–­ï¼Œè¶…è¿‡ duration å°±ç»“æŸã€‚è¿™æ ·å’Œä¸Šé¢çš„ perf top ä¿¡æ¯å°±èƒ½å¯¹åº”èµ·æ¥ã€‚</p><p>ç„¶åæˆ‘ä»¬ç”¨ java å†™ä¸€ä¸ªåŒæ ·çš„ç¨‹åºï¼Œå†çœ‹çœ‹ <code>perf top</code>çš„æƒ…å†µ:</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/javaperftop.png" alt="perf top," data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">perf top,</span></div></div><!-- ![perf top](../images/javaperftop.png) --><p>ä»è¿™ä¸€å¤§æ®µæ˜¾ç¤ºæ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯çœ‹çš„ä¸€è„¸æ‡µé€¼ï¼Œå¾ˆéš¾å‘ç°åˆ°åº•æ˜¯ä»€ä¹ˆç¨‹åºåœ¨å ç”¨CPU èµ„æºã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æºç¨‹åº:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        Math.sin(Math.random());</span><br><span class="line">                        <span class="type">LocalDateTime</span> <span class="variable">currentTime</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç¨‹åºä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼Œåšä¸€ä¸ªæ— æ„ä¹‰çš„æ•°å­¦è¿ç®—ï¼Œç„¶åè·å–å½“å‰æ—¶é—´ã€‚ä»è¿™æ®µä»£ç ä¸­æ˜¯ä¸æ˜¯å¾ˆéš¾å’Œä¸Šé¢<code>perf top</code>çš„æ˜¾ç¤ºå…³è”èµ·æ¥ï¼Ÿ åŸå› ä¹Ÿéå¸¸ç®€å•ï¼Œ åƒJava è¿™ç§é€šè¿‡ JVM æ¥è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå †æ ˆç”¨çš„éƒ½æ˜¯ JVM å†…ç½®çš„å‡½æ•°å’Œå †æ ˆç®¡ç†ã€‚æ‰€ä»¥ï¼Œä»ç³»ç»Ÿå±‚é¢åªèƒ½çœ‹åˆ° JVM çš„å‡½æ•°å †æ ˆï¼Œè€Œä¸èƒ½ç›´æ¥å¾—åˆ° Java åº”ç”¨ç¨‹åºçš„å †æ ˆã€‚é‚£æˆ‘ä»¬å¥½èƒ½é€šè¿‡ perf å»çœ‹åˆ° java ç›¸å…³çš„å †æ ˆå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚</p><p>å¯ä»¥å€ŸåŠ© <a href="https://github.com/jvm-profiling-tools/perf-map-agent">perf-map-agent</a> è¿™æ ·çš„å¼€æºå·¥å…·ï¼Œå»ç”Ÿæˆå’Œ<code>perf</code> å·¥å…·ä¸€èµ·ä½¿ç”¨çš„æ–¹æ³•æ˜ å°„ï¼Œä½†æ˜¯éœ€è¦åšé¢å¤–çš„ä¸€äº›é…ç½®ã€‚è¿™é‡Œçš„æ–¹æ³•å¤§å®¶å¯ä»¥è‡ªå·±æ¢ç©¶ï¼Œä¸ºä»€ä¹ˆä¸è¯¦ç»†çš„è®²è¿™ä¸ªå‘¢ï¼ŒåŸå› ä¹Ÿç®€å•ï¼Œæ’æŸ¥é—®é¢˜çš„å·¥å…·å¤šç§å¤šæ ·ï¼Œæ²¡å¿…è¦åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»ã€‚</p><h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>æ—¢ç„¶ perf top å»æŸ¥çœ‹ JAVA çš„è°ƒç”¨æ ˆä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸Š java æä¾›çš„ jstack å·¥å…·å»åˆ†æã€‚</p><ul><li>jstack -l pid &gt; xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼</li><li>kill -3ï¼Œ jstack ç”¨ä¸äº†çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ kill -3 pid çš„å½¢å¼ï¼Œå †æ ˆä¼šè¾“å‡ºåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ã€‚</li></ul><p>å…·ä½“çš„æ“ä½œæ­¥éª¤:</p><ol><li><code>top -Hp $pid</code> æ‰¾åˆ°å ç”¨ CPU çš„å…·ä½“çº¿ç¨‹</li><li><code>jstack -l $pid &gt; /tmp/$pid.jstack</code> æˆ–è€… <code>kill -3 $pid</code>å°† java è¿›ç¨‹çš„å †æ ˆæƒ…å†µè¾“å‡ºçš„æ—¥å¿—ä¸­ï¼Œç„¶åæ ¹æ® <code>top -Hp</code> çœ‹åˆ°çš„çº¿ç¨‹ä¿¡æ¯åœ¨è¾“å‡ºçš„å †æ ˆæ—¥å¿—ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ˆ<code>top -Hp</code> è¾“å‡ºçš„æ˜¯ 10 è¿›åˆ¶çš„ idï¼Œ<code>jstack</code> è¾“å‡ºçš„æ˜¯ 16 è¿›åˆ¶çš„ï¼Œåœ¨æŸ¥æ‰¾æ—¶æ³¨æ„è¿›åˆ¶è½¬æ¢ï¼‰</li></ol><p>æˆ‘ä»¬çœ‹ä¸‹ä¸Šé¢ java ç¨‹åºçš„å †æ ˆçš„ä¿¡æ¯:</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2024</span><span class="number">-08</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">15</span>:<span class="number">40</span></span><br><span class="line">Full thread <span class="built_in">dump</span> Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (<span class="number">25.221</span>-b11 mixed mode):</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Attach Listener&quot;</span> #<span class="number">35</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f52b4001000</span> nid=<span class="number">0x71f4</span> waiting on condition [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;DestroyJavaVM&quot;</span> #<span class="number">34</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e0009800</span> nid=<span class="number">0x1693</span> waiting on condition [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span> #<span class="number">25</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e015a800</span> nid=<span class="number">0x16d9</span> runnable [<span class="number">0x00007f52f64e3000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">at sun.misc.Unsafe.getObjectVolatile(Native Method)</span><br><span class="line">at java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:<span class="number">755</span>)</span><br><span class="line">at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:<span class="number">938</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:<span class="number">267</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:<span class="number">227</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneRegion.ofId(ZoneRegion.java:<span class="number">120</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.of(ZoneId.java:<span class="number">411</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.of(ZoneId.java:<span class="number">359</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.of(ZoneId.java:<span class="number">315</span>)</span><br><span class="line">at java.util.TimeZone.toZoneId(TimeZone.java:<span class="number">556</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.systemDefault(ZoneId.java:<span class="number">274</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.Clock.systemDefaultZone(Clock.java:<span class="number">178</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.LocalDateTime.now(LocalDateTime.java:<span class="number">180</span>)</span><br><span class="line">at Main$<span class="number">1.</span>run(Main.java:<span class="number">12</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span> #<span class="number">24</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e0159000</span> nid=<span class="number">0x16d8</span> runnable [<span class="number">0x00007f52f65e4000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">at sun.misc.Unsafe.getObjectVolatile(Native Method)</span><br><span class="line">at java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:<span class="number">755</span>)</span><br><span class="line">at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:<span class="number">938</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:<span class="number">267</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:<span class="number">227</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneRegion.ofId(ZoneRegion.java:<span class="number">120</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.of(ZoneId.java:<span class="number">411</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.of(ZoneId.java:<span class="number">359</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.of(ZoneId.java:<span class="number">315</span>)</span><br><span class="line">at java.util.TimeZone.toZoneId(TimeZone.java:<span class="number">556</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.ZoneId.systemDefault(ZoneId.java:<span class="number">274</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.Clock.systemDefaultZone(Clock.java:<span class="number">178</span>)</span><br><span class="line">at java.<span class="built_in">time</span>.LocalDateTime.now(LocalDateTime.java:<span class="number">180</span>)</span><br><span class="line">at Main$<span class="number">1.</span>run(Main.java:<span class="number">12</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"> <span class="comment">--- 10 ä¸ª thread</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Service Thread&quot;</span> #<span class="number">23</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e0143800</span> nid=<span class="number">0x16d6</span> runnable [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread1&quot;</span> #<span class="number">6</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e010e000</span> nid=<span class="number">0x16c5</span> waiting on condition [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"> <span class="comment">--- ä¸€å¤§å † C2 CompilerThread</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread0&quot;</span> #<span class="number">5</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e010b000</span> nid=<span class="number">0x16c4</span> waiting on condition [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Signal Dispatcher&quot;</span> #<span class="number">4</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e0109800</span> nid=<span class="number">0x16c3</span> runnable [<span class="number">0x0000000000000000</span>]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Finalizer&quot;</span> #<span class="number">3</span> daemon prio=<span class="number">8</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e00d8800</span> nid=<span class="number">0x16c2</span> <span class="keyword">in</span> Object.wait() [<span class="number">0x00007f52f7bfa000</span>]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">at java.lang.Object.wait(Native Method)</span><br><span class="line">- waiting on &lt;<span class="number">0x000000008021a5e8</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">at java.lang.ref.ReferenceQueue.<span class="built_in">remove</span>(ReferenceQueue.java:<span class="number">144</span>)</span><br><span class="line">- locked &lt;<span class="number">0x000000008021a5e8</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">at java.lang.ref.ReferenceQueue.<span class="built_in">remove</span>(ReferenceQueue.java:<span class="number">165</span>)</span><br><span class="line">at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:<span class="number">216</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Reference Handler&quot;</span> #<span class="number">2</span> daemon prio=<span class="number">10</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e00d3800</span> nid=<span class="number">0x16c1</span> <span class="keyword">in</span> Object.wait() [<span class="number">0x00007f52f7cfb000</span>]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">at java.lang.Object.wait(Native Method)</span><br><span class="line">- waiting on &lt;<span class="number">0x0000000080218d38</span>&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">at java.lang.Object.wait(Object.java:<span class="number">502</span>)</span><br><span class="line">at java.lang.ref.Reference.tryHandlePending(Reference.java:<span class="number">191</span>)</span><br><span class="line">- locked &lt;<span class="number">0x0000000080218d38</span>&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:<span class="number">153</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;VM Thread&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e00ca000</span> nid=<span class="number">0x16c0</span> runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#0 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e001f000</span> nid=<span class="number">0x1694</span> runnable</span><br><span class="line"></span><br><span class="line"><span class="comment">--- ä¸€å¤§å † GC task thread</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;VM Periodic Task Thread&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f53e0146000</span> nid=<span class="number">0x16d7</span> waiting on condition</span><br><span class="line"></span><br><span class="line">JNI global references: <span class="number">202</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ top -Hp çš„ä¿¡æ¯å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ° Thread-[0-9] è¿™å‡ ä¸ªçº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆéƒ½æ˜¯ <code>java.time.LocalDateTime.now</code>, ä¹Ÿè¯´æ˜äº†è¿™ä¸ªæ–¹æ³•åœ¨ä¸åœæ¶ˆè€— CPUã€‚ï¼ˆä½†æ˜¯ jstack åªèƒ½æ•è·çŸ­æ—¶é—´æˆ–è€…ç¬æ—¶çš„å †æ ˆä¿¡æ¯ï¼Œæ²¡æ³•å¤„ç†é•¿æ—¶é—´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–æ—¶å¯ä»¥å¤šæ‰“å°å‡ æ¬¡æˆ–è€…ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰</p><p>è‡³äº jstack çš„è¯¦ç»†ç”¨æ³•ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšå®¢ï¼š<a href="https://baixiaozhou.github.io/2024/08/13/JAVA%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/">javaé—®é¢˜å®šä½</a></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰éå¸¸å¤šçš„åˆ†æå·¥å…·ï¼Œpstack\gstack\strace\gdbç­‰ç­‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæ¢ç´¢ä½¿ç”¨</p><h4 id="ç«ç„°å›¾"><a href="#ç«ç„°å›¾" class="headerlink" title="ç«ç„°å›¾"></a>ç«ç„°å›¾</h4><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ“ä½œçš„å‘½ä»¤å’Œæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒç›´è§‚çš„æ–¹å¼èƒ½å¤Ÿç›´æ¥çœ‹åˆ°å„ç§æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶æ¯”é‡ç­‰æƒ…å†µå‘¢ï¼Ÿç«ç„°å›¾å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µè€Œç”Ÿçš„ã€‚</p><p>ç«ç„°å›¾çš„åˆ†ç±»æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„åŒ…æ‹¬:</p><ol><li>CPU ç«ç„°å›¾ (CPU Flame Graph)<ul><li>   æè¿°ï¼šå±•ç¤º CPU åœ¨ä¸åŒæ–¹æ³•ä¸Šçš„æ¶ˆè€—æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨æ‰€å ç”¨çš„ CPU æ—¶é—´ã€‚</li><li>   ç”¨é€”ï¼šç”¨äºåˆ†æ CPU æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å“ªäº›æ–¹æ³•æ¶ˆè€—äº†æœ€å¤šçš„ CPU èµ„æºã€‚</li><li>   åº”ç”¨ï¼šJavaã€C++ ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€çš„æ€§èƒ½åˆ†æã€‚</li></ul></li><li>å†…å­˜ç«ç„°å›¾ (Memory Flame Graph)<ul><li>æè¿°ï¼šå±•ç¤ºå†…å­˜åˆ†é…æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨åˆ†é…çš„å†…å­˜é‡ã€‚</li><li>ç”¨é€”ï¼šç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼ã€è¿‡åº¦å†…å­˜åˆ†é…é—®é¢˜ï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚</li><li>åº”ç”¨ï¼šå¸¸ç”¨äºåˆ†æå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¦‚ Java åº”ç”¨çš„å †å†…å­˜åˆ†æã€‚</li></ul></li><li>I&#x2F;O ç«ç„°å›¾ (I&#x2F;O Flame Graph)<ul><li>   æè¿°ï¼šå±•ç¤º I&#x2F;O æ“ä½œçš„è€—æ—¶æƒ…å†µï¼Œæ˜¾ç¤ºä¸åŒæ–¹æ³•çš„ I&#x2F;O æ“ä½œå ç”¨çš„æ—¶é—´ã€‚</li><li>   ç”¨é€”ï¼šç”¨äºåˆ†æåº”ç”¨ç¨‹åºçš„ I&#x2F;O æ€§èƒ½ï¼Œè¯†åˆ«æ…¢é€Ÿæˆ–é¢‘ç¹çš„ I&#x2F;O æ“ä½œã€‚</li><li>   åº”ç”¨ï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯çš„æ€§èƒ½è°ƒä¼˜ã€‚</li></ul></li></ol><p>æˆ‘ä»¬è¿™é‡Œé€šè¿‡ <a href="https://github.com/async-profiler/async-profiler">async-profiler</a> å¯¹æ–‡ç« ä¸Šé¢çš„javaå‹æµ‹ç¨‹åºè¿›è¡ŒæŠ“å–(è¿™ä¸ªå·¥å…·åªèƒ½æŠ“ java çš„)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf async-profiler-3.0-linux-x64.tar.gz</span><br><span class="line">cd async-profiler-3.0-linux-x64/bin</span><br><span class="line">./asprof -d 60 pid -f /tmp/javastress.html</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ html æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç«ç„°å›¾ä¿¡æ¯ï¼ˆå¯ä»¥åœ¨ç½‘é¡µè¿›è¡Œç‚¹å‡»ï¼ŒæŸ¥çœ‹æ›´ç»†èŠ‚çš„æ–¹æ³•ï¼‰</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/javafire.png" alt="java ç¨‹åºçš„ç«ç„°å›¾," data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">java ç¨‹åºçš„ç«ç„°å›¾,</span></div></div><!-- ![java ç¨‹åºçš„ç«ç„°å›¾](../images/javafire.png) --><p>è¿™æ ·çœ‹èµ·æ¥å°±æ¯” jstackè¿™äº›ä¿¡æ¯æ›´åŠ ç›´è§‚ä¸€ç‚¹ã€‚</p><h2 id="è´Ÿè½½é£™å‡"><a href="#è´Ÿè½½é£™å‡" class="headerlink" title="è´Ÿè½½é£™å‡"></a>è´Ÿè½½é£™å‡</h2><h3 id="è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½"><a href="#è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½" class="headerlink" title="è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½"></a>è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹ç³»ç»Ÿè´Ÿè½½çš„å®˜æ–¹æè¿°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System load averages is the average number of processes that are either in a runnable or uninterruptable state. A process in arunnable state is either using the CPU or waiting to use the CPU.  A process in uninterruptable state is waiting for some I/O access,eg waiting for disk.  The averages are taken over the three time intervals.  Load averages are not normalized for the number of CPUs ina  system,  so a load average of 1 means a single CPU system is loaded all the time while on a 4 CPU system it means it was idle 75% of the time.</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼è¡¨ç¤ºå¤„äºå¯è¿è¡Œæˆ–ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹çš„å¹³å‡æ•°é‡ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹è¦ä¹ˆæ­£åœ¨ä½¿ç”¨ CPUï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…ä½¿ç”¨ CPUã€‚å¤„äºä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸäº› I&#x2F;O è®¿é—®ï¼Œä¾‹å¦‚ç­‰å¾…ç£ç›˜ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯ loadavg è¿™ä¸ªæ•°å€¼ä½“ç°äº†æŸäº›ç‰¹å®šçŠ¶æ€è¿›ç¨‹çš„æ•°é‡ã€‚</p><p>é‚£å¼•ç”³å‡ºä¸¤ä¸ªé—®é¢˜:</p><ol><li>è¿›ç¨‹çš„çŠ¶æ€æœ‰å“ªäº›ï¼Ÿ å¦‚ä½•åœ¨ Linux ä¸ŠæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€</li><li>å¯è¿è¡Œå’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆ</li></ol><p>æŸ¥çœ‹çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ps å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¯”å¦‚é€šè¿‡<code>ps -auxf</code>, æˆ‘ä¹ˆå¯ä»¥çœ‹åˆ°æœ‰ä¸€åˆ—ä¸º <code>STAT</code>,è¿™åˆ—å°±ä»£è¡¨è¯¥è¿›ç¨‹çš„çŠ¶æ€:</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/psauxf.png" alt="è¿›ç¨‹çŠ¶æ€" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">è¿›ç¨‹çŠ¶æ€</span></div></div><p>è¿›ç¨‹çš„çŠ¶æ€å’Œå…·ä½“å«ä¹‰:</p><ul><li>D    uninterruptible sleep (usually IO)</li><li>R    running or runnable (on run queue)</li><li>S    interruptible sleep (waiting for an event to complete)</li><li>T    stopped by job control signal</li><li>t    stopped by debugger during the tracing</li><li>W    paging (not valid since the 2.6.xx kernel)</li><li>X    dead (should never be seen) </li><li>Z    defunct (â€œzombieâ€) process, terminated but not reaped by its parent</li></ul><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å¤„äºä¸å¯ä¸­æ–­çš„çŠ¶æ€çš„è¿›ç¨‹å’Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åˆ†åˆ«ä¸º <code>D</code> å’Œ <code>R</code>,æ¢ä¸ªè¯´æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´é€ æˆè´Ÿè½½å‡é«˜çš„åŸå› ä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªçŠ¶æ€çš„è¿›ç¨‹å¼•èµ·çš„ã€‚</p><p>ï¼ˆæ’ä¸ªé¢˜å¤–è¯ï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼ŒX çŠ¶æ€çš„è¿›ç¨‹åº”è¯¥æ˜¯ä¸åº”è¯¥è¢«çœ‹åˆ°çš„ï¼Œ ä½†æ˜¯ä¹‹å‰åœ¨è…¾è®¯äº‘åšESçš„æ—¶å€™ï¼Œå¶ç„¶é—´ç¢°åˆ°äº†ä¸€æ¬¡ï¼Œå½“æ—¶è¿˜æˆªäº†ä¸ªå›¾ç”¨åšç•™å¿µğŸ˜‚ï¼Œä½†æ˜¯æ²¡æœ‰æ•è·åˆ°å…·ä½“çš„ä¿¡æ¯ï¼‰</p><p>è´Ÿè½½çš„æŒ‡æ ‡å¯ä»¥é€šè¿‡ <code>top</code> ä»¥åŠ <code>uptime</code> æŒ‡ä»¤è·å–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">23:35:00 up 1 day, 46 min,  1 user,  load average: 49.16, 18.35, 7.87</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå±•ç¤ºäº† loadavg çš„ä¸‰ä¸ªæ•°å€¼: åˆ†åˆ«ä»£è¡¨çš„å«ä¹‰æ˜¯ 1minã€5minã€15min çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½</p><p>é‚£æˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿçš„è´Ÿè½½æ˜¯é«˜æ˜¯ä½å‘¢ï¼Ÿ</p><p>è¿™é‡Œä¸€èˆ¬æœ‰ä¸ªç»éªŒå€¼ï¼Œæˆ‘ä»¬ä¸€èˆ¬å’Œ CPU å’Œæ ¸å¿ƒæ•°è¿›è¡Œå¯¹æ¯”ï¼Œä¸€èˆ¬è´Ÿè½½åœ¨ CPU æ ¸å¿ƒçš„ 70% å·¦å³ä»¥åŠä»¥ä¸‹ï¼Œå¯¹ç³»ç»Ÿä¸€èˆ¬æ²¡ä»€ä¹ˆå½±å“ï¼Œè¶…è¿‡ 70%ï¼Œç³»ç»Ÿå¯èƒ½æ”¶åˆ°å½±å“ã€‚ä½†æ˜¯è¿™é‡Œè¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œè´Ÿè½½çš„æ¯”ä¾‹åœ¨ 70% ä»¥ä¸‹æ—¶ä¸ä¸€å®šä»£è¡¨ç³»ç»Ÿå°±æ²¡é—®é¢˜ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿä¸ŠåŸºæœ¬ä¸Šæ²¡æœ‰ä¸šåŠ¡åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè´Ÿè½½åŸºæœ¬ä¸Šå°±åœ¨é›¶ç‚¹å‡ å·¦å³ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œè´Ÿè½½æœ‰å‡é«˜ä¸ä¸€å®šæ˜¯åˆç†çš„ï¼ˆåé¢ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼‰</p><h3 id="å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜"><a href="#å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜" class="headerlink" title="å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜"></a>å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜</h3><h4 id="çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“"><a href="#çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“" class="headerlink" title="çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“"></a>çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“</h4><p>æ—¢ç„¶è¯´æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¼šå¼•èµ·è´Ÿè½½çš„å˜åŒ–ï¼Œé‚£ä¹ˆè·‘ä¸€äº›ç¨‹åºï¼Œè®©ç¨‹åºä¸åœè¿è¡Œï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶å°±èƒ½æ„é€ å‡ºæŒç»­è¿è¡Œçš„è¿›ç¨‹äº†ã€‚<br>æˆ‘è¿™é‡Œæ‰¾äº†ä¸‰å°æœºå™¨(64C)ï¼Œç”¨æˆ‘çš„å‹æµ‹å·¥å…·å…ˆè·‘ä¸€äº›çº¯ CPU çš„è¿ç®—ï¼Œç„¶åè§‚å¯Ÿä¸‹æ•ˆæœï¼š</p><p>æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹:</p><ol><li>10 å¹¶å‘ 30min<ul><li><code>nohup ./sysstress cpu --cpu-number 10 --duration 30m &gt; /dev/null 2&gt;&amp;1</code></li></ul></li><li>30 å¹¶å‘ 30min<ul><li><code>nohup ./sysstress cpu --cpu-number 30 --duration 30m &gt; /dev/null 2&gt;&amp;1</code></li></ul></li><li>60 å¹¶å‘ 30min<ul><li><code>nohup ./sysstress cpu --cpu-number 60 --duration 30m &gt; /dev/null 2&gt;&amp;1</code></li></ul></li></ol><p>æ•ˆæœå¦‚ä¸‹:</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/load10.png" alt="10å¹¶å‘è´Ÿè½½," data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">10å¹¶å‘è´Ÿè½½,</span></div></div><div class="tag-plugin image"><div class="image-bg"><img src="/images/load30.png" alt="30å¹¶å‘è´Ÿè½½," data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">30å¹¶å‘è´Ÿè½½,</span></div></div><div class="tag-plugin image"><div class="image-bg"><img src="/images/load60.png" alt="60å¹¶å‘è´Ÿè½½," data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">60å¹¶å‘è´Ÿè½½,</span></div></div><!-- ![10å¹¶å‘è´Ÿè½½](../images/load10.png)![30å¹¶å‘è´Ÿè½½](../images/load30.png)![60å¹¶å‘è´Ÿè½½](../images/load60.png) --><p>ä»ä¸Šè¿°æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨çº¯è¿ç®—è¿™ç§åœºæ™¯ä¸‹ï¼Œå¹¶å‘çš„é‡åŸºæœ¬ä¸Šå’Œè´Ÿè½½æ˜¯å¯¹åº”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´éšç€ CPUçš„ä½¿ç”¨é‡ ä¸Šæ¶¨ï¼Œè´Ÿè½½ä¹Ÿä¼šä¸æ–­å˜é«˜ã€‚</p><h4 id="ç£ç›˜-IO-å¯¹è´Ÿè½½çš„å½±å“"><a href="#ç£ç›˜-IO-å¯¹è´Ÿè½½çš„å½±å“" class="headerlink" title="ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“"></a>ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“</h4><p>åœ¨åˆšæ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†çº¯è¿ç®—å¯¹è´Ÿè½½çš„å½±å“ï¼ˆR è¿›ç¨‹çš„ä»£è¡¨ï¼‰ï¼Œç„¶ååœ¨å…³äº D è¿›ç¨‹çš„è¯´æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„è¯´æ˜ <code>(usually IO)</code> ,å³é€šå¸¸æ˜¯ IO å¼•èµ·çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ç£ç›˜ IO æ¥æµ‹è¯•ä¸€ä¸‹</p><p>æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹:</p><ol><li>10 å¹¶å‘ 15min<ul><li><code>nohup ./sysstress io --operation read --filepath test.access.log -p 10 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp;</code></li></ul></li><li>30 å¹¶å‘ 15min<ul><li><code>nohup ./sysstress io --operation read --filepath test.access.log -p 30 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp;</code></li></ul></li><li>60 å¹¶å‘ 15min<ul><li><code>nohup ./sysstress io --operation read --filepath test.access.log -p 60 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp;</code></li></ul></li></ol><p>æ•ˆæœå¦‚ä¸‹:</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/ioload10.png" alt="10å¹¶å‘è´Ÿè½½" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">10å¹¶å‘è´Ÿè½½</span></div></div><div class="tag-plugin image"><div class="image-bg"><img src="/images/ioload30.png" alt="30å¹¶å‘è´Ÿè½½" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">30å¹¶å‘è´Ÿè½½</span></div></div><div class="tag-plugin image"><div class="image-bg"><img src="/images/ioload60.png" alt="60å¹¶å‘è´Ÿè½½" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">60å¹¶å‘è´Ÿè½½</span></div></div><p>æˆ‘ä»¬ä¹Ÿé¡ºä¾¿çœ‹ä¸€ä¸‹ï¼Œ60 å¹¶å‘ä¸‹ CPU çš„æƒ…å†µ:</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/io60c.png" alt="60å¹¶å‘ç³»ç»Ÿæ•´ä½“æƒ…å†µ" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">60å¹¶å‘ç³»ç»Ÿæ•´ä½“æƒ…å†µ</span></div></div><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç³»ç»Ÿçš„ CPU åŸºæœ¬ä¸Šå·²ç»è·‘æ»¡äº†ã€‚us å’Œ sy éƒ½å çš„æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ç§è¯»å–éå¸¸æœ‰å¯èƒ½èµ°åˆ°ç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬æƒ³æµ‹ç»•è¿‡ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡ DIRECT çš„æ–¹å¼ã€‚</p><p>ä½†æ˜¯ä¸Šé¢çš„ä¾‹å­å…¶å®ä¹Ÿè¯æ˜äº†ä¸€ä»¶äº‹ï¼ŒIO çš„æ“ä½œä¹Ÿæ˜¯ä¼šå¯¼è‡´è´Ÿè½½äº§ç”Ÿé£™å‡ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç£ç›˜IO å’Œ CPU æ“ä½œéƒ½ä¼šå¯¼è‡´ç³»ç»Ÿè´Ÿè½½é£™å‡ï¼Œé‚£ä¹ˆè´Ÿè½½é£™å‡ä¸€å®šä¼šæ˜¯è¿™ä¸¤ä¸ªåŸå› å—ï¼Ÿç­”æ¡ˆä¹Ÿæ˜¯æœªå¿…çš„ï¼Œå› ä¸ºä¸Šè¿°æˆ‘ä»¬æ›¾ç»æåˆ°è¿‡ D çŠ¶æ€çš„è¿›ç¨‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¥½åƒè¿˜æ²¡ä»‹ç»è¿‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç»§ç»­æ¨¡æ‹Ÿï¼Œæ—¢ç„¶ D çŠ¶æ€çš„è¿›ç¨‹æ˜¯ IO æ“ä½œå¼•èµ·çš„ï¼Œæ™®é€šçš„ç£ç›˜è¯»å†™ IO å¾ˆéš¾æ¨¡æ‹Ÿï¼Œé‚£æˆ‘ä»¬å°±æ¢ä¸ª IO åœºæ™¯ç»§ç»­æ¨¡æ‹Ÿ â€“ ç½‘ç»œ IOã€‚</p><h4 id="é€šè¿‡ç½‘ç»œ-IO-æ¨¡æ‹Ÿ-D-çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“"><a href="#é€šè¿‡ç½‘ç»œ-IO-æ¨¡æ‹Ÿ-D-çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“" class="headerlink" title="é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“"></a>é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“</h4><p>è¿™é‡Œç›´æ¥ä¸Šä¸€ä¸ªæ¨¡æ‹Ÿæ–¹æ³•:</p><ul><li>A æœºå™¨å¼€å¯ NFS Server</li><li>B æœºå™¨ä½œä¸ºå®¢æˆ·ç«¯è¿›è¡ŒæŒ‚è½½</li><li>æ–­å¼€ç½‘ç»œ</li><li>ç–¯ç‹‚ df -h</li></ul><p>è¯¦ç»†çš„æ“ä½œæ­¥éª¤:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># å®‰è£… Centos</span><br><span class="line">sudo yum install nfs-utils</span><br><span class="line"></span><br><span class="line"># æœåŠ¡ç«¯é…ç½®</span><br><span class="line">sudo mkdir -p /mnt/nfs_share</span><br><span class="line">sudo chown nobody:nogroup /mnt/nfs_share</span><br><span class="line">sudo chmod 755 /mnt/nfs_share</span><br><span class="line">## æ‰“å¼€ /etc/exports é…ç½®ï¼Œæ·»åŠ ä¸€è¡Œæ¥å®šä¹‰å…±äº«ç›®å½•åŠå…¶æƒé™ã€‚ä¾‹å¦‚ï¼Œå°† /mnt/nfs_share å…±äº«ç»™ç½‘ç»œ 192.168.1.0/24ï¼Œå¹¶æä¾›è¯»å†™æƒé™ï¼š</span><br><span class="line">/mnt/nfs_share 192.168.1.0/24(rw,sync,no_subtree_check)</span><br><span class="line"></span><br><span class="line">## å¯åŠ¨ NFS</span><br><span class="line">sudo exportfs -a</span><br><span class="line">sudo systemctl restart nfs-kernel-server</span><br><span class="line">sudo systemctl enable nfs-kernel-server</span><br><span class="line"></span><br><span class="line"># å®¢æˆ·ç«¯é…ç½®</span><br><span class="line">sudo mkdir -p /mnt/nfs_client</span><br><span class="line">sudo mount -t nfs 192.168.1.100(server ip):/mnt/nfs_share /mnt/nfs_client</span><br><span class="line">## éªŒè¯</span><br><span class="line">df -h /mnt/nfs_client</span><br><span class="line"></span><br><span class="line"># æ–­ç½‘æ¨¡æ‹Ÿ(å®¢æˆ·ç«¯)</span><br><span class="line">iptables -I INPUT -s serverip -j DROP</span><br><span class="line"></span><br><span class="line"># æŒç»­(ç–¯ç‹‚)æ‰§è¡Œï¼š</span><br><span class="line">du -sh /mnt/nfs_client</span><br></pre></td></tr></table></figure><p>å› ä¸ºç½‘ç»œå·²ç»æ–­æ‰ï¼Œæ‰€ä»¥<code>du -sh /mnt/nfs_client</code>,è€Œä¸”è¿™ä¸ªç¨‹åºæ²¡æœ‰è‡ªåŠ¨é€€å‡ºæˆ–è€…æŠ¥é”™ï¼Œè¿™æ ·å°±å¯¼è‡´ç¨‹åºæ— æ³•é¡ºåˆ©æ‰§è¡Œä¸‹å»ï¼Œç»§è€Œé˜»å¡ä½å°±å˜æˆäº† D çŠ¶æ€çš„è¿›ç¨‹ã€‚</p><p>åŸºäºè¿™ç§æ¨¡æ‹Ÿæ–¹æ³•å¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ä¸‹ï¼Œç¬”è€…ä¹‹å‰åšè¿‡ä¸€ä¸ªåœºæ™¯ï¼Œå°†ä¸€ä¸ªä¸¤æ ¸å¿ƒçš„ CPUè´Ÿè½½å¹²åˆ°äº† 200 å¤šï¼Œä½†æ˜¯å› ä¸º<strong>è¿™ç§æƒ…å†µä¸‹æ›´å¤šæ˜¯é˜»å¡åœ¨ç½‘ç»œä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶çš„è´Ÿè½½è™½é«˜ï¼Œå¹¶ä¸ä¸€å®šå½±å“ç³»ç»Ÿè¿è¡Œ</strong>ã€‚</p><p>å½“ç„¶è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼Œç¬”è€…æ›¾ç»ä¹Ÿå› ä¸ºè§è¿‡ ping æ“ä½œé˜»å¡å¯¼è‡´çš„è´Ÿè½½é£™å‡ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯æ˜¯å¤šç§å¤šæ ·çš„ğŸ˜‚ï¼Œå¤§å®¶æœ‰æ›´å¤šçš„ä¾‹å­ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚</p><h3 id="è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥"><a href="#è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥" class="headerlink" title="è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥"></a>è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥</h3><p>åŸºäºä¸Šé¢çš„ä¾‹å­å’Œåœºæ™¯æ¨¡æ‹Ÿï¼Œæˆ‘ä»¬å…¶å®åº”è¯¥å·²ç»æœ‰ä¸€å¥—åŸºæœ¬çš„æ’æŸ¥æ–¹æ³•äº†ï¼Œä¸‹é¢è¿™å¼ å›¾æ˜¯æˆ‘ä¸ªäººçš„ä¸€äº›æ€»ç»“(å›¾è¿˜ä¼šä¸æ–­å®Œå–„)</p><div class="tag-plugin image"><div class="image-bg"><img src="/images/loadhigh.png" alt="è´Ÿè½½é«˜æ’æŸ¥å¯¼å›¾" data-fancybox="true"/></div><div class="image-meta"><span class="image-caption center">è´Ÿè½½é«˜æ’æŸ¥å¯¼å›¾</span></div></div>]]></content>
    
    
    <summary type="html">çº¿ä¸Šæ•…éšœé—®é¢˜çš„æ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€è´Ÿè½½ã€ç£ç›˜ã€IOã€ç½‘ç»œç­‰</summary>
    
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="http://baixiaozhou.github.io/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    
    <category term="Linux" scheme="http://baixiaozhou.github.io/tags/Linux/"/>
    
    <category term="Java" scheme="http://baixiaozhou.github.io/tags/Java/"/>
    
    <category term="Golang" scheme="http://baixiaozhou.github.io/tags/Golang/"/>
    
    <category term="commands" scheme="http://baixiaozhou.github.io/tags/commands/"/>
    
  </entry>
  
  <entry>
    <title>JAVAé—®é¢˜å®šä½</title>
    <link href="http://baixiaozhou.github.io/p/JAVA%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/"/>
    <id>http://baixiaozhou.github.io/p/JAVA%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/</id>
    <published>2024-07-30T07:32:13.000Z</published>
    <updated>2024-08-17T15:11:14.404Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h1 id="ä¸€ã€JAVA-ç›¸å…³å‘½ä»¤"><a href="#ä¸€ã€JAVA-ç›¸å…³å‘½ä»¤" class="headerlink" title="ä¸€ã€JAVA ç›¸å…³å‘½ä»¤"></a>ä¸€ã€JAVA ç›¸å…³å‘½ä»¤</h1><h2 id="1-jps"><a href="#1-jps" class="headerlink" title="1.jps"></a>1.jps</h2><p>jps - Lists the instrumented Java Virtual Machines (JVMs) on the target system. This command is experimental and unsupported.</p><p>ç›¸å…³å‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS</span><br><span class="line">       The jps command supports a number of options that modify the output of the command. These options are subject to change or removal in the future.</span><br><span class="line">       -q</span><br><span class="line">              Suppresses the output of the class name, JAR file name, and arguments passed to the main method, producing only a list of local JVM identifiers.</span><br><span class="line">       -m</span><br><span class="line">              Displays the arguments passed to the main method. The output may be null for embedded JVMs.</span><br><span class="line">       -l</span><br><span class="line">              Displays the full package name for the application&#x27;s main class or the full path name to the application&#x27;s JAR file.</span><br><span class="line">       -v</span><br><span class="line">              Displays the arguments passed to the JVM.</span><br><span class="line">       -V</span><br><span class="line">              Suppresses the output of the class name, JAR file name, and arguments passed to the main method, producing only a list of local JVM identifiers.</span><br><span class="line">       -Joption</span><br><span class="line">              Passes option to the JVM, where option is one of the options described on the reference page for the Java application launcher. For example, -J-Xms48m sets the</span><br><span class="line">              startup memory to 48 MB. See java(1).</span><br></pre></td></tr></table></figure><h2 id="2-jinfo"><a href="#2-jinfo" class="headerlink" title="2.jinfo"></a>2.jinfo</h2><p>jinfoï¼ˆJava Virtual Machine Configuration Informationï¼‰æ˜¯JDKæä¾›çš„ä¸€ä¸ªå¯ä»¥å®æ—¶æŸ¥çœ‹Javaè™šæ‹Ÿæœºå„ç§é…ç½®å‚æ•°å’Œç³»ç»Ÿå±æ€§çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä½¿ç”¨jpså‘½ä»¤çš„-vå‚æ•°å¯ä»¥æŸ¥çœ‹Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶æ˜¾å¼æŒ‡å®šçš„é…ç½®å‚æ•°ï¼Œå¦‚æœæƒ³æŸ¥çœ‹æ²¡æœ‰æ˜¾å¼æŒ‡å®šçš„é…ç½®å‚æ•°å°±å¯ä»¥ä½¿ç”¨jinfoå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ã€‚å¦å¤–ï¼Œjinfoå‘½ä»¤è¿˜å¯ä»¥æŸ¥è¯¢Javaè™šæ‹Ÿæœºè¿›ç¨‹çš„System.getProperties()çš„å†…å®¹ã€‚</p><p>ä»¥tomcatè¿›ç¨‹ä¸ºä¾‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">Attaching to process ID 2045, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.242-b08</span><br><span class="line">Java System Properties:</span><br><span class="line"></span><br><span class="line">java.vendor = Huawei Technologies Co., Ltd</span><br><span class="line">sun.java.launcher = SUN_STANDARD</span><br><span class="line">catalina.base = /usr/share/tomcat</span><br><span class="line">sun.management.compiler = HotSpot 64-Bit Tiered Compilers</span><br><span class="line">sun.nio.ch.bugLevel = </span><br><span class="line">catalina.useNaming = true</span><br><span class="line">jnidispatch.path = /var/cache/tomcat/temp/jna--903012287/jna4240128671455089550.tmp</span><br><span class="line">os.name = Linux</span><br><span class="line">sun.boot.class.path = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/resources.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/rt.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/sunrsasign.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jsse.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jce.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/charsets.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jfr.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/classes</span><br><span class="line">java.vm.specification.vendor = Oracle Corporation</span><br><span class="line">java.runtime.version = 1.8.0_242-b08</span><br><span class="line">jna.loaded = true</span><br><span class="line">user.name = xxx</span><br><span class="line">tomcat.util.scan.StandardJarScanFilter.jarsToScan = taglibs-standard-impl*.jar</span><br><span class="line">shared.loader = </span><br><span class="line">tomcat.util.buf.StringCache.byte.enabled = true</span><br><span class="line">user.language = en</span><br><span class="line">java.naming.factory.initial = org.apache.naming.java.javaURLContextFactory</span><br><span class="line">sun.boot.library.path = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/amd64</span><br><span class="line">java.version = 1.8.0_242</span><br><span class="line">java.util.logging.manager = org.apache.juli.ClassLoaderLogManager</span><br><span class="line">user.timezone = Asia/Shanghai</span><br><span class="line">sun.arch.data.model = 64</span><br><span class="line">java.util.concurrent.ForkJoinPool.common.threadFactory = org.apache.catalina.startup.SafeForkJoinWorkerThreadFactory</span><br><span class="line">java.endorsed.dirs = </span><br><span class="line">sun.cpu.isalist = </span><br><span class="line">sun.jnu.encoding = UTF-8</span><br><span class="line">file.encoding.pkg = sun.io</span><br><span class="line">package.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.jasper.,org.apache.tomcat.</span><br><span class="line">file.separator = /</span><br><span class="line">java.specification.name = Java Platform API Specification</span><br><span class="line">java.class.version = 52.0</span><br><span class="line">user.country = US</span><br><span class="line">java.home = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre</span><br><span class="line">java.vm.info = mixed mode</span><br><span class="line">os.version = 4.19.90-24.4.v2101.ky10.x86_64</span><br><span class="line">sun.font.fontmanager = sun.awt.X11FontManager</span><br><span class="line">path.separator = :</span><br><span class="line">java.vm.version = 25.242-b08</span><br><span class="line">jboss.i18n.generate-proxies = true</span><br><span class="line">java.awt.printerjob = sun.print.PSPrinterJob</span><br><span class="line">sun.io.unicode.encoding = UnicodeLittle</span><br><span class="line">awt.toolkit = sun.awt.X11.XToolkit</span><br><span class="line">package.definition = sun.,java.,org.apache.catalina.,org.apache.coyote.,org.apache.jasper.,org.apache.naming.,org.apache.tomcat.</span><br><span class="line">java.naming.factory.url.pkgs = org.apache.naming</span><br><span class="line">mail.mime.splitlongparameters = false</span><br><span class="line">java.security.egd = file:/dev/./urandom</span><br><span class="line">user.home = /home/shterm</span><br><span class="line">java.specification.vendor = Oracle Corporation</span><br><span class="line">tomcat.util.scan.StandardJarScanFilter.jarsToSkip = activ*.jar,amqp-client.jar,annotations-api.jar,ant-junit*.jar,ant-launcher.jar,ant.jar,antlr.jar,aopalliance.jar,asm-*.jar,aspectj*.jar,bcp*.jar,bootstrap.jar,catalina-ant.jar,catalina-ha.jar,catalina-jmx-remote.jar,catalina-storeconfig.jar,catalina-tribes.jar,catalina-ws.jar,catalina.jar,cglib-*.jar,classmate.jar,cobertura-*.jar,commons-*.jar,compress-lzf.jar,curator-*.jar,db2-jdbc.jar,dom4j-*.jar,easymock-*.jar,ecj-*.jar,el-api.jar,elasticsearch.jar,geronimo-spec-jaxrpc*.jar,groovy-all.jar,guava.jar,h2*.jar,hamcrest-*.jar,hibernate*.jar,hppc.jar,http*.jar,icu4j-*.jar,itext*.jar,jackson-*.jar,jandex.jar,jasper-el.jar,jasper.jar,jasperreports*.jar,jaspic-api.jar,javamail.jar,javassist.jar,jaxb-*.jar,jaxen*.jar,jboss*.jar,jc*.jar,jdom-*.jar,jedis.jar,jetty-*.jar,jfreechart.jar,jgit.jar,jline.jar,jmx-tools.jar,jmx.jar,jna.jar,joda-time.jar,jr-*.jar,jsch.jar,json*.jar,jsoup.jar,jsp-api.jar,jsr166e.jar,jstl.jar,jta*.jar,junit-*.jar,junit.jar,liquibase-*.jar,log4j*.jar,lucene*.jar,mail*.jar,mariadb-jdbc.jar,mssql-jdbc.jar,mybatis.jar,netty.jar,nmap4j.jar,objenesis*.jar,olap4j.jar,opc*.jar,oracle-jdbc.jar,oraclepki.jar,oro-*.jar,poi*.jar,postgresql-jdbc.jar,quartz.jar,servlet-api-*.jar,servlet-api.jar,slf4j*.jar,snakeyaml.jar,snmp4j.jar,spring*.jar,sshd-core.jar,taglibs-standard-spec-*.jar,tagsoup-*.jar,t-digest.jar,tomcat-api.jar,tomcat-coyote.jar,tomcat-dbcp.jar,tomcat-i18n-*.jar,tomcat-jdbc.jar,tomcat-jni.jar,tomcat-juli-adapters.jar,tomcat-juli.jar,tomcat-util-scan.jar,tomcat-util.jar,tomcat-websocket.jar,tools.jar,validation-api.jar,velocypack.jar,websocket-api.jar,wl*.jar,wsdl4j*.jar,xercesImpl.jar,xml-apis.jar,xmlbeans.jar,xmlParserAPIs-*.jar,xmlParserAPIs.jar,xom-*.jar,xz.jar,zip4j.jar,zookeeper.jar</span><br><span class="line">java.library.path = /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line">java.vendor.url = http://jdk.rnd.huawei.com/</span><br><span class="line">java.vm.vendor = Huawei Technologies Co., Ltd</span><br><span class="line">common.loader = &quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;</span><br><span class="line">java.runtime.name = OpenJDK Runtime Environment</span><br><span class="line">sun.java.command = org.apache.catalina.startup.Bootstrap start</span><br><span class="line">java.class.path = /usr/share/tomcat/bin/bootstrap.jar:/usr/share/tomcat/bin/tomcat-juli.jar:/usr/lib/java/commons-daemon.jar</span><br><span class="line">java.vm.specification.name = Java Virtual Machine Specification</span><br><span class="line">java.vm.specification.version = 1.8</span><br><span class="line">catalina.home = /usr/share/tomcat</span><br><span class="line">sun.cpu.endian = little</span><br><span class="line">sun.os.patch.level = unknown</span><br><span class="line">java.awt.headless = true</span><br><span class="line">java.io.tmpdir = /var/cache/tomcat/temp</span><br><span class="line">java.vendor.url.bug = http://jdk.rnd.huawei.com/</span><br><span class="line">server.loader = </span><br><span class="line">java.rmi.server.hostname = 127.0.0.1</span><br><span class="line">jna.platform.library.path = /usr/lib64:/lib64:/usr/lib:/lib:/usr/lib64/tracker-miners-2.0:/usr/lib64/tracker-2.0:/usr/lib64/dyninst:/usr/libexec/sudo:/usr/lib64/sssd:/usr/pgsql-9.6/lib:/usr/lib64/perl5/CORE:/usr/lib64/opencryptoki:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/amd64/jli:/usr/lib64/bind9-export</span><br><span class="line">os.arch = amd64</span><br><span class="line">java.awt.graphicsenv = sun.awt.X11GraphicsEnvironment</span><br><span class="line">java.ext.dirs = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/ext:/usr/java/packages/lib/ext</span><br><span class="line">user.dir = /usr/share/tomcat</span><br><span class="line">line.separator = </span><br><span class="line"></span><br><span class="line">java.vm.name = OpenJDK 64-Bit Server VM</span><br><span class="line">log4j.configurationFile = /etc/tomcat/log4j2.xml</span><br><span class="line">file.encoding = UTF-8</span><br><span class="line">com.sun.jndi.ldap.object.disableEndpointIdentification = </span><br><span class="line">java.specification.version = 1.8</span><br><span class="line"></span><br><span class="line">VM Flags:</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=4 -XX:GCLogFileSize=20971520 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=null -XX:InitialHeapSize=243269632 -XX:MaxHeapSize=1610612736 -XX:MaxNewSize=536870912 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=80740352 -XX:NumberOfGCLogFiles=15 -XX:OldSize=162529280 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseGCLogFileRotation -XX:+UseParallelGC </span><br><span class="line">Command line:  -Xmx1536m -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/tomcat -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=15 -XX:GCLogFileSize=20m -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/var/log/tomcat/tomcat-gc-%t.log -Dcom.sun.jndi.ldap.object.disableEndpointIdentification -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Dlog4j.configurationFile=/etc/tomcat/log4j2.xml -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</span><br></pre></td></tr></table></figure><h2 id="3-jstat"><a href="#3-jstat" class="headerlink" title="3.jstat"></a>3.jstat</h2><p>å‘½ä»¤å‚æ•°è¯´æ˜ï¼š</p><ul><li>generalOptionsï¼šé€šç”¨é€‰é¡¹ï¼Œå¦‚æœæŒ‡å®šä¸€ä¸ªé€šç”¨é€‰é¡¹ï¼Œå°±ä¸èƒ½æŒ‡å®šä»»ä½•å…¶ä»–é€‰é¡¹æˆ–å‚æ•°ã€‚å®ƒåŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªé€‰é¡¹ï¼š</li><li>-helpï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚</li><li>-optionsï¼šæ˜¾ç¤ºoutputOptionså‚æ•°çš„åˆ—è¡¨ã€‚</li><li>outputOptionsï¼šè¾“å‡ºé€‰é¡¹ï¼ŒæŒ‡å®šæ˜¾ç¤ºæŸä¸€ç§Javaè™šæ‹Ÿæœºä¿¡æ¯ã€‚</li><li>-tï¼šæŠŠæ—¶é—´æˆ³åˆ—æ˜¾ç¤ºä¸ºè¾“å‡ºçš„ç¬¬ä¸€åˆ—ã€‚è¿™ä¸ªæ—¶é—´æˆ³æ˜¯ä»Javaè™šæ‹Ÿæœºçš„å¼€å§‹è¿è¡Œåˆ°ç°åœ¨çš„ç§’æ•°ã€‚</li><li>-h nï¼šæ¯æ˜¾ç¤ºnè¡Œæ˜¾ç¤ºä¸€æ¬¡è¡¨å¤´ï¼Œå…¶ä¸­nä¸ºæ­£æ•´æ•°ã€‚é»˜è®¤å€¼ä¸º 0ï¼Œå³ä»…åœ¨ç¬¬ä¸€è¡Œæ•°æ®æ˜¾ç¤ºä¸€æ¬¡è¡¨å¤´ã€‚</li><li>vmidï¼šè™šæ‹Ÿæœºå”¯ä¸€IDï¼ˆLVMIDï¼ŒLocal Virtual Machine Identifierï¼‰ï¼Œå¦‚æœæŸ¥çœ‹æœ¬æœºå°±æ˜¯Javaè¿›ç¨‹çš„è¿›ç¨‹IDã€‚</li><li>intervalï¼šæ˜¾ç¤ºä¿¡æ¯çš„æ—¶é—´é—´éš”ï¼Œå•ä½é»˜è®¤æ¯«ç§’ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šç§’ä¸ºå•ä½ï¼Œæ¯”å¦‚ï¼š1sã€‚å¦‚æœæŒ‡å®šäº†è¯¥å‚æ•°ï¼Œjstatå‘½ä»¤å°†æ¯éš”è¿™æ®µæ—¶é—´æ˜¾ç¤ºä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>countï¼šæ˜¾ç¤ºæ•°æ®çš„æ¬¡æ•°ï¼Œé»˜è®¤å€¼æ˜¯æ— ç©·å¤§ï¼Œè¿™å°†å¯¼è‡´jstatå‘½ä»¤ä¸€ç›´æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼Œç›´åˆ°ç›®æ ‡JVMç»ˆæ­¢æˆ–jstatå‘½ä»¤ç»ˆæ­¢ã€‚<br>è¾“å‡ºé€‰é¡¹<br>å¦‚æœä¸æŒ‡å®šé€šç”¨é€‰é¡¹ï¼ˆgeneralOptionsï¼‰ï¼Œåˆ™å¯ä»¥æŒ‡å®šè¾“å‡ºé€‰é¡¹ï¼ˆoutputOptionsï¼‰ã€‚è¾“å‡ºé€‰é¡¹å†³å®šjstatå‘½ä»¤æ˜¾ç¤ºçš„å†…å®¹å’Œæ ¼å¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</li><li>-classï¼šæ˜¾ç¤ºç±»åŠ è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´å’Œè£…è½½è€—æ—¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-compilerï¼šæ˜¾ç¤ºå³æ—¶ç¼–è¯‘çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯ã€‚</li><li>-gcï¼šæ˜¾ç¤ºå †å„ä¸ªåŒºåŸŸå†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-gccapacityï¼šæ˜¾ç¤ºå †å„ä¸ªåŒºåŸŸçš„å®¹é‡åŠå…¶å¯¹åº”çš„ç©ºé—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-gcutilï¼šæ˜¾ç¤ºæœ‰å…³åƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ‘˜è¦ã€‚</li><li>-gccauseï¼šæ˜¾ç¤ºå…³äºåƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ‘˜è¦(ä¸-gcutilç›¸åŒ)ï¼Œä»¥åŠæœ€è¿‘å’Œå½“å‰åƒåœ¾å›æ”¶çš„åŸå› ã€‚</li><li>-gcnewï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-gcnewcapacityï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£çš„å¤§å°åŠå…¶å¯¹åº”çš„ç©ºé—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-gcold: æ˜¾ç¤ºè€å¹´ä»£å’Œå…ƒç©ºé—´çš„åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-gcoldcapacityï¼šæ˜¾ç¤ºè€å¹´ä»£çš„å¤§å°ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-gcmetacapacityï¼šæ˜¾ç¤ºå…ƒç©ºé—´çš„å¤§å°çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>-printcompilationï¼šæ˜¾ç¤ºå³æ—¶ç¼–è¯‘æ–¹æ³•çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</li></ul><h1 id="äºŒã€çº¿ç¨‹å †æ ˆ"><a href="#äºŒã€çº¿ç¨‹å †æ ˆ" class="headerlink" title="äºŒã€çº¿ç¨‹å †æ ˆ"></a>äºŒã€çº¿ç¨‹å †æ ˆ</h1><h2 id="1-è¾“å‡º"><a href="#1-è¾“å‡º" class="headerlink" title="1.è¾“å‡º"></a>1.è¾“å‡º</h2><p>Javaè™šæ‹Ÿæœºæä¾›äº†çº¿ç¨‹è½¬å‚¨(Thread dump)çš„åé—¨ï¼Œé€šè¿‡è¿™ä¸ªåé—¨ï¼Œå¯ä»¥å°†çº¿ç¨‹å †æ ˆæ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªåé—¨å°±æ˜¯é€šè¿‡å‘Javaè¿›ç¨‹å‘é€ä¸€ä¸ªQUITä¿¡å·ï¼ŒJavaè™šæ‹Ÿæœºæ”¶åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œå°†ç³»ç»Ÿå½“å‰çš„JAVAçº¿ç¨‹è°ƒç”¨å †æ ˆæ‰“å°å‡ºæ¥ã€‚</p><p>æ‰“å°æ–¹æ³•ï¼š</p><ul><li>jstack -l pid &gt; xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼</li><li>kill -3<br><em><strong>åŒæ—¶è¯·ç¡®ä¿Javaå‘½ä»¤è¡Œä¸­æ²¡æœ‰DISABLE_JAVADUMPè¿è¡Œé€‰é¡¹</strong></em></li></ul><h2 id="2-çº¿ç¨‹åˆ†æ"><a href="#2-çº¿ç¨‹åˆ†æ" class="headerlink" title="2.çº¿ç¨‹åˆ†æ"></a>2.çº¿ç¨‹åˆ†æ</h2><p>é€šè¿‡è¾“å‡ºå †æ ˆè¿›è¡Œåˆ†æ <code>jstack -l $(jps | grep xxx | awk &#39;&#123;print $1&#125;&#39;)</code> &gt; &#x2F;tmp&#x2F;xxx.jstack</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;SYS_STATUS_CHECKER&quot;</span> #<span class="number">14</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f5e047bf000</span> nid=<span class="number">0xe15</span> waiting on condition [<span class="number">0x00007f5dd43d1000</span>]</span><br><span class="line">    java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">        at java.lang.Thread.sleep(Native Method)</span><br><span class="line">ru        at com.xxx.xxx.SystemStatusChecker.run(SystemStatusChecker.java:xx)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)        </span><br><span class="line">    Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line">                </span><br><span class="line"><span class="string">&quot;RMI Reaper&quot;</span> #<span class="number">39</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f5e04e4c800</span> nid=<span class="number">0xf0b</span> <span class="keyword">in</span> Object.wait() [<span class="number">0x00007f5dae2c4000</span>]</span><br><span class="line">    java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;<span class="number">0x00000000c0c88d20</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.<span class="built_in">remove</span>(ReferenceQueue.java:<span class="number">144</span>)</span><br><span class="line">        - locked &lt;<span class="number">0x00000000c0c88d20</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.<span class="built_in">remove</span>(ReferenceQueue.java:<span class="number">165</span>)</span><br><span class="line">        at sun.rmi.transport.ObjectTable$Reaper.run(ObjectTable.java:<span class="number">351</span>)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">    Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line">        </span><br><span class="line"><span class="string">&quot;main&quot;</span> #<span class="number">1</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00007f5e0400a000</span> nid=<span class="number">0xdcb</span> runnable [<span class="number">0x00007f5e0b393000</span>]</span><br><span class="line">    java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.net.PlainSocketImpl.socketAccept(Native Method)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:<span class="number">409</span>)</span><br><span class="line">        at java.net.ServerSocket.implAccept(ServerSocket.java:<span class="number">545</span>)</span><br><span class="line">        at java.net.ServerSocket.accept(ServerSocket.java:<span class="number">513</span>)</span><br><span class="line">        at com.xxx.common.xxx.await(CommonMain.java:<span class="number">244</span>)</span><br><span class="line">        at com.xxx.common.xxx.startup(CommonMain.java:<span class="number">207</span>)</span><br><span class="line">        at com.xxx.common.xxx.main(CommonMain.java:<span class="number">147</span>)</span><br><span class="line">    Locked ownable synchronizers:</span><br><span class="line">        - None</span><br></pre></td></tr></table></figure><p>åœ¨RMIçº¿ç¨‹ä¸­å¯ä»¥çœ‹åˆ° â€œ - locked &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock)â€ è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»ä½¿ç”¨äº†IDä¸ºâ€0x00000000c0c88d2â€çš„é”ï¼Œé”çš„IDç”±ç³»ç»Ÿè‡ªåŠ¨äº§ç”Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;main&quot;  prio=5     os_prio=0          tid=0x00007f5e0400a000 nid=0xdcb      runnable [0x00007f5e0b393000]</span><br><span class="line">|       |          |                  |                      |              |         |</span><br><span class="line">çº¿ç¨‹åç§° çº¿ç¨‹ä¼˜å…ˆçº§   æ“ä½œç³»ç»Ÿçº§åˆ«çš„ä¼˜å…ˆçº§   çº¿ç¨‹id                 å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹ID  çŠ¶æ€      çº¿ç¨‹å ç”¨å†…å­˜åœ°å€</span><br></pre></td></tr></table></figure><p>å…¶ä¸­â€çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹idå·â€æ‰€æŒ‡çš„â€æœ¬åœ°çº¿ç¨‹â€æ˜¯æŒ‡è¯¥Javaçº¿ç¨‹æ‰€å¯¹åº”çš„è™šæ‹Ÿæœºä¸­çš„æœ¬åœ°çº¿ç¨‹ã€‚æˆ‘ä»¬çŸ¥é“Javaæ˜¯è§£æå‹è¯­è¨€ï¼Œæ‰§è¡Œçš„å®ä½“æ˜¯Javaè™šæ‹Ÿæœºï¼Œå› æ­¤Javaè¯­è¨€ä¸­çš„çº¿ç¨‹æ˜¯ ä¾é™„äºJavaè™šæ‹Ÿæœºä¸­çš„æœ¬åœ°çº¿ç¨‹æ¥è¿è¡Œçš„ï¼Œå®é™…ä¸Šæ˜¯æœ¬åœ°çº¿ç¨‹åœ¨æ‰§è¡ŒJavaçº¿ç¨‹ä»£ç ã€‚</p><p>Javaä»£ç  ä¸­åˆ›å»ºä¸€ä¸ªthreadï¼Œè™šæ‹Ÿæœºåœ¨è¿è¡ŒæœŸå°±ä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°çº¿ç¨‹ï¼Œè€Œè¿™ä¸ªæœ¬åœ°çº¿ç¨‹æ‰æ˜¯çœŸæ­£çš„çº¿ç¨‹å®ä½“ã€‚ä¸ºäº†æ›´åŠ æ·±å…¥å¾—ç†è§£æœ¬åœ°çº¿ç¨‹å’ŒJavaçº¿ç¨‹çš„å…³ç³»ï¼Œåœ¨Unix&#x2F;Linuxä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€š å¦‚ä¸‹æ–¹å¼æŠŠJavaè™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹æ‰“å°å‡ºæ¥ï¼š</p><ul><li>ä½¿ç”¨ps -ef | grep java è·å¾—Javaè¿›ç¨‹IDã€‚</li><li>ä½¿ç”¨pstack <java pid>è·å¾—Javaè™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹çš„å †æ ˆ<br>å…¶ä¸­æœ¬åœ°çº¿ç¨‹å„é¡¹å«ä¹‰å¦‚ä¸‹ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread 56 (Thread 0x7f5e0b394700 (LWP 3531))</span><br><span class="line">|                 |                 |</span><br><span class="line">|                 |                 +----æœ¬åœ°çº¿ç¨‹id(å¦ä¸€ç§è¡¨ç¤º,LWP-light weight process)</span><br><span class="line">|                 +-------------------æœ¬åœ°çº¿ç¨‹id</span><br><span class="line">+------------------------------çº¿ç¨‹åç§°</span><br></pre></td></tr></table></figure>è€Œé€šè¿‡jstackè¾“å‡ºçš„mainæœ¬åœ°çº¿ç¨‹IDä¸º0xdcbï¼Œå…¶10è¿›åˆ¶æ­£å¥½ä¸º3531ã€‚</li></ul><p>â€œrunnableâ€è¡¨ç¤ºå½“å‰çº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ã€‚è¿™ä¸ªrunnableçŠ¶æ€æ˜¯ä»è™šæ‹Ÿæœºçš„è§’åº¦æ¥çœ‹çš„, è¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹æ­£åœ¨è¿è¡Œ</p><p><strong>âš ï¸ NOTE:</strong> ä½†æ˜¯å¤„äºRunnableçŠ¶æ€çš„çº¿ç¨‹ä¸ä¸€å®šçœŸçš„æ¶ˆè€—CPU. å¤„äºRunnableçš„çº¿ç¨‹åªèƒ½è¯´æ˜è¯¥çº¿ç¨‹æ²¡æœ‰é˜»å¡åœ¨javaçš„waitæˆ–è€…sleepæ–¹æ³•ä¸Šï¼ŒåŒæ—¶ä¹Ÿæ²¡ç­‰å¾…åœ¨é”ä¸Šé¢ã€‚ä½†æ˜¯å¦‚æœè¯¥çº¿ç¨‹è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•ï¼Œè€Œæœ¬åœ°æ–¹æ³•å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™è™šæ‹Ÿæœºæ˜¯ä¸çŸ¥é“æœ¬åœ°ä»£ç ä¸­å‘ç”Ÿ äº†ä»€ä¹ˆï¼ˆä½†æ“ä½œç³»ç»Ÿæ˜¯çŸ¥é“çš„ï¼Œpstackå°±æ˜¯æ“ä½œæä¾›çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒçŸ¥é“å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æœ¬åœ°ä»£ç ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ­¤æ—¶å°½ç®¡å½“å‰çº¿ç¨‹å®é™…ä¸Šä¹Ÿæ˜¯é˜»å¡çš„çŠ¶æ€ï¼Œä½†å®é™…ä¸Šæ˜¾ç¤ºå‡ºæ¥çš„è¿˜æ˜¯runnableçŠ¶æ€ï¼Œ è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸æ¶ˆè€—CPUçš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. å¤„äºwaittigå’ŒblockedçŠ¶æ€çš„çº¿ç¨‹éƒ½ä¸ä¼šæ¶ˆè€—CPU </span><br><span class="line">2. çº¿ç¨‹é¢‘ç¹åœ°æŒ‚èµ·å’Œå”¤é†’éœ€è¦æ¶ˆè€—CPU, è€Œä¸”ä»£ä»·é¢‡å¤§</span><br></pre></td></tr></table></figure><ul><li>TIMED_WAITING(on object monitor) è¡¨ç¤ºå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,è¯´æ˜è¯¥çº¿ç¨‹æ­£åœ¨ æ‰§è¡Œobj.wait(int time)æ–¹æ³•.</li><li>TIMED_WAITING(sleeping) è¡¨ç¤ºå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,å³æ­£åœ¨æ‰§è¡ŒThread.sleep(int time)æ–¹æ³•. </li><li>TIMED_WAITING(parking) å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,å³æ­£åœ¨æ‰§è¡ŒThread.sleep(int time)æ–¹æ³•.</li><li>WAINTING(on object monitor) å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œå³æ­£åœ¨æ‰§è¡Œobj.wait()æ–¹æ³•(æ— å‚æ•°çš„wait()æ–¹æ³•).<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤„äºTIMED_WAITINGã€WAINTINGçŠ¶æ€çš„çº¿ç¨‹ä¸€å®šä¸æ¶ˆè€—CPU. å¤„äºRUNNABLEçš„çº¿ç¨‹ï¼Œè¦ç»“åˆå½“å‰çº¿ç¨‹ä»£ç çš„æ€§è´¨åˆ¤æ–­ï¼Œæ˜¯å¦æ¶ˆè€—CPU.</span><br><span class="line">â€¢ å¦‚æœæ˜¯çº¯Javaè¿ç®—ä»£ç ï¼Œåˆ™æ¶ˆè€—CPU.</span><br><span class="line">â€¢ å¦‚æœæ˜¯ç½‘ç»œIO,å¾ˆå°‘æ¶ˆè€—CPU.</span><br><span class="line">â€¢ å¦‚æœæ˜¯æœ¬åœ°ä»£ç ï¼Œç»“åˆæœ¬åœ°ä»£ç çš„æ€§è´¨åˆ¤æ–­(å¯ä»¥é€šè¿‡pstack/gstackè·å–æœ¬åœ°çº¿ç¨‹å †æ ˆ)ï¼Œ å¦‚æœæ˜¯çº¯è¿ç®—ä»£ç ï¼Œåˆ™æ¶ˆè€—CPU, å¦‚æœè¢«æŒ‚èµ·ï¼Œåˆ™ä¸æ¶ˆè€—CPU,å¦‚æœæ˜¯IO,åˆ™ä¸æ€ä¹ˆæ¶ˆ è€—CPUã€‚</span><br></pre></td></tr></table></figure></li></ul><h1 id="ä¸‰ã€ç›¸å…³çš„æ’æŸ¥æ–¹æ³•"><a href="#ä¸‰ã€ç›¸å…³çš„æ’æŸ¥æ–¹æ³•" class="headerlink" title="ä¸‰ã€ç›¸å…³çš„æ’æŸ¥æ–¹æ³•"></a>ä¸‰ã€ç›¸å…³çš„æ’æŸ¥æ–¹æ³•</h1><h2 id="1-CPU"><a href="#1-CPU" class="headerlink" title="1.CPU"></a>1.CPU</h2><p>ç”Ÿäº§ç¯å¢ƒä¸­å¾€å¾€ä¼šå‡ºç°CPUé£™é«˜çš„æƒ…å†µï¼Œå¯¹äºJAVAåº”ç”¨è€Œè¨€ï¼Œæ­¤ç±»é—®é¢˜ç›¸å¯¹è¾ƒå¥½ç¡®å®šé—®é¢˜æ–¹å‘ã€‚</p><h3 id="1-1-ä½¿ç”¨jstackç¡®å®šCPUå ç”¨é«˜çš„çº¿ç¨‹"><a href="#1-1-ä½¿ç”¨jstackç¡®å®šCPUå ç”¨é«˜çš„çº¿ç¨‹" class="headerlink" title="1.1 ä½¿ç”¨jstackç¡®å®šCPUå ç”¨é«˜çš„çº¿ç¨‹\"></a>1.1 ä½¿ç”¨jstackç¡®å®šCPUå ç”¨é«˜çš„çº¿ç¨‹\</h3><p>é€šè¿‡<code>top</code>æŒ‡ä»¤ï¼Œå¯ä»¥çœ‹åˆ°è¿›ç¨‹å ç”¨çš„ä¸€äº›åŸºç¡€èµ„æºä¿¡æ¯ï¼Œç„¶åâ€œPâ€é”®å¯ä»¥æŒ‰ç…§CPUä½¿ç”¨ç‡è¿›è¡Œæ’åºï¼Œâ€œMâ€é”®å¯ä»¥æŒ‰ç…§å†…å­˜å ç”¨æƒ…å†µè¿›è¡Œæ’åº</p><p>æ‰¾åˆ°CPUå ç”¨é«˜çš„è¿›ç¨‹pidï¼Œç„¶åå°†jstackä¿¡æ¯å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼Œé€šè¿‡<code>top -Hp pid</code>æŸ¥çœ‹å…·ä½“çš„æƒ…å†µã€‚</p><p>é€šè¿‡ <code>printf &#39;%x\n&#39; pid</code>å°†pidè½¬æ¢ä¸º16è¿›åˆ¶ï¼Œç„¶ååœ¨jstackæ–‡ä»¶ä¸­æ ¹æ®å¯¹åº”çš„æ•°å­—è¿›è¡ŒæŸ¥æ‰¾ï¼Œç„¶åé’ˆå¯¹æ€§çš„è¿›è¡Œåˆ†æ</p><h3 id="1-2-é¢‘ç¹GC"><a href="#1-2-é¢‘ç¹GC" class="headerlink" title="1.2 é¢‘ç¹GC"></a>1.2 é¢‘ç¹GC</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥å…ˆç¡®å®šä¸‹gcæ˜¯ä¸æ˜¯å¤ªé¢‘ç¹ï¼Œä½¿ç”¨<code>jstat -gc pid 1000</code>å‘½ä»¤æ¥å¯¹gcåˆ†ä»£å˜åŒ–æƒ…å†µè¿›è¡Œè§‚å¯Ÿï¼Œ1000è¡¨ç¤ºé‡‡æ ·é—´éš”(ms)ï¼Œ<code>S0C/S1Cã€S0U/S1Uã€EC/EUã€OC/OUã€MC/MU</code>åˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªSurvivoråŒºã€EdenåŒºã€è€å¹´ä»£ã€å…ƒæ•°æ®åŒºçš„å®¹é‡å’Œä½¿ç”¨é‡ã€‚<code>YGC/YGTã€FGC/FGCTã€GCT</code>åˆ™ä»£è¡¨YoungGcã€FullGcçš„è€—æ—¶å’Œæ¬¡æ•°ä»¥åŠæ€»è€—æ—¶ã€‚å¦‚æœçœ‹åˆ°gcæ¯”è¾ƒé¢‘ç¹ï¼Œå†é’ˆå¯¹gcæ–¹é¢åšè¿›ä¸€æ­¥åˆ†æã€‚<br><img src="/../images/gc.png" alt="alt text"></p><h3 id="1-3-é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢"><a href="#1-3-é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢" class="headerlink" title="1.3 é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢"></a>1.3 é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢</h3><p>é’ˆå¯¹é¢‘ç¹ä¸Šä¸‹æ–‡é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨vmstatå‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹<br><img src="/../images/vmstat.png" alt="alt text"><br>cs(context switch)ä¸€åˆ—åˆ™ä»£è¡¨äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ã€‚</p><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›å¯¹ç‰¹å®šçš„pidè¿›è¡Œç›‘æ§é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ <code>pidstat -w pid</code>å‘½ä»¤ï¼Œcswchå’Œnvcswchè¡¨ç¤ºè‡ªæ„¿åŠéè‡ªæ„¿åˆ‡æ¢ã€‚</p><h2 id="2-å†…å­˜"><a href="#2-å†…å­˜" class="headerlink" title="2.å†…å­˜"></a>2.å†…å­˜</h2><p>å¯¹äºJAVAåº”ç”¨ï¼Œæ¶‰åŠåˆ°çš„å†…å­˜é—®é¢˜ä¸»è¦åŒ…æ‹¬OOMã€GCé—®é¢˜å’Œå †å¤–å†…å­˜ã€‚</p><h3 id="2-1-OOM"><a href="#2-1-OOM" class="headerlink" title="2.1 OOM"></a>2.1 OOM</h3><p>JVMä¸­çš„å†…å­˜ä¸è¶³ï¼ŒOOMå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µ</p><ul><li><code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: unable to create new native thread</code> è¿™ä¸ªæ„æ€æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ç»™çº¿ç¨‹åˆ†é…javaæ ˆï¼ŒåŸºæœ¬ä¸Šè¿˜æ˜¯çº¿ç¨‹æ± ä»£ç å†™çš„æœ‰é—®é¢˜ï¼Œæ¯”å¦‚è¯´å¿˜è®°shutdownï¼Œæ‰€ä»¥è¯´åº”è¯¥é¦–å…ˆä»ä»£ç å±‚é¢æ¥å¯»æ‰¾é—®é¢˜ï¼Œä½¿ç”¨jstackæˆ–è€…jmapã€‚å¦‚æœä¸€åˆ‡éƒ½æ­£å¸¸ï¼ŒJVMæ–¹é¢å¯ä»¥é€šè¿‡æŒ‡å®šXssæ¥å‡å°‘å•ä¸ªthread stackçš„å¤§å°ã€‚å¦å¤–ä¹Ÿå¯ä»¥åœ¨ç³»ç»Ÿå±‚é¢ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹<code>/etc/security/limits.confnofile</code>å’Œ<code>nproc</code>æ¥å¢å¤§oså¯¹çº¿ç¨‹çš„é™åˆ¶</li><li><code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space </code> è¿™ä¸ªæ„æ€æ˜¯å †çš„å†…å­˜å ç”¨å·²ç»è¾¾åˆ°-Xmxè®¾ç½®çš„æœ€å¤§å€¼ï¼Œåº”è¯¥æ˜¯æœ€å¸¸è§çš„OOMé”™è¯¯äº†ã€‚è§£å†³æ€è·¯ä»ç„¶æ˜¯å…ˆåº”è¯¥åœ¨ä»£ç ä¸­æ‰¾ï¼Œæ€€ç–‘å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œé€šè¿‡jstackå’Œjmapå»å®šä½é—®é¢˜ã€‚å¦‚æœè¯´ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œæ‰éœ€è¦é€šè¿‡è°ƒæ•´Xmxçš„å€¼æ¥æ‰©å¤§å†…å­˜ã€‚</li><li><code>Caused by: java.lang.OutOfMemoryError: Meta space</code> è¿™ä¸ªæ„æ€æ˜¯å…ƒæ•°æ®åŒºçš„å†…å­˜å ç”¨å·²ç»è¾¾åˆ°<code>XX:MaxMetaspaceSize</code>è®¾ç½®çš„æœ€å¤§å€¼ï¼Œæ’æŸ¥æ€è·¯å’Œä¸Šé¢çš„ä¸€è‡´ï¼Œå‚æ•°æ–¹é¢å¯ä»¥é€šè¿‡<code>XX:MaxPermSize</code>æ¥è¿›è¡Œè°ƒæ•´</li><li><code>Exception in thread &quot;main&quot; java.lang.StackOverflowError</code> è¡¨ç¤ºçº¿ç¨‹æ ˆéœ€è¦çš„å†…å­˜å¤§äºXsså€¼ï¼ŒåŒæ ·ä¹Ÿæ˜¯å…ˆè¿›è¡Œæ’æŸ¥ï¼Œå‚æ•°æ–¹é¢é€šè¿‡Xssæ¥è°ƒæ•´ï¼Œä½†è°ƒæ•´çš„å¤ªå¤§å¯èƒ½åˆä¼šå¼•èµ·OOMã€‚</li></ul><h3 id="2-2-GCé—®é¢˜"><a href="#2-2-GCé—®é¢˜" class="headerlink" title="2.2 GCé—®é¢˜"></a>2.2 GCé—®é¢˜</h3><p>gcé—®é¢˜é™¤äº†å½±å“cpuä¹Ÿä¼šå½±å“å†…å­˜ï¼Œæ’æŸ¥æ€è·¯ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚ä¸€èˆ¬å…ˆä½¿ç”¨jstatæ¥æŸ¥çœ‹åˆ†ä»£å˜åŒ–æƒ…å†µï¼Œæ¯”å¦‚youngGCæˆ–è€…fullGCæ¬¡æ•°æ˜¯ä¸æ˜¯å¤ªå¤šå‘€ï¼›EUã€OUç­‰æŒ‡æ ‡å¢é•¿æ˜¯ä¸æ˜¯å¼‚å¸¸ç­‰ã€‚</p><p>çº¿ç¨‹çš„è¯å¤ªå¤šè€Œä¸”ä¸è¢«åŠæ—¶gcä¹Ÿä¼šå¼•å‘oomï¼Œå¤§éƒ¨åˆ†å°±æ˜¯ä¹‹å‰è¯´çš„<code>unable to create new native thread</code>ã€‚é™¤äº†jstackç»†ç»†åˆ†ædumpæ–‡ä»¶å¤–ï¼Œæˆ‘ä»¬ä¸€èˆ¬å…ˆä¼šçœ‹ä¸‹æ€»ä½“çº¿ç¨‹ï¼Œé€šè¿‡<code>pstreee -p pid |wc -l</code></p><h3 id="2-3-å †å¤–å†…å­˜"><a href="#2-3-å †å¤–å†…å­˜" class="headerlink" title="2.3 å †å¤–å†…å­˜"></a>2.3 å †å¤–å†…å­˜</h3><p>JVM çš„å †å¤–å†…å­˜ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>JVM è‡ªèº«è¿è¡Œå ç”¨çš„ç©ºé—´ï¼›</li><li>çº¿ç¨‹æ ˆåˆ†é…å ç”¨çš„ç³»ç»Ÿå†…å­˜ï¼›</li><li>DirectByteBuffer å ç”¨çš„å†…å­˜ï¼›</li><li>JNI é‡Œåˆ†é…çš„å†…å­˜ï¼›</li><li>Java 8 å¼€å§‹çš„å…ƒæ•°æ®ç©ºé—´ï¼›</li><li>NIO ç¼“å­˜</li><li>Unsafe è°ƒç”¨åˆ†é…çš„å†…å­˜ï¼›</li><li>codecache</li></ul><p>å†°å±±å¯¹è±¡ï¼šå†°å±±å¯¹è±¡æ˜¯æŒ‡åœ¨ JVM å †é‡Œå ç”¨çš„å†…å­˜å¾ˆå°ï¼Œä½†å…¶å®å¼•ç”¨äº†ä¸€å—å¾ˆå¤§çš„æœ¬åœ°å†…å­˜ã€‚DirectByteBuffer å’Œ çº¿ç¨‹éƒ½å±äºè¿™ç±»å¯¹è±¡ã€‚</p><h4 id="2-3-1NMTåˆ†æå †å¤–å†…å­˜"><a href="#2-3-1NMTåˆ†æå †å¤–å†…å­˜" class="headerlink" title="2.3.1NMTåˆ†æå †å¤–å†…å­˜"></a>2.3.1NMTåˆ†æå †å¤–å†…å­˜</h4><p>NMTï¼ˆNative Memory Trackingï¼‰æ˜¯ HotSpot JVM å¼•å…¥çš„è·Ÿè¸ª JVM å†…éƒ¨ä½¿ç”¨çš„æœ¬åœ°å†…å­˜çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡ jcmd å·¥å…·è®¿é—® NMT æ•°æ®ã€‚NMT ç›®å‰ä¸æ”¯æŒè·Ÿè¸ªç¬¬ä¸‰æ–¹æœ¬åœ°ä»£ç çš„å†…å­˜åˆ†é…å’Œ JDK ç±»åº“ã€‚</p><p>NMT ä¸è·Ÿè¸ªé JVM ä»£ç çš„å†…å­˜åˆ†é…ï¼Œæœ¬åœ°ä»£ç é‡Œçš„å†…å­˜æ³„éœ²éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„å·¥å…·æ¥å®šä½ã€‚</p><h4 id="2-3-2-å¼€å¯-NMT"><a href="#2-3-2-å¼€å¯-NMT" class="headerlink" title="2.3.2 å¼€å¯ NMT"></a>2.3.2 å¼€å¯ NMT</h4><p>å¯ç”¨ NMT ä¼šå¸¦æ¥ 5-10% çš„æ€§èƒ½æŸå¤±ã€‚NMT çš„å†…å­˜ä½¿ç”¨ç‡æƒ…å†µéœ€è¦æ·»åŠ ä¸¤ä¸ªæœºå™¨å­— word åˆ° malloc å†…å­˜çš„ malloc å¤´é‡Œã€‚NMT å†…å­˜ä½¿ç”¨ç‡ä¹Ÿè¢« NMT è·Ÿè¸ªã€‚<br>å¯åŠ¨å‘½ä»¤ï¼š <code>-XX:NativeMemoryTracking=[off | summary | detail]</code>ã€‚</p><ul><li>offï¼šNMT é»˜è®¤æ˜¯å…³é—­çš„ï¼›</li><li>summaryï¼šåªæ”¶é›†å­ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨çš„æ€»è®¡æ•°æ®ï¼›</li><li>detailï¼šæ”¶é›†æ¯ä¸ªè°ƒç”¨ç‚¹çš„å†…å­˜ä½¿ç”¨æ•°æ®ã€‚</li></ul><h4 id="2-3-3-jcmd-è®¿é—®-NMT-æ•°æ®"><a href="#2-3-3-jcmd-è®¿é—®-NMT-æ•°æ®" class="headerlink" title="2.3.3 jcmd è®¿é—® NMT æ•°æ®"></a>2.3.3 jcmd è®¿é—® NMT æ•°æ®</h4><p>å‘½ä»¤ï¼š<br><code>jcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]</code></p>]]></content>
    
    
    <summary type="html">javaå¸¸è§é—®é¢˜å’Œæ’æŸ¥çš„åŸºæœ¬æ–¹æ³•å’Œå·¥å…·ä»‹ç»</summary>
    
    
    
    <category term="é—®é¢˜æ’æŸ¥" scheme="http://baixiaozhou.github.io/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    
    
    <category term="JAVA" scheme="http://baixiaozhou.github.io/tags/JAVA/"/>
    
    <category term="Linux" scheme="http://baixiaozhou.github.io/tags/Linux/"/>
    
  </entry>
  
</feed>
