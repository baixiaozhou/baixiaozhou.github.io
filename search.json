[{"title":"Pacemaker+Corosyncä½¿ç”¨ç®€ä»‹","path":"/p/Pacemaker-Corosyncä½¿ç”¨ç®€ä»‹/","content":"å‚è€ƒæ–‡æ¡£ çº¢å¸½å®˜æ–¹æ–‡æ¡£ ä»‹ç»pacemaker å’Œ corosyncæ˜¯ä¸¤ç§å¼€æºè½¯ä»¶ç»„ä»¶ï¼Œé€šå¸¸ç»“åˆä½¿ç”¨ä»¥æ„å»ºé«˜å¯ç”¨æ€§ï¼ˆHAï¼‰é›†ç¾¤ã€‚ PacemakerPacemaker æ˜¯ä¸€ä¸ªé›†ç¾¤èµ„æºç®¡ç†å™¨ï¼Œè´Ÿè´£ç®¡ç†é›†ç¾¤ä¸­æ‰€æœ‰èµ„æºçš„å¯åŠ¨ã€åœæ­¢ã€è¿ç§»ç­‰æ“ä½œã€‚å®ƒé€šè¿‡ä¸ Corosync åä½œï¼Œç¡®ä¿åœ¨èŠ‚ç‚¹æ•…éšœæˆ–æœåŠ¡å¼‚å¸¸æ—¶ï¼Œèµ„æºèƒ½å¤Ÿè‡ªåŠ¨åœ¨å…¶ä»–å¥åº·èŠ‚ç‚¹ä¸Šæ¥ç®¡ã€‚ä»è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œpacemaker çš„æ ¸å¿ƒåœ¨äºç®¡ç† ç»„ä»¶pacemaker ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ç»„ä»¶: CIB (Cluster Information Base)ï¼šå­˜å‚¨é›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬èµ„æºã€çº¦æŸã€èŠ‚ç‚¹ç­‰ã€‚ CRM (Cluster Resource Manager)ï¼šå†³å®šå¦‚ä½•åœ¨é›†ç¾¤ä¸­åˆ†é…å’Œç®¡ç†èµ„æºã€‚ PEngine (Policy Engine)ï¼šæ ¹æ®é›†ç¾¤çŠ¶æ€å’Œé…ç½®ç­–ç•¥åšå‡ºå†³ç­–ã€‚ Fencingï¼šé€šè¿‡ STONITHï¼ˆShoot The Other Node In The Headï¼‰æœºåˆ¶æ¥éš”ç¦»å¤±æ•ˆçš„èŠ‚ç‚¹ï¼Œé˜²æ­¢è„‘è£‚ã€‚ ä½¿ç”¨åœºæ™¯ ç®¡ç†é›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼ˆå¦‚è™šæ‹Ÿ IPã€æ•°æ®åº“æœåŠ¡ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰ã€‚ ç¡®ä¿æœåŠ¡çš„é«˜å¯ç”¨æ€§ï¼Œåœ¨æ•…éšœå‘ç”Ÿæ—¶è‡ªåŠ¨åˆ‡æ¢èµ„æºåˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ CorosyncCorosync æ˜¯ä¸€ä¸ªé›†ç¾¤é€šä¿¡å¼•æ“ï¼Œè´Ÿè´£åœ¨é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´æä¾›æ¶ˆæ¯ä¼ é€’ã€ç»„æˆå‘˜èµ„æ ¼ç®¡ç†ã€å¿ƒè·³æ£€æµ‹ç­‰åŠŸèƒ½ã€‚å®ƒç¡®ä¿é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´çš„ä¿¡æ¯åŒæ­¥ï¼Œç›‘æ§èŠ‚ç‚¹çš„å¥åº·çŠ¶å†µï¼Œå¹¶åœ¨èŠ‚ç‚¹æ•…éšœæ—¶é€šçŸ¥ pacemakerã€‚ ç»„ä»¶ ç»„é€šä¿¡ï¼šç”¨äºç¡®ä¿é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ä¿æŒä¸€è‡´çš„è§†å›¾ã€‚ æ•…éšœæ£€æµ‹ï¼šé€šè¿‡å¿ƒè·³æœºåˆ¶ç›‘æ§èŠ‚ç‚¹çŠ¶æ€ï¼Œå½“èŠ‚ç‚¹å¤±è”æ—¶ï¼Œé€šçŸ¥ Pacemakerã€‚ é…ç½®ç®¡ç†ï¼šç®¡ç†é›†ç¾¤èŠ‚ç‚¹çš„é…ç½®å’Œæˆå‘˜èµ„æ ¼ã€‚ ä½¿ç”¨åœºæ™¯ é›†ç¾¤ä¸­èŠ‚ç‚¹é—´çš„å®æ—¶é€šä¿¡ã€‚ ç›‘æ§èŠ‚ç‚¹çš„å¯ç”¨æ€§ï¼Œå¹¶åœ¨èŠ‚ç‚¹å¤±æ•ˆæ—¶åšå‡ºå“åº”ã€‚ å®‰è£…éƒ¨ç½²å®‰è£…ä¾èµ– åœ¨é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…ç›¸å…³ä¾èµ–:1yum install -y pcs pacemaker corosync # Centos å¯åŠ¨ç›¸å…³æœåŠ¡å¹¶è®¾ç½®æœåŠ¡å¼€æœºè‡ªå¯åŠ¨:123systemctl start pcsd systemctl enable pcsd è®¾ç½®haclusterç”¨æˆ·çš„å¯†ç (æ­¤ç”¨æˆ·åœ¨åŒ…å®‰è£…çš„è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨åˆ›å»º)1sudo passwd hacluster åœ¨ /etc/hosts ä¸­åŠ å…¥èŠ‚ç‚¹é…ç½®ï¼Œä¾‹å¦‚:12192.168.1.2 node2192.168.1.3 node3 å‘½ä»¤æ“ä½œé›†ç¾¤çš„å‘½ä»¤è¡Œæ“ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡ pcs è¿›è¡Œï¼Œpcs æä¾›äº†å¦‚ä¸‹ä¸€äº›å‘½ä»¤: å‘½ä»¤ è¯´æ˜ ç¤ºä¾‹å‘½ä»¤ cluster é…ç½®é›†ç¾¤é€‰é¡¹å’ŒèŠ‚ç‚¹ pcs cluster start å¯åŠ¨é›†ç¾¤ resource ç®¡ç†é›†ç¾¤èµ„æº pcs resource create myresource ocf:heartbeat:IPaddr2 ip=192.168.1.1 åˆ›å»ºä¸€ä¸ªèµ„æº stonith ç®¡ç† fence è®¾å¤‡ pcs stonith create myfence fence_ipmilan ipaddr=192.168.1.100 login=admin passwd=password lanplus=1 åˆ›å»º STONITH è®¾å¤‡ constraint ç®¡ç†èµ„æºçº¦æŸ pcs constraint location myresource prefers node1=100 è®¾ç½®èµ„æºçº¦æŸ property ç®¡ç† Pacemaker å±æ€§ pcs property set stonith-enabled=false ç¦ç”¨ STONITH acl ç®¡ç† Pacemaker è®¿é—®æ§åˆ¶åˆ—è¡¨ pcs acl role create readonly åˆ›å»ºåªè¯»è§’è‰² qdevice ç®¡ç†æœ¬åœ°ä¸»æœºä¸Šçš„ä»²è£è®¾å¤‡æä¾›ç¨‹åº pcs qdevice add model net æ·»åŠ ç½‘ç»œä»²è£è®¾å¤‡ quorum ç®¡ç†é›†ç¾¤ä»²è£è®¾ç½® pcs quorum status æŸ¥çœ‹ä»²è£çŠ¶æ€ booth ç®¡ç† booth (é›†ç¾¤ç¥¨æ®ç®¡ç†å™¨) pcs booth status æŸ¥çœ‹ booth çŠ¶æ€ status æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ pcs status æŸ¥çœ‹é›†ç¾¤è¿è¡ŒçŠ¶æ€ config æŸ¥çœ‹å’Œç®¡ç†é›†ç¾¤é…ç½® pcs config show æ˜¾ç¤ºé›†ç¾¤é…ç½® pcsd ç®¡ç† pcs å®ˆæŠ¤è¿›ç¨‹ pcs pcsd status æŸ¥çœ‹ pcsd æœåŠ¡çŠ¶æ€ node ç®¡ç†é›†ç¾¤èŠ‚ç‚¹ pcs node standby node1 å°†èŠ‚ç‚¹è®¾ç½®ä¸ºå¤‡ç”¨ alert ç®¡ç† Pacemaker è­¦æŠ¥ pcs alert create node=node1 severity=critical åˆ›å»ºè­¦æŠ¥ client ç®¡ç† pcsd å®¢æˆ·ç«¯é…ç½® pcs client cert-key-gen --force ç”Ÿæˆæ–°çš„å®¢æˆ·ç«¯è¯ä¹¦ èŠ‚ç‚¹è®¤è¯å’Œé›†ç¾¤åˆ›å»ºåœ¨é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œ: è®¤è¯: 1pcs cluster auth node2 node3 -u hacluster è®¤è¯å®Œæ•´ååˆ›å»ºé›†ç¾¤ 1pcs cluster setup --name mycluster node2 node3 (åŒæ—¶æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹) åˆ›å»ºå®Œæˆåï¼Œä¼šç”Ÿæˆ corosync çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä½ç½®/etc/corosync/corosync.conf, å…¶ä¸­çš„å†…å®¹å¦‚ä¸‹: 1234567891011121314151617181920212223242526272829totem &#123; version: 2 cluster_name: mycluster secauth: off transport: udpu&#125;nodelist &#123; node &#123; ring0_addr: node2 nodeid: 1 &#125; node &#123; ring0_addr: node3 nodeid: 2 &#125;&#125;quorum &#123; provider: corosync_votequorum two_node: 1&#125;logging &#123; to_logfile: yes logfile: /var/log/cluster/corosync.log to_syslog: yes&#125; å¯åŠ¨é›†ç¾¤ 12pcs cluster start --all # è¿™é‡Œå¯åŠ¨å¤±è´¥çš„è¯ï¼Œå¯ä»¥åé¢åŠ ä¸Š --debugå‚æ•°æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯èƒ½ä¼šå› ä¸ºé˜²ç«å¢™ç­‰é—®é¢˜å¯¼è‡´å¯åŠ¨å¤±è´¥pcs cluster enable --all # è®¾ç½®è‡ªå¯åŠ¨ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ 1pcs status æˆ‘ä»¬çœ‹ä¸‹è¾“å‡ºæƒ…å†µ: 12345678910111213141516171819202122Cluster name: myclusterWARNINGS:No stonith devices and stonith-enabled is not falseStack: corosyncCurrent DC: node2 (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorumLast updated: Mon Sep 2 18:43:57 2024Last change: Mon Sep 2 18:35:08 2024 by hacluster via crmd on node22 nodes configured0 resource instances configuredOnline: [ node2 node3 ]No resourcesDaemon Status: corosync: active/disabled pacemaker: active/disabled pcsd: active/enabled è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é›†ç¾¤çš„æ€»ä½“æƒ…å†µï¼ŒåŒ…æ‹¬èŠ‚ç‚¹çŠ¶æ€ã€æœåŠ¡çŠ¶æ€ï¼ˆæœ‰ä¸¤ä¸ªæœåŠ¡è¿˜å¤„äº disabled çŠ¶æ€ï¼Œ é€šè¿‡systemctl enable corosync pacemaker è®¾ç½®å¼€æœºå¯åŠ¨ï¼‰ã€èµ„æºä¿¡æ¯ï¼ˆè¿˜æ²¡æœ‰æ·»åŠ  resourceï¼‰ç­‰ stonith é…ç½®åœ¨ä¸Šæ–‡é›†ç¾¤çš„çŠ¶æ€è¾“å‡ºä¸­è¿˜åŒ…æ‹¬äº†ä¸€ä¸ªå‘Šè­¦ä¿¡æ¯: No stonith devices and stonith-enabled is not false, è¿™é‡Œçš„ stonithï¼ˆShoot The Other Node In The Headï¼‰ æ˜¯ä¸€ç§é˜²æ­¢â€œè„‘è£‚â€ (split-brain) çš„æœºåˆ¶ã€‚å½“é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å¤±å»ä¸å…¶ä»–èŠ‚ç‚¹çš„è¿æ¥æ—¶ï¼Œstonith è®¾å¤‡å¯ä»¥å¼ºåˆ¶é‡å¯æˆ–å…³é—­è¿™ä¸ªå¤±è”çš„èŠ‚ç‚¹ï¼Œé¿å…ä¸¤ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹åŒæ—¶æ“ä½œåŒä¸€ä¸ªèµ„æºï¼Œå¯¼è‡´æ•°æ®æŸåã€‚æƒ³è¦æ¶ˆé™¤è¿™ä¸ªå‘Šè­¦ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ: ç¦ç”¨ stonith: å¦‚æœæ˜¯è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒï¼Œé‚£ä¹ˆå¯ä»¥ç¦ç”¨æ‰ stonith æ¥æ¶ˆé™¤å‘Šè­¦ï¼Œæ“ä½œæ–¹æ³•ä¸º: 1pcs property set stonith-enabled=false é…ç½® stonith è®¾å¤‡: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®é…ç½® stonith æˆ‘ä»¬å…ˆæ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æŒ‡ç¤ºçœ‹ä¸€ä¸‹stonith æœ‰å“ªäº›å¯ç”¨ä»£ç†: 12[root@node2 corosync]# pcs stonith listError: No stonith agents available. Do you have fence agents installed? è¿™é‡Œæç¤ºæ²¡æœ‰ä»£ç†çš„ agent å¯ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£…fence agentï¼š 1yum install -y fence-agents æˆ‘ä»¬å† list ä¸€ä¸‹ï¼Œå°±å¯ä»¥çœ‹åˆ°æ”¯æŒçš„ä»£ç†äº† Fence Agent æè¿° fence_amt_ws é€‚ç”¨äº AMT (WS) çš„ Fence ä»£ç† fence_apc é€šè¿‡ telnet&#x2F;ssh æ§åˆ¶ APC çš„ Fence ä»£ç† fence_apc_snmp é€‚ç”¨äº APC å’Œ Tripplite PDU çš„ SNMP Fence ä»£ç† fence_bladecenter é€‚ç”¨äº IBM BladeCenter çš„ Fence ä»£ç† fence_brocade é€šè¿‡ telnet&#x2F;ssh æ§åˆ¶ HP Brocade çš„ Fence ä»£ç† fence_cisco_mds é€‚ç”¨äº Cisco MDS çš„ Fence ä»£ç† fence_cisco_ucs é€‚ç”¨äº Cisco UCS çš„ Fence ä»£ç† fence_compute ç”¨äºè‡ªåŠ¨å¤æ´» OpenStack è®¡ç®—å®ä¾‹çš„ Fence ä»£ç† fence_drac5 é€‚ç”¨äº Dell DRAC CMC&#x2F;5 çš„ Fence ä»£ç† fence_eaton_snmp é€‚ç”¨äº Eaton çš„ SNMP Fence ä»£ç† fence_emerson é€‚ç”¨äº Emerson çš„ SNMP Fence ä»£ç† fence_eps é€‚ç”¨äº ePowerSwitch çš„ Fence ä»£ç† fence_evacuate ç”¨äºè‡ªåŠ¨å¤æ´» OpenStack è®¡ç®—å®ä¾‹çš„ Fence ä»£ç† fence_heuristics_ping åŸºäº ping è¿›è¡Œå¯å‘å¼ Fencing çš„ä»£ç† fence_hpblade é€‚ç”¨äº HP BladeSystem çš„ Fence ä»£ç† fence_ibmblade é€šè¿‡ SNMP æ§åˆ¶ IBM BladeCenter çš„ Fence ä»£ç† fence_idrac é€‚ç”¨äº IPMI çš„ Fence ä»£ç† fence_ifmib é€‚ç”¨äº IF MIB çš„ Fence ä»£ç† fence_ilo é€‚ç”¨äº HP iLO çš„ Fence ä»£ç† fence_ilo2 é€‚ç”¨äº HP iLO2 çš„ Fence ä»£ç† fence_ilo3 é€‚ç”¨äº IPMI çš„ Fence ä»£ç† fence_ilo3_ssh é€šè¿‡ SSH æ§åˆ¶ HP iLO3 çš„ Fence ä»£ç† fence_ilo4 é€‚ç”¨äº IPMI çš„ Fence ä»£ç† fence_ilo4_ssh é€šè¿‡ SSH æ§åˆ¶ HP iLO4 çš„ Fence ä»£ç† fence_ilo5 é€‚ç”¨äº IPMI çš„ Fence ä»£ç† fence_ilo5_ssh é€šè¿‡ SSH æ§åˆ¶ HP iLO5 çš„ Fence ä»£ç† fence_ilo_moonshot é€‚ç”¨äº HP Moonshot iLO çš„ Fence ä»£ç† fence_ilo_mp é€‚ç”¨äº HP iLO MP çš„ Fence ä»£ç† fence_ilo_ssh é€šè¿‡ SSH æ§åˆ¶ HP iLO çš„ Fence ä»£ç† fence_imm é€‚ç”¨äº IPMI çš„ Fence ä»£ç† fence_intelmodular é€‚ç”¨äº Intel Modular çš„ Fence ä»£ç† fence_ipdu é€šè¿‡ SNMP æ§åˆ¶ iPDU çš„ Fence ä»£ç† fence_ipmilan é€‚ç”¨äº IPMI çš„ Fence ä»£ç† fence_kdump ä¸ kdump å´©æºƒæ¢å¤æœåŠ¡ä¸€èµ·ä½¿ç”¨çš„ Fence ä»£ç† fence_mpath ç”¨äºå¤šè·¯å¾„æŒä¹…ä¿ç•™çš„ Fence ä»£ç† fence_redfish é€‚ç”¨äº Redfish çš„ I&#x2F;O Fencing ä»£ç† fence_rhevm é€‚ç”¨äº RHEV-M REST API çš„ Fence ä»£ç† fence_rsa é€‚ç”¨äº IBM RSA çš„ Fence ä»£ç† fence_rsb é€‚ç”¨äº Fujitsu-Siemens RSB çš„ I&#x2F;O Fencing ä»£ç† fence_sbd é€‚ç”¨äº SBD çš„ Fence ä»£ç† fence_scsi ç”¨äº SCSI æŒä¹…ä¿ç•™çš„ Fence ä»£ç† fence_virt é€‚ç”¨äºè™šæ‹Ÿæœºçš„ Fence ä»£ç† fence_vmware_rest é€‚ç”¨äº VMware REST API çš„ Fence ä»£ç† fence_vmware_soap é€šè¿‡ SOAP API æ§åˆ¶ VMware çš„ Fence ä»£ç† fence_wti é€‚ç”¨äº WTI çš„ Fence ä»£ç† fence_xvm é€‚ç”¨äºè™šæ‹Ÿæœºçš„ Fence ä»£ç† æƒ³æŸ¥çœ‹ä»£ç†çš„å…·ä½“ç”¨æ³•ï¼Œå¯ä»¥ä½¿ç”¨: 1pcs stonith describe stonith_agent ä½¿ç”¨ fence_heuristics_ping ä½œä¸ºä»£ç†ï¼Œå…ˆé€šè¿‡pcs stonith describe fence_heuristics_ping çœ‹ä¸‹å…·ä½“çš„ç”¨æ³•å’Œé…ç½® 12345678910111213141516171819202122232425262728293031323334353637fence_heuristics_ping - Fence agent for ping-heuristic based fencingfence_heuristics_ping uses ping-heuristics to control execution of another fence agent on the same fencing level.This is not a fence agent by itself! Its only purpose is to enable/disable another fence agent that lives on the same fencing level but after fence_heuristics_ping.Stonith options: method: Method to fence ping_count: The number of ping-probes that is being sent per target ping_good_count: The number of positive ping-probes required to account a target as available ping_interval: The interval in seconds between ping-probes ping_maxfail: The number of failed ping-targets to still account as overall success ping_targets (required): A comma separated list of ping-targets (optionally prepended by &#x27;inet:&#x27; or &#x27;inet6:&#x27;) to be probed ping_timeout: The timeout in seconds till an individual ping-probe is accounted as lost quiet: Disable logging to stderr. Does not affect --verbose or --debug-file or logging to syslog. verbose: Verbose mode debug: Write debug information to given file delay: Wait X seconds before fencing is started login_timeout: Wait X seconds for cmd prompt after login power_timeout: Test X seconds for status change after ON/OFF power_wait: Wait X seconds after issuing ON/OFF shell_timeout: Wait X seconds for cmd prompt after issuing command retry_on: Count of attempts to retry power on pcmk_host_map: A mapping of host names to ports numbers for devices that do not support host names. Eg. node1:1;node2:2,3 would tell the cluster to use port 1 for node1 and ports 2 and 3 for node2 pcmk_host_list: A list of machines controlled by this device (Optional unless pcmk_host_check=static-list). pcmk_host_check: How to determine which machines are controlled by the device. Allowed values: dynamic-list (query the device via the &#x27;list&#x27; command), static-list (check the pcmk_host_list attribute), status (query the device via the &#x27;status&#x27; command), none (assume every device can fence every machine) pcmk_delay_max: Enable a random delay for stonith actions and specify the maximum of random delay. This prevents double fencing when using slow devices such as sbd. Use this to enable a random delay for stonith actions. The overall delay is derived from this random delay value adding a static delay so that the sum is kept below the maximum delay. pcmk_delay_base: Enable a base delay for stonith actions and specify base delay value. This prevents double fencing when different delays are configured on the nodes. Use this to enable a static delay for stonith actions. The overall delay is derived from a random delay value adding this static delay so that the sum is kept below the maximum delay. pcmk_action_limit: The maximum number of actions can be performed in parallel on this device Pengine property concurrent-fencing=true needs to be configured first. Then use this to specify the maximum number of actions can be performed in parallel on this device. -1 is unlimited.Default operations: monitor: interval=60s è¿™é‡Œæˆ‘ä»¬è¿›è¡Œåˆ›å»º(å…¶ä»–å‚æ•°éƒ½æœ‰é»˜è®¤å€¼ï¼ŒæŒ‰éœ€ä¿®æ”¹å³å¯): 12pcs stonith create my_ping_fence_device fence_heuristics_ping \\ ping_targets=&quot;node2,node3&quot; åˆ›å»ºå®Œæˆåpcs statusæŸ¥çœ‹çŠ¶æ€ 1234567891011121314151617181920212223Cluster name: myclusterStack: corosyncCurrent DC: node2 (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorumLast updated: Tue Sep 3 14:40:56 2024Last change: Tue Sep 3 14:35:39 2024 by root via cibadmin on node22 nodes configured1 resource instance configuredOnline: [ node2 node3 ]Full list of resources: my_ping_fence_device\t(stonith:fence_heuristics_ping):\tStarted node2Failed Fencing Actions:* reboot of my_apc_fence_device failed: delegate=, client=stonith_admin.40341, origin=node2, last-failed=&#x27;Tue Sep 3 14:12:23 2024&#x27;Daemon Status: corosync: active/enabled pacemaker: active/enabled pcsd: active/enabled éªŒè¯ stonith æ˜¯å¦ç”Ÿæ•ˆ: 12[root@node2 cluster]# pcs stonith fence node3Node: node3 fenced æ‰§è¡Œå®Œè¿™ä¸ªæ“ä½œåï¼ŒèŠ‚ç‚¹ä¼šç¦»çº¿ï¼Œpcs æœåŠ¡ä¼šåœæ­¢ï¼Œæƒ³è¦åŠ å›æ¥çš„è¯ï¼Œåœ¨åœæ­¢çš„èŠ‚ç‚¹ä¸Šé‡æ–°å¯åŠ¨é›†ç¾¤å³å¯:pcs cluster start &amp;&amp; pcs cluster enable å®æˆ˜æ“ä½œæ·»åŠ èŠ‚ç‚¹ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªä¸¤èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ„å»ºä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„é›†ç¾¤ é¦–å…ˆåœ¨æ–°èŠ‚ç‚¹ä¸Šå®‰è£…å„ç§ä¾èµ–ï¼Œè®¾ç½®å¯†ç ç­‰ã€‚ åœ¨åŸé›†ç¾¤ä¸Šè®¤è¯æ–° node åœ¨åŸé›†ç¾¤ä¸Šæ·»åŠ  nodeï¼špcs cluster node add node4 åœ¨ node4 ä¸Šæ‰§è¡Œï¼špcs cluster start &amp;&amp; pcs cluster enable å†é€šè¿‡pcs statuså°±å¯ä»¥çœ‹åˆ°æ–°çš„èŠ‚ç‚¹å·²ç»åŠ å…¥ æ·»åŠ å®Œä¹‹åè¿˜éœ€è¦æ›´æ–°æ–°èŠ‚ç‚¹çš„ä¸€äº›é…ç½®ï¼Œæ¯”å¦‚ä¸Šæ–‡æåˆ°çš„ stonithï¼š 12pcs stonith update my_ping_fence_device fence_heuristics_ping \\ ping_targets=&quot;node2,node3,node4&quot; é…ç½® resourceèµ„æºç±»å‹åˆ›å»º resource çš„åŸºæœ¬æ ¼å¼ä¸º: 1pcs resource create resource-name ocf:heartbeat:apache [--options] è¿™é‡Œçš„ ocf:heartbeat:apache ç¬¬ä¸€ä¸ªéƒ¨åˆ†ocfï¼ŒæŒ‡æ˜äº†è¿™ä¸ªèµ„æºé‡‡ç”¨çš„æ ‡å‡†(ç±»å‹)ï¼Œç¬¬äºŒä¸ªéƒ¨åˆ†æ ‡æ˜è¿™ä¸ªèµ„æºè„šæœ¬çš„åœ¨ocfä¸­çš„åå­—ç©ºé—´ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯heartbeatã€‚æœ€åä¸€ä¸ªéƒ¨åˆ†æŒ‡æ˜äº†èµ„æºè„šæœ¬çš„åç§°ã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸‹æœ‰å“ªäº›æ ‡å‡†ç±»å‹ 12345[root@node3 ~]# pcs resource standardslsbocfservicesystemd æŸ¥çœ‹å¯ç”¨çš„ocfèµ„æºæä¾›è€…: 1234[root@node3 ~]# pcs resource providersheartbeatopenstackpacemaker æŸ¥çœ‹ç‰¹å®šæ ‡å‡†ä¸‹æ‰€æ”¯æŒçš„è„šæœ¬ï¼Œä¾‹ï¼šofc:heartbeat ä¸‹çš„è„šæœ¬(åˆ—ä¸¾äº†éƒ¨åˆ†)ï¼š 12345678910111213141516171819202122232425[root@node3 ~]# pcs resource agents ocf:heartbeataliyun-vpc-move-ipapacheaws-vpc-move-ipaws-vpc-route53awseipawsvipazure-eventsazure-lbclvmconntrackdCTDBdb2DelaydhcpddockerDummyethmonitorexportfsFilesystemgaleragarbdiface-vlanIPaddrIPaddr2 è®¾ç½®è™šæ‹Ÿ ipè™šæ‹Ÿ IPï¼ˆVirtual IPï¼‰æ˜¯åœ¨é«˜å¯ç”¨æ€§é›†ç¾¤ä¸­ä½¿ç”¨çš„ä¸€ç§æŠ€æœ¯ï¼Œé€šè¿‡ä¸ºæœåŠ¡æä¾›ä¸€ä¸ªä¸ä¾èµ–äºç‰¹å®šç‰©ç†èŠ‚ç‚¹çš„ IP åœ°å€æ¥å®ç°æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚å½“é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œè™šæ‹Ÿ IP å¯ä»¥è¿…é€Ÿè½¬ç§»åˆ°å¦ä¸€ä¸ªå¥åº·çš„èŠ‚ç‚¹ä¸Šï¼Œä»è€Œä¿è¯æœåŠ¡çš„è¿ç»­æ€§ã€‚ è™šæ‹Ÿ IP çš„ä½¿ç”¨åœºæ™¯ é«˜å¯ç”¨æ€§ï¼šè™šæ‹Ÿ IP æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯é«˜å¯ç”¨æ€§é›†ç¾¤ï¼ˆå¦‚ Pacemaker æˆ– Keepalivedï¼‰ï¼Œå®ƒå…è®¸ä¸€ä¸ªæœåŠ¡åœ¨é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè€Œä¸ä¼šæ›´æ”¹å®¢æˆ·ç«¯è®¿é—®çš„ IP åœ°å€ã€‚ è´Ÿè½½å‡è¡¡ï¼šè™šæ‹Ÿ IP å¯ä»¥ç»“åˆè´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨ï¼Œå°†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ†é…åˆ°å¤šä¸ªåç«¯æœåŠ¡å™¨ï¼Œä»¥å®ç°æµé‡çš„å‡åŒ€åˆ†å¸ƒã€‚ ç¾éš¾æ¢å¤ï¼šåœ¨ç¾éš¾æ¢å¤åœºæ™¯ä¸­ï¼Œè™šæ‹Ÿ IP å¯ä»¥ç”¨äºå¿«é€Ÿæ¢å¤æœåŠ¡ï¼Œå°†ä¸šåŠ¡æµé‡ä»æ•…éšœèŠ‚ç‚¹è½¬ç§»åˆ°å¤‡ç”¨èŠ‚ç‚¹ä¸Š åœ¨ pcs é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¢åŠ ä¸€ä¸ªè™šæ‹Ÿ ip: 1pcs resource create virtual_ip ocf:heartbeat:IPaddr2 ip=x.x.x.x cidr_netmask=32 nic=bond1 op monitor interval=30s æ‰§è¡Œå®Œæˆåï¼Œé€šè¿‡pcs statuså°±å¯ä»¥çœ‹åˆ° ip ç»‘å®šåœ¨å“ªé‡Œ: 1virtual_ip\t(ocf::heartbeat:IPaddr2):\tStarted node3 å½“æˆ‘ä»¬å…³åœ node3 çš„æœåŠ¡æ—¶ï¼Œå°±ä¼šå‘ç°è¿™ä¸ªè™šæ‹Ÿip ç»‘å®šåˆ°äº†å…¶ä»–èŠ‚ç‚¹çš„ bond1 ç½‘å¡ä¸Šã€‚ å¢åŠ æœåŠ¡æˆ‘ä»¬ä»¥ httpd æœåŠ¡ä¸ºä¾‹ï¼Œåœ¨é›†ç¾¤ä¸­åˆ›å»ºèµ„æº,é¦–å…ˆå®‰è£…å¯¹åº”æœåŠ¡: 123sudo yum install httpd -ysudo systemctl start httpdsudo systemctl enable httpd åˆ›å»º resource: 1pcs resource create WebService ocf:heartbeat:apache configfile=/etc/httpd/conf/httpd.conf op monitor interval=30s ç»“åˆ LVS è¿›è¡Œä½¿ç”¨","tags":["Linux","Pacemaker","Corosync","é«˜å¯ç”¨æ–¹æ¡ˆ"],"categories":["é«˜å¯ç”¨"]},{"title":"å·¥ä½œéšè®°","path":"/p/å·¥ä½œéšè®°/","content":"Centos å®‰è£… EBPF Centos å®‰è£… EBPFå®‰è£…å¿…è¦å·¥å…·å’Œä¾èµ–: 1sudo yum install python3 python3-pip python3-devel gcc gcc-c++ make bcc bcc-tools bcc-devel å®‰è£… BCC Python æ¨¡å— 1pip3 install bcc ç¦»çº¿å®‰è£…çš„æ–¹å¼å¦‚ä¸‹ï¼š ä¸‹è½½ bcc å’Œ Python æ¨¡å—æºåŒ…123456# ä¸‹è½½ bcc çš„æºç åŒ…wget https://github.com/iovisor/bcc/archive/refs/tags/v0.22.0.tar.gz -O bcc.tar.gz# ä¸‹è½½ bcc çš„ Python æ¨¡å—æºä»£ç åŒ…# å¯ä»¥å»è¿™é‡Œ https://pypi.org/project/bcc/#files è¿›è¡ŒæŸ¥æ‰¾wget https://files.pythonhosted.org/packages/38/dc/3ca34874926789f8df53f3c1d1c38e77ebf876f43760e8745316bb8bd1c0/bcc-0.1.10.tar.gz ä¸Šä¼ æ–‡ä»¶åˆ°ç¦»çº¿ç¯å¢ƒä¸Š,è§£å‹å¹¶è¿›è¡Œå®‰è£…:12345678910111213tar -xzf bcc.tar.gzcd bcc-0.22.0 # ç›®å½•åå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå¯èƒ½éœ€è¦æ ¹æƒé™ï¼‰sudo yum install -y gcc gcc-c++ make bpfcc-tools # CentOS/RHELsudo apt-get install -y gcc g++ make bpfcc-tools # Ubuntu/Debian# ç¼–è¯‘å’Œå®‰è£… bccmkdir buildcd buildcmake ..makesudo make install å®‰è£… bcc Python æ¨¡å—123456# è§£å‹ä¸‹è½½çš„ Python æ¨¡å—æºä»£ç åŒ…tar -xzf bcc-python.tar.gzcd bcc-python # ç›®å½•åå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ# å®‰è£… Python æ¨¡å—pip3 install .","tags":["Linux","ebpf"],"categories":["å·¥ä½œéšè®°"]},{"title":"ansibleè¯¦ç»†ä»‹ç»","path":"/p/ansibleå·¥å…·ä½¿ç”¨/","content":"å®˜æ–¹æ–‡æ¡£ è‹±æ–‡æ–‡æ¡£ä¸­æ–‡æ–‡æ¡£ ansible ä»‹ç»æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ ansible çš„ç›¸å…³ä»‹ç»: 1Ansible is a radically simple IT automation platform that makes your applications and systems easier to deploy and maintain. Automate everything from code deployment to network configuration to cloud management, in a language that approaches plain English, using SSH, with no agents to install on remote systems. https://docs.ansible.com. è¿™é‡Œæœ‰å‡ ç‚¹æ ¸å¿ƒ: ansible æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–å¹³å° ansible ä½¿ç”¨ ssh åè®®ï¼ˆé€šè¿‡å¯†ç æˆ–è€…å¯†é’¥ç­‰æ–¹å¼è¿›è¡Œè®¿é—®ï¼‰ï¼Œéƒ¨ç½²ç®€å•ï¼Œæ²¡æœ‰å®¢æˆ·ç«¯ï¼Œåªéœ€åœ¨ä¸»æ§ç«¯éƒ¨ç½² Ansible ç¯å¢ƒï¼Œæ— éœ€åœ¨è¿œç¨‹ç³»ç»Ÿä¸Šå®‰è£…ä»£ç†ç¨‹åº æ¨¡å—åŒ–ï¼šè°ƒç”¨ç‰¹å®šçš„æ¨¡å—ï¼Œå®Œæˆç‰¹å®šä»»åŠ¡ æ”¯æŒè‡ªå®šä¹‰æ‰©å±• æ¯å¼€å‘ä¸€ä¸ªå·¥å…·æˆ–è€…å¹³å°çš„æ—¶å€™ï¼Œè¿™äº›å·¥å…·å’Œå¹³å°æä¾›äº†å„ç§å„æ ·çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ç”¨ ansible æ¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ ä¸‹é¢å°±æ˜¯ä¸€äº› ansible æ ¸å¿ƒçš„åŠŸèƒ½ä»‹ç»ï¼š åŠŸèƒ½ æè¿° å¸¸è§åœºæ™¯ç¤ºä¾‹ é…ç½®ç®¡ç† è‡ªåŠ¨åŒ–ç®¡ç†æœåŠ¡å™¨å’Œè®¾å¤‡çš„é…ç½®ï¼Œç¡®ä¿å®ƒä»¬å¤„äºæœŸæœ›çš„çŠ¶æ€ã€‚ è‡ªåŠ¨åŒ–å®‰è£…å’Œé…ç½® Web æœåŠ¡å™¨ï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨é…ç½®ä¸€è‡´ã€‚ åº”ç”¨éƒ¨ç½² è‡ªåŠ¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²è¿‡ç¨‹ï¼Œä»ä»£ç åº“æ‹‰å–åˆ°åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²å’Œé…ç½®åº”ç”¨ã€‚ è‡ªåŠ¨éƒ¨ç½²å¤šå±‚ Web åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬æ•°æ®åº“è®¾ç½®ã€åº”ç”¨æœåŠ¡éƒ¨ç½²ã€è´Ÿè½½å‡è¡¡é…ç½®ç­‰ã€‚ æŒç»­äº¤ä»˜ä¸æŒç»­é›†æˆï¼ˆCI&#x2F;CDï¼‰ ä¸ CI&#x2F;CD å·¥å…·é›†æˆï¼Œå®ç°è‡ªåŠ¨åŒ–çš„æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹ã€‚ ä»£ç æäº¤åè‡ªåŠ¨æ‰§è¡Œæµ‹è¯•ã€æ„å»ºå®¹å™¨é•œåƒï¼Œå¹¶éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚ åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰ ç¼–å†™å’Œç®¡ç†åŸºç¡€è®¾æ–½çš„é…ç½®æ–‡ä»¶ï¼Œä½¿å…¶åƒç®¡ç†ä»£ç ä¸€æ ·ã€‚ ä½¿ç”¨ Ansible Playbooks å®šä¹‰äº‘ç¯å¢ƒèµ„æºé…ç½®ï¼Œå®ç°å¯é‡å¤çš„åŸºç¡€è®¾æ–½éƒ¨ç½²ã€‚ äº‘ç®¡ç† è‡ªåŠ¨åŒ–äº‘æœåŠ¡èµ„æºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºã€å­˜å‚¨ã€ç½‘ç»œç­‰çš„åˆ›å»ºå’Œé…ç½®ã€‚ è‡ªåŠ¨åŒ–åˆ›å»ºå’Œç®¡ç† AWS EC2 å®ä¾‹ã€é…ç½® VPC å’Œå®‰å…¨ç»„ã€‚ ç½‘ç»œè‡ªåŠ¨åŒ– ç®¡ç†å’Œé…ç½®ç½‘ç»œè®¾å¤‡ï¼Œä½¿å¾—å¤§è§„æ¨¡çš„ç½‘ç»œè®¾å¤‡é…ç½®å˜å¾—ç®€å•å’Œä¸€è‡´ã€‚ è‡ªåŠ¨åŒ–é…ç½®å¤šå°äº¤æ¢æœºçš„ VLAN è®¾ç½®å’Œè·¯ç”±åè®®ã€‚ å®‰å…¨ä¸åˆè§„ è‡ªåŠ¨åŒ–å®‰å…¨è¡¥ä¸çš„éƒ¨ç½²ã€ç³»ç»Ÿå®‰å…¨é…ç½®çš„å¼ºåŒ–ä»¥åŠåˆè§„æ€§æ£€æŸ¥ã€‚ è‡ªåŠ¨åŒ–åº”ç”¨ç³»ç»Ÿå®‰å…¨è¡¥ä¸ï¼Œé…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œæ‰§è¡Œå®‰å…¨æ‰«æå’Œåˆè§„æ€§æ£€æŸ¥ã€‚ å¤šå¹³å°ç¯å¢ƒç®¡ç† æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿï¼Œåœ¨æ··åˆç¯å¢ƒä¸­ç»Ÿä¸€ç®¡ç†å¹³å°ä¸Šçš„é…ç½®å’Œåº”ç”¨ã€‚ åœ¨æ··åˆçš„ Linux å’Œ Windows æœåŠ¡å™¨ç¯å¢ƒä¸­ï¼Œç»Ÿä¸€éƒ¨ç½²å’Œé…ç½®ç›‘æ§è½¯ä»¶ã€‚ ç¾éš¾æ¢å¤ è‡ªåŠ¨åŒ–ç¾éš¾æ¢å¤æµç¨‹ï¼Œå¦‚å¤‡ä»½ã€æ•°æ®æ¢å¤å’ŒæœåŠ¡æ¢å¤ã€‚ è‡ªåŠ¨åŒ–æ•°æ®åº“å¤‡ä»½å¹¶åœ¨éœ€è¦æ—¶æ¢å¤å’Œé‡å»ºæ•°æ®åº“æœåŠ¡ã€‚ ä»»åŠ¡è°ƒåº¦ä¸æ‰¹é‡æ“ä½œ é€šè¿‡ Playbooks è°ƒåº¦å®šæœŸä»»åŠ¡æˆ–å¯¹å¤§é‡æœåŠ¡å™¨æ‰§è¡Œæ‰¹é‡æ“ä½œã€‚ å®šæœŸæ¸…ç†æœåŠ¡å™¨ä¸Šçš„ä¸´æ—¶æ–‡ä»¶æˆ–æ‰¹é‡æ›´æ–°å¤šä¸ªæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿã€‚ ansibleçš„å·¥ä½œæœºåˆ¶Ansible åœ¨ç®¡ç†èŠ‚ç‚¹å°† Ansible æ¨¡å—é€šè¿‡ SSH åè®®æ¨é€åˆ°è¢«ç®¡ç†ç«¯æ‰§è¡Œï¼Œæ‰§è¡Œå®Œä¹‹åè‡ªåŠ¨åˆ é™¤ï¼Œå¯ä»¥ä½¿ç”¨ SVN ç­‰æ¥ç®¡ç†è‡ªå®šä¹‰æ¨¡å—åŠç¼–æ’ ansibleç»“æ„ ä»è¿™å¼ å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œansible ç”±ä»¥ä¸‹æ¨¡å—ç»„æˆ 1234567Ansibleï¼š ansibleçš„æ ¸å¿ƒæ¨¡å—Host Inventoryï¼šä¸»æœºæ¸…å•ï¼Œä¹Ÿå°±æ˜¯è¢«ç®¡ç†çš„ä¸»æœºåˆ—è¡¨Playbooksï¼šansibleçš„å‰§æœ¬ï¼Œå¯æƒ³è±¡ä¸ºå°†å¤šä¸ªä»»åŠ¡æ”¾ç½®åœ¨ä¸€èµ·ï¼Œä¸€å—æ‰§è¡ŒCore Modulesï¼šansibleçš„æ ¸å¿ƒæ¨¡å—Custom Modulesï¼šè‡ªå®šä¹‰æ¨¡å—Connection Pluginsï¼šè¿æ¥æ’ä»¶ï¼Œç”¨äºä¸è¢«ç®¡æ§ä¸»æœºä¹‹é—´åŸºäºSSHå»ºç«‹è¿æ¥å…³ç³»Pluginsï¼šå…¶ä»–æ’ä»¶ï¼ŒåŒ…æ‹¬è®°å½•æ—¥å¿—ç­‰ ansible å®‰è£…åœ¨ centos ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š 1yum install ansible -y è¿›è¡Œå®‰è£… å®‰è£…å®Œæˆåæˆ‘ä»¬çœ‹ä¸‹ ansible æä¾›äº†å“ªäº›å‘½ä»¤: å‘½ä»¤ æè¿° ç¤ºä¾‹ ansible ç”¨äºåœ¨ä¸€ä¸ªæˆ–å¤šä¸ªä¸»æœºä¸Šè¿è¡Œå•ä¸ªæ¨¡å—ï¼ˆé€šå¸¸ç”¨äºä¸´æ—¶å‘½ä»¤ï¼‰ã€‚ ansible all -m ping ansible-playbook ç”¨äºè¿è¡Œ Ansible playbook æ–‡ä»¶ï¼Œæ˜¯ Ansible çš„æ ¸å¿ƒå‘½ä»¤ä¹‹ä¸€ã€‚ ansible-playbook site.yml ansible-galaxy ç”¨äºç®¡ç† Ansible è§’è‰²å’Œé›†åˆã€‚å¯ä»¥ä¸‹è½½ã€åˆ›å»ºå’Œåˆ†äº«è§’è‰²ã€‚ ansible-galaxy install geerlingguy.apache ansible-vault ç”¨äºåŠ å¯†å’Œè§£å¯†æ•æ„Ÿæ•°æ®ï¼ˆå¦‚å¯†ç ã€å¯†é’¥ï¼‰ã€‚ ansible-vault encrypt secrets.yml ansible-doc æ˜¾ç¤º Ansible æ¨¡å—çš„æ–‡æ¡£å’Œç¤ºä¾‹ç”¨æ³•ã€‚ ansible-doc -l ansible-config ç”¨äºæŸ¥çœ‹ã€éªŒè¯å’Œç®¡ç† Ansible é…ç½®æ–‡ä»¶ã€‚ ansible-config list ansible-inventory ç®¡ç†å’Œæ£€ç´¢ Ansible inventory ä¿¡æ¯ã€‚ ansible-inventory --list -i inventory.yml ansible-pull ç”¨äºä»è¿œç¨‹ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼ˆå¦‚ Gitï¼‰æ‹‰å– playbook å¹¶åœ¨æœ¬åœ°æ‰§è¡Œï¼Œå¸¸ç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚ ansible-pull -U https://github.com/username/repo.git ansible-console æä¾›ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œæ¥å£ï¼Œå¯ç”¨äºåŠ¨æ€æ‰§è¡Œ Ansible ä»»åŠ¡å’Œå‘½ä»¤ã€‚ ansible-console å¯¹ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å‘½ä»¤:ansible å’Œ ansible-plabook åšä¸€ä¸‹å…·ä½“çš„ä»‹ç»: ansible å‘½ä»¤å‘½ä»¤æ ¼å¼: 1ansible ç»„å -m æ¨¡å—å -a &#x27;å‚æ•°&#x27; è¿™é‡Œçš„ç»„åæ˜¯è‡ªå®šä¹‰çš„ä¸€ç³»åˆ—ç»„ä¿¡æ¯ï¼Œç»„çš„å®šä¹‰åœ¨åé¢ä¼šè®²åˆ°ã€‚ æ¨¡å—åæ˜¯ansibleæä¾›çš„ä¸€äº›åˆ—æ”¯æŒæ¨¡å—ï¼Œé»˜è®¤æ¨¡å—æ˜¯ commandï¼ŒæŸ¥çœ‹ ansible æ”¯æŒçš„æ¨¡å—ï¼š 1ansible-doc -l #å¤§æ¦‚æœ‰ 3000 å¤šä¸ª ansibleæ¶‰åŠåˆ°çš„æ¨¡å—éå¸¸éå¸¸å¤šï¼ŒæŒ‰ç…§å®é™…éœ€è¦ä½¿ç”¨ï¼Œåˆæ­¥å…ˆæŒæ¡ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å°±å¯ä»¥ æŸ¥çœ‹æ¨¡å—æè¿°ï¼š 1ansible-doc -s æ¨¡å—åç§° å®ä¾‹: 1234# æŸ¥çœ‹webserver ç»„æœºå™¨çš„æ—¶é—´ä¿¡æ¯ansible webserver -m shell -a &quot;date&quot; # è¿™é‡Œçš„ç»„å°±æ˜¯ webserverï¼Œshell æ˜¯æ¨¡å—åï¼ˆæ¯”è¾ƒå¸¸ç”¨çš„æ¨¡å—ï¼‰date æ˜¯å…·ä½“æ‰§è¡Œçš„å‘½ä»¤# å°†æœ¬æœºçš„/tmp/test.sh æ‹·è´åˆ°å…¶ä»–æœºå™¨ä¸Šçš„ /etcç›®å½•ä¸‹ansible webserver -m copy -a &quot;src=/tmp/test.sh dest=/etc/test.sh&quot; # è¿™é‡Œçš„ copy æ˜¯æ¨¡å—åï¼Œé‡Œé¢çš„ src æ˜¯æºè·¯å¾„ï¼Œdest æ˜¯ç›®æ ‡è·¯å¾„ ansible-playbookå‘½ä»¤ç”¨äºæ‰§è¡Œ Ansible Playbooksã€‚Playbooks æ˜¯ä¸€ç³»åˆ—ä»»åŠ¡çš„é›†åˆï¼Œç”¨äºè‡ªåŠ¨åŒ–é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€ä»»åŠ¡æ‰§è¡Œç­‰æ“ä½œã€‚åŸºæœ¬è¯­æ³•: 1ansible-playbook [options] playbook.yml å‘½ä»¤å¸®åŠ©: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485positional arguments: playbook Playbook(s)optional arguments: --ask-vault-pass ask for vault password --flush-cache clear the fact cache for every host in inventory --force-handlers run handlers even if a task fails --list-hosts outputs a list of matching hosts; does not execute anything else --list-tags list all available tags --list-tasks list all tasks that would be executed --skip-tags SKIP_TAGS only run plays and tasks whose tags do not match these values --start-at-task START_AT_TASK start the playbook at the task matching this name --step one-step-at-a-time: confirm each task before running --syntax-check perform a syntax check on the playbook, but do not execute it --vault-id VAULT_IDS the vault identity to use --vault-password-file VAULT_PASSWORD_FILES vault password file --version show program&#x27;s version number, config file location, configured module search path, module location, executable location and exit -C, --check don&#x27;t make any changes; instead, try to predict some of the changes that may occur -D, --diff when changing (small) files and templates, show the differences in those files; works great with --check -M MODULE_PATH, --module-path MODULE_PATH prepend colon-separated path(s) to module library (def ault=~/.ansible/plugins/modules:/usr/share/ansible/plu gins/modules) -e EXTRA_VARS, --extra-vars EXTRA_VARS set additional variables as key=value or YAML/JSON, if filename prepend with @ -f FORKS, --forks FORKS specify number of parallel processes to use (default=64) -h, --help show this help message and exit -i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY specify inventory host path or comma separated host list. --inventory-file is deprecated -l SUBSET, --limit SUBSET further limit selected hosts to an additional pattern -t TAGS, --tags TAGS only run plays and tasks tagged with these values -v, --verbose verbose mode (-vvv for more, -vvvv to enable connection debugging)Connection Options: control as whom and how to connect to hosts --private-key PRIVATE_KEY_FILE, --key-file PRIVATE_KEY_FILE use this file to authenticate the connection --scp-extra-args SCP_EXTRA_ARGS specify extra arguments to pass to scp only (e.g. -l) --sftp-extra-args SFTP_EXTRA_ARGS specify extra arguments to pass to sftp only (e.g. -f, -l) --ssh-common-args SSH_COMMON_ARGS specify common arguments to pass to sftp/scp/ssh (e.g. ProxyCommand) --ssh-extra-args SSH_EXTRA_ARGS specify extra arguments to pass to ssh only (e.g. -R) -T TIMEOUT, --timeout TIMEOUT override the connection timeout in seconds (default=10) -c CONNECTION, --connection CONNECTION connection type to use (default=smart) -k, --ask-pass ask for connection password -u REMOTE_USER, --user REMOTE_USER connect as this user (default=None)Privilege Escalation Options: control how and which user you become as on target hosts --become-method BECOME_METHOD privilege escalation method to use (default=sudo), use `ansible-doc -t become -l` to list valid choices. --become-user BECOME_USER run operations as this user (default=root) -K, --ask-become-pass ask for privilege escalation password -b, --become run operations with become (does not imply password prompting) ansible åŸºæœ¬ä½¿ç”¨æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªæœ€åŸºæœ¬çš„ ansible ç»„æˆ: ansibleåŸºæœ¬ç»„æˆ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¤§éƒ¨åˆ†çš„ ansible ç¯å¢ƒéƒ½åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶: æ§åˆ¶èŠ‚ç‚¹:å®‰è£…äº†Ansibleçš„ç³»ç»Ÿã€‚å¯ä»¥åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šè¿è¡ŒAnsibleå‘½ä»¤ï¼Œä¾‹å¦‚ansibleæˆ–ansible-inventoryã€‚ Inventory: æŒ‰é€»è¾‘ç»„ç»‡çš„æ‰˜ç®¡èŠ‚ç‚¹çš„åˆ—è¡¨ã€‚å¯ä»¥åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ¸…å•ï¼Œä»¥å‘Ansibleæè¿°ä¸»æœºéƒ¨ç½²ã€‚ è¢«ç®¡ç†èŠ‚ç‚¹: Ansibleæ§åˆ¶çš„è¿œç¨‹ç³»ç»Ÿæˆ–ä¸»æœºã€‚ Inventoryæ–‡ä»¶inventory ä¸»è¦åŒ…æ‹¬ä¸»æœºå’Œç»„ä¸¤ä¸ªæ¦‚å¿µ, é»˜è®¤æ–‡ä»¶ /etc/ansible/hosts ä¸»æœºä¸»æœºæ˜¯ Ansible å¯ä»¥ç®¡ç†çš„å•ä¸ªè®¾å¤‡æˆ–è™šæ‹Ÿæœºã€‚ä¸»æœºå¯ä»¥æ˜¯ç‰©ç†æœåŠ¡å™¨ã€è™šæ‹Ÿæœºã€å®¹å™¨ï¼Œç”šè‡³æ˜¯ç½‘ç»œè®¾å¤‡ï¼ˆå¦‚è·¯ç”±å™¨å’Œäº¤æ¢æœºï¼‰ã€‚æ¯ä¸ªä¸»æœºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼ˆé€šå¸¸æ˜¯ä¸»æœºåæˆ– IP åœ°å€ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ Ansible çš„ inventory æ–‡ä»¶æˆ–å…¶ä»–åŠ¨æ€æ–¹æ³•æ¥å®šä¹‰ 1234567891011# å®šä¹‰å•ä¸ªä¸»æœºweb1.example.com# å®šä¹‰å¤šä¸ªä¸»æœºweb2.example.com192.168.1.10# ä¸»æœºå˜é‡[atlanta]host1 http_port=80 maxRequestsPerChild=808host2 http_port=303 maxRequestsPerChild=909 ç»„ç»„æ˜¯ä¸»æœºçš„é›†åˆï¼Œå¯ä»¥å¯¹ä¸€ç»„ä¸»æœºåº”ç”¨ç›¸åŒçš„é…ç½®æˆ–æ“ä½œã€‚ç»„å…è®¸ç”¨æˆ·åœ¨å¤šä¸ªä¸»æœºä¸Šæ‰¹é‡æ‰§è¡Œä»»åŠ¡ã€‚ä¸€ä¸ªä¸»æœºå¯ä»¥å±äºå¤šä¸ªç»„ã€‚ç»„ä¹‹é—´è¿˜å¯ä»¥åµŒå¥—ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†æ‰€æœ‰ Web æœåŠ¡å™¨æ”¾åœ¨ä¸€ä¸ªç»„ä¸­ï¼Œç„¶åå°†è¯¥ç»„åµŒå¥—åœ¨ä¸€ä¸ªæ›´å¤§çš„ç”Ÿäº§ç¯å¢ƒç»„ä¸­ 12345678910111213141516171819202122232425# å®šä¹‰ä¸€ä¸‹æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯[all_hosts]node1 public_ip=192.168.1.101 ansible_host=192.168.1.101 ansible_user=your_user ansible_ssh_pass=your_password ansible_port=22node2 public_ip=192.168.1.102 ansible_host=192.168.1.102 ansible_user=your_user ansible_ssh_pass=your_password ansible_port=22node3 public_ip=192.168.1.103 ansible_host=192.168.1.103 ansible_user=your_user ansible_ssh_pass=your_password ansible_port=22# å®šä¹‰ä¸€ä¸ª mysql ç»„ï¼Œå‡å¦‚è¦åœ¨ node1 å’Œ node2ä¸Šéƒ¨ç½² mysql[mysql]node1node2# å®šä¹‰ä¸€ä¸ª nginx ç»„ï¼Œå‡å¦‚è¦åœ¨ node1 å’Œ node3ä¸Šéƒ¨ç½² nginx[nginx]node1node3# å‡å¦‚æˆ‘ä»¬è¿˜æƒ³éƒ¨ç½²ä¸€ä¸ª redis ç»„ï¼Œmysql éƒ¨ç½²åœ¨é‚£é‡Œï¼Œredis å°±éƒ¨ç½²åœ¨é‚£é‡Œï¼Œé‡æ–°å†™ä¸€éå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠ redis å½“åš mysql çš„å­é›†# è¿™é‡Œæœ‰ä¸€ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬æ—¢ç„¶ç”¨ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„ç»„å†äº†ï¼Œä¸ºå•¥æä¸ª childrenï¼Œç›´æ¥ç”¨åŸæ¥çš„ç»„ä¸è¡Œå—ï¼Œè¿™é‡Œå¯ä»¥æ˜¯å¯ä»¥ï¼Œä½†æ˜¯ä»æ¨¡å—åˆ’åˆ†æ¥çœ‹ï¼Œåšä¸€ä¸‹åŒºåˆ†æ˜“äºåç»­çš„ç®¡ç†[redis:children]mysql# å®šä¹‰ç»„å˜é‡[atlanta:vars]ntp_server=ntp.atlanta.example.comproxy=proxy.atlanta.example.com ç®€å•ä½¿ç”¨åœ¨æˆ‘ä»¬äº†è§£å®Œ inventory ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹åšä¸€äº›ç®€å•çš„æ¨¡æ‹Ÿ: åœ¨ node1 ä¸Šå®‰è£… ansibleï¼Œä½œä¸ºæ§åˆ¶èŠ‚ç‚¹ï¼Œåœ¨&#x2F;etc&#x2F;ansbile&#x2F;hostsä¸­åŠ å…¥ä¸‰ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ å¦‚æœæ˜¯é€šè¿‡å¯†ç è¿æ¥çš„è¯ï¼Œéœ€è¦åœ¨ ansible_ssh_passä¸­è¾“å…¥æœºå™¨å¯†ç ï¼Œå¦‚æœæ˜¯é€šè¿‡å¯†é’¥é“¾æ¥ï¼Œè¿™é‡Œå¯ä¸å¡«ï¼›é…ç½® ssh å…å¯†ç™»å½•ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œè¿™é‡Œåªéœ€è¦é…ç½® node1 åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„å…å¯†ï¼ˆåŒ…æ‹¬ node1 åˆ° node1 è‡ªå·±ï¼‰ å…å¯†é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸‹ç®€å•çš„æ“ä½œ:12345# æŸ¥çœ‹ mysql ç»„æœºå™¨çš„æ—¶é—´ä¿¡æ¯ansilbe mysql -m shell -a &quot;date&quot;# æŸ¥çœ‹ nginx ç»„æœºå™¨çš„å¯åŠ¨æ—¶é—´ansible nginx -m shell -a &quot;uptime&quot; playbooksplaybookæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªplayç»„æˆçš„åˆ—è¡¨ï¼Œplayçš„ä¸»è¦åŠŸèƒ½åœ¨äºå°†äº‹å…ˆå½’å¹¶ä¸ºä¸€ç»„çš„ä¸»æœºè£…æ‰®æˆäº‹å…ˆé€šè¿‡ansibleä¸­çš„taskå®šä¹‰å¥½çš„è§’è‰²ã€‚ä»æ ¹æœ¬ä¸Šæ¥è®²ï¼Œæ‰€è°“çš„taskæ— éæ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmoduleã€‚å°†å¤šä¸ªplayç»„ç»‡åœ¨ä¸€ä¸ªplaybookä¸­ï¼Œå³å¯ä»¥è®©å®ƒä»¬è”åˆèµ·æ¥æŒ‰äº‹å…ˆç¼–æ’çš„æœºåˆ¶å®ŒæˆæŸä¸€ä»»åŠ¡ playbookè¯­æ³•:12345678910111213141516171819playbookä½¿ç”¨yamlè¯­æ³•æ ¼å¼ï¼Œåç¼€å¯ä»¥æ˜¯yaml,ä¹Ÿå¯ä»¥æ˜¯ymlã€‚åœ¨å•ä¸ªplaybookæ–‡ä»¶ä¸­ï¼Œå¯ä»¥è¿ç»­ä¸‰ä¸ªè¿å­å·(---)åŒºåˆ†å¤šä¸ªplayã€‚è¿˜æœ‰é€‰æ‹©æ€§çš„è¿ç»­ä¸‰ä¸ªç‚¹å¥½(...)ç”¨æ¥è¡¨ç¤ºplayçš„ç»“å°¾ï¼Œä¹Ÿå¯çœç•¥ã€‚æ¬¡è¡Œå¼€å§‹æ­£å¸¸å†™playbookçš„å†…å®¹ï¼Œä¸€èˆ¬éƒ½ä¼šå†™ä¸Šæè¿°è¯¥playbookçš„åŠŸèƒ½ã€‚ä½¿ç”¨#å·æ³¨é‡Šä»£ç ã€‚ç¼©è¿›å¿…é¡»ç»Ÿä¸€ï¼Œä¸èƒ½ç©ºæ ¼å’Œtabæ··ç”¨ã€‚ç¼©è¿›çš„çº§åˆ«ä¹Ÿå¿…é¡»æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„ç¼©è¿›ä»£è¡¨åŒæ ·çš„çº§åˆ«ï¼Œç¨‹åºåˆ¤åˆ«é…ç½®çš„çº§åˆ«æ˜¯é€šè¿‡ç¼©è¿›ç»“åˆæ¢è¡Œå®ç°çš„ã€‚YAMLæ–‡ä»¶å†…å®¹å’ŒLinuxç³»ç»Ÿå¤§å°å†™åˆ¤æ–­æ–¹å¼ä¿æŒä¸€è‡´ï¼Œæ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼Œk/vçš„å€¼å‡éœ€å¤§å°å†™æ•æ„Ÿk/vçš„å€¼å¯åŒè¡Œå†™ä¹Ÿå¯ä»¥æ¢è¡Œå†™ã€‚åŒè¡Œä½¿ç”¨:åˆ†éš”ã€‚vå¯ä»¥æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—åŠŸèƒ½éœ€è¦æœ€å°‘å…ƒç´ åŒ…æ‹¬Â name: task playbookæ ¸å¿ƒå…ƒç´ 1. PlayPlay æ˜¯ Playbook çš„åŸºæœ¬å•å…ƒï¼Œç”¨äºå®šä¹‰åœ¨ä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œçš„ä¸€ç³»åˆ—ä»»åŠ¡ã€‚ä¸€ä¸ª Playbook å¯ä»¥åŒ…å«å¤šä¸ª Playï¼Œæ¯ä¸ª Play åœ¨ä¸åŒçš„ä¸»æœºæˆ–ç»„ä¸Šæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚ å…³é”®å­—ï¼š hosts: æŒ‡å®šè¦åœ¨å“ªäº›ä¸»æœºæˆ–ä¸»æœºç»„ä¸Šæ‰§è¡Œ Playã€‚ tasks: åŒ…å«ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚ vars: å®šä¹‰åœ¨ Play ä¸­ä½¿ç”¨çš„å˜é‡ã€‚ roles: æŒ‡å®šè¦åº”ç”¨çš„è§’è‰²ã€‚ gather_facts: æ§åˆ¶æ˜¯å¦æ”¶é›†ä¸»æœºçš„äº‹å®ä¿¡æ¯ï¼ˆé»˜è®¤ trueï¼‰ã€‚ become: æ˜¯å¦ä½¿ç”¨ sudo æˆ–å…¶ä»–ç‰¹æƒæå‡æ‰§è¡Œä»»åŠ¡ã€‚ 2. TasksTasks æ˜¯ Play ä¸­çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®šä¹‰äº†è¦æ‰§è¡Œçš„å…·ä½“æ“ä½œã€‚æ¯ä¸ª Task é€šå¸¸ä½¿ç”¨ä¸€ä¸ª Ansible æ¨¡å—ï¼Œå¹¶å¯åŒ…å«æ¡ä»¶ã€å¾ªç¯ã€é”™è¯¯å¤„ç†ç­‰ã€‚ å…³é”®å­—ï¼š name: ä»»åŠ¡çš„æè¿°æ€§åç§°ï¼ˆå¯é€‰ï¼Œä½†æ¨èä½¿ç”¨ï¼‰ã€‚ action æˆ–æ¨¡å—åç§°: å…·ä½“æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚ aptã€yumã€copy ç­‰ã€‚ when: å®šä¹‰æ¡ä»¶ï¼Œæ»¡è¶³æ—¶æ‰ä¼šæ‰§è¡Œä»»åŠ¡ã€‚ with_items: ç”¨äºå¾ªç¯æ‰§è¡Œä»»åŠ¡ã€‚ register: ä¿å­˜ä»»åŠ¡çš„ç»“æœåˆ°å˜é‡ã€‚ ignore_errors: å¿½ç•¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ˆè®¾ä¸º yes æ—¶ï¼‰ã€‚ 3. VariablesVariables æ˜¯ Playbook ä¸­çš„åŠ¨æ€å€¼ï¼Œç”¨äºæé«˜å¤ç”¨æ€§å’Œçµæ´»æ€§ã€‚å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹å®šä¹‰å˜é‡ï¼Œå¦‚ varsã€group_varsã€host_varsã€inventory æ–‡ä»¶ï¼Œæˆ–é€šè¿‡å‘½ä»¤è¡Œä¼ é€’ã€‚ å…³é”®å­—ï¼š-\tvars: åœ¨ Play æˆ– Task ä¸­å®šä¹‰å˜é‡ã€‚-\tvars_files: å¼•å…¥å¤–éƒ¨å˜é‡æ–‡ä»¶ã€‚-\tvars_prompt: è¿è¡Œæ—¶æç¤ºç”¨æˆ·è¾“å…¥å˜é‡å€¼ã€‚ 4. HandlersHandlers æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ Taskï¼Œåªä¼šåœ¨è¢«è§¦å‘æ—¶æ‰§è¡Œã€‚é€šå¸¸ç”¨äºåœ¨é…ç½®æ›´æ”¹åæ‰§è¡ŒåŠ¨ä½œï¼Œå¦‚é‡å¯æœåŠ¡ã€‚æ¯”å¦‚æˆ‘è¦ç­‰æœåŠ¡é‡å¯å®Œæ£€æŸ¥ç«¯å£ç›‘å¬ï¼Œå°±å¯ä»¥ç”¨handler å…³é”®å­—ï¼š-\tname: Handler çš„åç§°ã€‚-\tnotify: åœ¨æ™®é€š Task ä¸­è°ƒç”¨ notify è§¦å‘å¯¹åº”çš„ Handlerã€‚ 5. RolesRoles æ˜¯ Playbook ä¸­ç»„ç»‡å’Œå¤ç”¨ä»»åŠ¡ã€å˜é‡ã€æ–‡ä»¶ã€æ¨¡æ¿ç­‰çš„ä¸€ç§æ–¹å¼ã€‚Roles ä½¿å¾— Playbook æ›´åŠ æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ç°åœ¨è¦åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²å„ç§å„æ ·çš„ç»„ä»¶ï¼Œwebserverã€mysqlã€redisã€ng ç­‰ç­‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨è¿™ä¸ªä¸åŒçš„ roles æ¥ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºå››ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«å¯¹åº”èµ·å webserverã€mysqlã€redisã€ngï¼Œç„¶ååœ¨è¿™äº›æ–‡ä»¶å¤¹é‡Œé¢æ·»åŠ æœåŠ¡éƒ¨ç½²æˆ–è€…æ›´æ–°éœ€è¦çš„ä¸œè¥¿ã€‚ è§’è‰²çš„ç›®å½•ç»“æ„ï¼š 12345678910111213my_role/â”œâ”€â”€ tasks/â”‚ â””â”€â”€ main.ymlâ”œâ”€â”€ handlers/â”‚ â””â”€â”€ main.ymlâ”œâ”€â”€ templates/â”œâ”€â”€ files/â”œâ”€â”€ vars/â”‚ â””â”€â”€ main.ymlâ”œâ”€â”€ defaults/â”‚ â””â”€â”€ main.ymlâ””â”€â”€ meta/ â””â”€â”€ main.yml roleså†…å„è‡ªç›®å½•å«ä¹‰ï¼š files\tç”¨æ¥å­˜æ”¾copyæ¨¡å—æˆ–scriptæ¨¡å—è°ƒç”¨çš„æ–‡ä»¶ templates\tç”¨æ¥å­˜æ”¾jinjia2æ¨¡æ¿ï¼Œtemplateæ¨¡å—ä¼šè‡ªåŠ¨åœ¨æ­¤ç›®å½•ä¸­å¯»æ‰¾jinjia2æ¨¡æ¿æ–‡ä»¶ tasks\tæ­¤ç›®å½•åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²çš„ä»»åŠ¡åˆ—è¡¨ï¼Œæ­¤æ–‡ä»¶å¯ä»¥ä½¿ç”¨includeåŒ…å«å…¶å®ƒçš„ä½äºæ­¤ç›®å½•çš„taskæ–‡ä»¶ handlers\tæ­¤ç›®å½•åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ä¸­è§¦å‘æ¡ä»¶æ—¶æ‰§è¡Œçš„åŠ¨ä½œ vars\tæ­¤ç›®å½•åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å˜é‡ defailts\tæ­¤ç›®å½•åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºä¸ºå½“å‰è§’è‰²è®¾å®šé»˜è®¤å˜é‡ meta\tæ­¤ç›®å½•åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²çš„ç‰¹æ®Šè®¾åŠå…¶ä¾èµ–å…³ç³» 6. Includes and ImportsIncludes å’Œ Imports ç”¨äºåœ¨ Playbook ä¸­åŒ…å«å…¶ä»–ä»»åŠ¡ã€å˜é‡ã€æ–‡ä»¶ç­‰ã€‚import_tasks å’Œ include_tasks çš„åŒºåˆ«åœ¨äºï¼Œimport_tasks åœ¨è§£æ Playbook æ—¶æ‰§è¡Œï¼Œè€Œ include_tasks åœ¨è¿è¡Œæ—¶æ‰§è¡Œã€‚ 7. TemplatesTemplates æ˜¯ä½¿ç”¨ Jinja2 æ¨¡æ¿å¼•æ“çš„æ–‡ä»¶ï¼Œç”¨äºåŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶æˆ–å…¶ä»–æ–‡ä»¶ã€‚æ¨¡æ¿é€šå¸¸å­˜æ”¾åœ¨ templates&#x2F; ç›®å½•ä¸‹ï¼Œå¹¶é€šè¿‡ template æ¨¡å—åº”ç”¨åˆ°ç›®æ ‡ä¸»æœº 8. Tagsæ ‡ç­¾æ˜¯ç”¨äºå¯¹ play è¿›è¡Œæ ‡æ³¨ï¼Œå½“ä½ å†™äº†ä¸€ä¸ªå¾ˆé•¿çš„playbookï¼Œå…¶ä¸­æœ‰å¾ˆå¤šçš„ä»»åŠ¡ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¿‡åœ¨å®é™…ä½¿ç”¨è¿™ä¸ªå‰§æœ¬æ—¶ï¼Œä½ å¯èƒ½åªæ˜¯æƒ³è¦æ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ä»»åŠ¡è€Œå·²ï¼Œæˆ–è€…ï¼Œä½ åªæƒ³è¦æ‰§è¡Œå…¶ä¸­ä¸€ç±»ä»»åŠ¡è€Œå·²ï¼Œè€Œå¹¶éæƒ³è¦æ‰§è¡Œæ•´ä¸ªå‰§æœ¬ä¸­çš„å…¨éƒ¨ä»»åŠ¡ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©tagsæ¨¡å—ä¸ºä»»åŠ¡è¿›è¡Œæ‰“æ ‡ç­¾æ“ä½œï¼Œä»»åŠ¡å­˜åœ¨æ ‡ç­¾åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œplaybookæ—¶åˆ©ç”¨æ ‡ç­¾ï¼ŒæŒ‡å®šæ‰§è¡Œå“ªäº›ä»»åŠ¡ï¼Œæˆ–è€…ä¸æ‰§è¡Œå“ªäº›ä»»åŠ¡ æ¯”å¦‚è¯´åœ¨å®é™…çº¿ä¸Šç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æœ‰æ›´æ–°äºŒè¿›åˆ¶åŒ…çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æ›´æ–°äºŒè¿›åˆ¶çš„ç›¸å…³ task ä¸­æ·»åŠ åä¸ºbin çš„ tagsï¼Œæœ‰æ›´æ–°é…ç½®æ–‡ä»¶çš„æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ç›¸å…³çš„ tasks ä¸­æ·»åŠ  conf çš„ tags å®Œæ•´ç¤ºä¾‹æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®‰è£… nginx çš„æ“ä½œæ¥å®Œæ•´æ¼”ç¤ºä¸€ä¸‹: è®¾ç½®é¡¹ç›®ç›®å½•ç»“æ„: 123456789101112131415161718.â”œâ”€â”€ ansible.cfgâ”œâ”€â”€ inventoryâ”œâ”€â”€ playbook.ymlâ””â”€â”€ roles â””â”€â”€ nginx â”œâ”€â”€ tasks â”‚ â”œâ”€â”€ main.yml â”‚ â””â”€â”€ install.yml â”œâ”€â”€ handlers â”‚ â””â”€â”€ main.yml â”œâ”€â”€ templates â”‚ â””â”€â”€ nginx.conf.j2 â”œâ”€â”€ files â”œâ”€â”€ vars â”‚ â””â”€â”€ main.yml â””â”€â”€ defaults â””â”€â”€ main.yml inventoryé…ç½®æ–‡ä»¶ 12[webservers]192.168.1.101 ansible_ssh_user=your_user ansible_ssh_pass=your_password ansible_host=203.0.113.1 playbook.yml: 123456789---- name: Update and Install Nginx hosts: webservers #å¼•ç”¨ç»„ become: yes #å¼€å¯ sudo roles: - role: nginx #è§’è‰²æ˜¯nginxï¼Œå¯¹åº”åˆ° roles/nginx ç›®å½• tags: #ä¸¤ä¸ª tags - bin - conf ä»»åŠ¡æ–‡ä»¶ roles&#x2F;nginx&#x2F;tasks&#x2F;main.yml: 123---# åŒ…å«å…¶ä»–ä»»åŠ¡æ–‡ä»¶, è¿™é‡Œç›´æ¥ç”¨ install.ymlé‡Œé¢çš„æ–‡ä»¶å†…å®¹è‚¯å®šä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™æ ·çš„æ–¹å¼æ›´å¥½çš„è¿›è¡Œç®¡ç†- include_tasks: install.yml å®‰è£…ä»»åŠ¡ roles&#x2F;nginx&#x2F;tasks&#x2F;install.yml: 123456789101112131415161718192021222324252627282930---# æ›´æ–°å®‰è£… Nginx- name: Update apt cache and install Nginx apt: #å®‰è£…nginx ç›¸å…³åŒ…, ä¸åŒå¹³å°ä¸å¤ªä¸€æ ·ï¼Œæ¯”å¦‚ centos å¯ä»¥ä½¿ç”¨ package name: nginx state: latest update_cache: yes tags: - bin #è¿™é‡Œæ·»åŠ äº† bin çš„ tag# éƒ¨ç½² Nginx é…ç½®æ–‡ä»¶- name: Deploy Nginx configuration from template template: #è¿™é‡Œæ˜¯æ›´æ–° nginx é…ç½®æ–‡ä»¶ src: nginx.conf.j2 dest: /etc/nginx/nginx.conf mode: &#x27;0644&#x27; notify: Restart Nginx #è¿™é‡Œé…åˆhandler ä½¿ç”¨ï¼Œhandlers é‡Œé¢ä¼šæœ‰ä¸€ä¸ªåç§°ä¸º â€œRestart Nginxâ€çš„æ“ä½œ tags: - conf #è¿™é‡Œæ·»åŠ äº† conf çš„ tag# æ£€æŸ¥ Nginx æ˜¯å¦ç›‘å¬æ­£ç¡®ç«¯å£- name: Check Nginx is listening on port 80 command: ss -tuln | grep :80 #é€šè¿‡ command æ¨¡å—ï¼Œss å‘½ä»¤ç›‘å¬ 80 ç«¯å£æ˜¯å¦å¯åŠ¨ register: result ignore_errors: yes- name: Print Nginx listening port check result debug: msg: &quot;&#123;&#123; result.stdout &#125;&#125;&quot; when: result.rc == 0 å¤„ç†ç¨‹åº roles&#x2F;nginx&#x2F;handlers&#x2F;main.ymlï¼š 123456---# å½“é…ç½®æ–‡ä»¶å˜æ›´æ—¶ï¼Œé‡å¯ Nginx, å’Œä¸Šé¢çš„ notify æ˜¯å¯¹åº”çš„- name: Restart Nginx service: name: nginx state: restarted æ¨¡æ¿æ–‡ä»¶ roles&#x2F;nginx&#x2F;templates&#x2F;nginx.conf.j2: 1234567891011121314151617server &#123; listen &#123;&#123; nginx_port &#125;&#125;; server_name localhost; location / &#123; root /usr/share/nginx/html; index index.html index.htm; &#125; error_page 404 /404.html; location = /40x.html &#123; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; &#125;&#125; é»˜è®¤å˜é‡ roles&#x2F;nginx&#x2F;defaults&#x2F;main.yml: 12---nginx_port: 80 å½“æˆ‘ä»¬æ›´æ–°å®‰è£…æ—¶,å¯ä»¥é€šè¿‡(åœ¨æ­£å¼æ‰§è¡Œå‰ï¼Œå¯ä»¥åœ¨åé¢åŠ -C -D åšæµ‹è¯•ä½¿ç”¨): 1ansible-playbook playbook.yml åç»­æœ‰äºŒè¿›åˆ¶æ›´æ–°æ—¶ï¼Œå¯ä»¥é€šè¿‡: 1ansible-playbook playbook.yml -t bin åç»­æœ‰é…ç½®æ–‡ä»¶æ›´æ–°æ—¶ï¼Œå¯ä»¥é€šè¿‡: 1ansible-playbook playbook.yml -t conf é€»è¾‘æ§åˆ¶è¯­å¥æ¡ä»¶è¯­å¥whenwhenæ¡ä»¶æ”¯æŒå¤šç§åˆ¤æ–­ç±»å‹ï¼Œä¸»è¦ç”¨äºæ ¹æ®æŸäº›æ¡ä»¶å†³å®šæ˜¯å¦æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚è¿™äº›åˆ¤æ–­ç±»å‹é€šå¸¸åŸºäºPythonçš„è¯­æ³•ï¼Œå› ä¸ºAnsibleçš„ä»»åŠ¡æ˜¯ç”¨Pythonç¼–å†™çš„ ä¸»è¦æ”¯æŒçš„åˆ¤æ–­ç±»å‹: æ¯”è¾ƒè¿ç®—ç¬¦ï¼š&#x3D;&#x3D;, !&#x3D;, &gt;, &lt;, &gt;&#x3D;, &lt;&#x3D; ç”¨äºæ¯”è¾ƒä¸¤ä¸ªå€¼ã€‚ å­—ç¬¦ä¸²æ–¹æ³•ï¼š.startswith(), .endswith(), .find(), .contains() ç­‰å­—ç¬¦ä¸²æ–¹æ³•å¯ä»¥ç”¨æ¥æ£€æŸ¥å­—ç¬¦ä¸²çš„ç‰¹æ€§ã€‚ é€»è¾‘è¿ç®—ç¬¦ï¼šand, or, not ç”¨äºç»„åˆå¤šä¸ªæ¡ä»¶ã€‚ Jinja2æ¨¡æ¿è¡¨è¾¾å¼ï¼šç”±äºAnsibleä½¿ç”¨Jinja2ä½œä¸ºæ¨¡æ¿å¼•æ“ï¼Œå› æ­¤ä½ ä¹Ÿå¯ä»¥åœ¨whenæ¡ä»¶ä¸­ä½¿ç”¨Jinja2çš„è¡¨è¾¾å¼å’Œè¿‡æ»¤å™¨ã€‚ Ansibleäº‹å®ï¼ˆfactsï¼‰å’Œå˜é‡ï¼šä½ å¯ä»¥ä½¿ç”¨Ansibleæ”¶é›†çš„ä¸»æœºäº‹å®ï¼ˆfactsï¼‰å’Œå®šä¹‰çš„å˜é‡æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚ å‡½æ•°å’Œå†…ç½®æ–¹æ³•ï¼šPythonçš„å†…ç½®å‡½æ•°å’Œæ–¹æ³•ä¹Ÿå¯ä»¥åœ¨whenæ¡ä»¶ä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚isinstance(), len(), ç­‰ç­‰ã€‚ æ­£åˆ™è¡¨è¾¾å¼ï¼šä½¿ç”¨Pythonçš„æ­£åˆ™è¡¨è¾¾å¼æ¨¡å—ï¼ˆå¦‚reï¼‰è¿›è¡Œæ›´å¤æ‚çš„å­—ç¬¦ä¸²åŒ¹é…ã€‚ å…¶ä¸­factsæ¶‰åŠåˆ°çš„åˆ¤æ–­æ¡ä»¶éå¸¸å¤šï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å½¢å¼è·å– 123456---- hosts: mysql tasks: - name: show ansible facts debug: var: ansible_facts æ‰§è¡Œä»¥ä¸Šymlæ–‡ä»¶ä¹‹åï¼Œä¼šè¾“å‡ºä¸€ä¸ªjsonä¸²ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„factä¿¡æ¯äº†. ç¤ºä¾‹ï¼šå‡å¦‚æˆ‘ä»¬æƒ³åœ¨ipä¸º 192.168.0.102 çš„æœºå™¨ä¸Šåˆ›å»ºæ–‡ä»¶ 123456789---- name: whenæµ‹è¯•ç»ƒä¹  hosts: webservers tasks: - name: æ–‡ä»¶æµ‹è¯•åˆ›å»º file: path: /tmp/when.txt state: touch when: &quot;&#x27;192.168.0.102&#x27; in ansible_all_ipv4_addresses&quot; å¾ªç¯è¯­å¥loopç”¨äºåœ¨ä»»åŠ¡ä¸­å¾ªç¯æ‰§è¡Œæ“ä½œ ç¤ºä¾‹: 1234567891011121314---- name: Install multiple packages hosts: webservers become: yes tasks: - name: Install packages apt: name: &quot;&#123;&#123; item &#125;&#125;&quot; state: present loop: - nginx - git - curl ä¸Šé¢çš„ç¤ºä¾‹å°±æ˜¯å¾ªç¯è£…åŒ… å—è¯­å¥blockåœ¨ Ansible ä¸­ï¼Œblock å…³é”®å­—å…è®¸ä½ å°†å¤šä¸ªä»»åŠ¡ç»„åˆæˆä¸€ä¸ªé€»è¾‘å—ï¼Œå¹¶å¯¹è¿™ä¸ªå—åº”ç”¨ä¸€äº›æ¡ä»¶æˆ–é”™è¯¯å¤„ç†é€»è¾‘ã€‚è¿™æ˜¯ Ansible 2.5 ç‰ˆæœ¬åŠä»¥åå¼•å…¥çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒæä¾›äº†æ›´é«˜çº§çš„ä»»åŠ¡ç»„ç»‡æ–¹å¼ã€‚ç®€å•æ¥è¯´ï¼Œblockä»»åŠ¡å—å°±æ˜¯ä¸€ç»„é€»è¾‘çš„tasksã€‚ä½¿ç”¨blockå¯ä»¥å°†å¤šä¸ªä»»åŠ¡åˆå¹¶ä¸ºä¸€ä¸ªç»„ã€‚ playbookä¼šå®šä¹‰ä¸‰ç§å—ï¼Œä¸‰ç§å—çš„ä½œç”¨åˆ†åˆ«å¦‚ä¸‹: block: blocké‡Œçš„tasks,å¦‚æœè¿è¡Œæ­£ç¡®,åˆ™ä¸ä¼šè¿è¡Œrescueï¼› rescueï¼šblocké‡Œçš„tasks,å¦‚æœè¿è¡Œå¤±è´¥,æ‰ä¼šè¿è¡Œrescueé‡Œçš„tasks alwaysï¼šblockå’Œrescueé‡Œçš„tasksæ— è®ºæ˜¯å¦è¿è¡ŒæˆåŠŸï¼Œéƒ½ä¼šè¿è¡Œalwaysé‡Œçš„tasks","tags":["ansible","è¿ç»´å·¥å…·"],"categories":["è¿ç»´å·¥å…·"]},{"title":"çº¿ä¸Šæ•…éšœæ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»","path":"/p/çº¿ä¸Šé—®é¢˜æ’æŸ¥æ–¹æ³•æ±‡æ€»/","content":"å‚è€ƒæ–‡æ¡£ Examining Load AverageWhat-is-CPU-Load-AverageBrendan Greggä¸ªäººç½‘ç«™ å†™åœ¨å‰é¢ Linuxæ€§èƒ½è°±å›¾ CPUä½¿ç”¨ç‡é£™å‡ å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡ å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡ å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº perfå‘½ä»¤ jstack ç«ç„°å›¾ è´Ÿè½½é£™å‡ è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½ å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜ çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“ ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“ é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“ è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥ å†…å­˜å ç”¨è¿‡é«˜ å¦‚ä½•åˆ¤æ–­å†…å­˜å ç”¨è¿‡é«˜ å¦‚ä½•å®šä½å†…å­˜å ç”¨é«˜ JAVA å ç”¨å†…å­˜è¿‡é«˜ å †å†…å†…å­˜åˆ†æ æœ¬åœ°å†…å­˜åˆ†æ å…¶ä»–éå †å†…å­˜ golangç¨‹åºå ç”¨å†…å­˜é«˜ åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿå ç”¨ ç£ç›˜é—®é¢˜ ç£ç›˜ç©ºé—´ä¸è¶³ ç£ç›˜IOæ€§èƒ½é—®é¢˜ å†™åœ¨å‰é¢åœ¨å¾ˆå¤šæ–‡ç« ä¸­ï¼Œæ¯å½“æåˆ°å»è§£å†³çº¿ä¸Šé—®é¢˜çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†çš„å¤„ç†æ–¹å¼å°±æ˜¯ç™»å½•ç¯å¢ƒï¼Œå“å“å„ç§æ•²å‘½ä»¤ã€‚æ“ä½œæœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—è¿™ç§åšæ³•å…¶å®æ˜¯æœ¬æœ«å€’ç½®çš„ï¼Œè¿‡äºåœ¨ä¹å»å¿«é€ŸæŠ“ä½é‡ç‚¹é—®é¢˜ï¼Œè€Œå¿½ç•¥äº†ä»å…¨å±€å»çœ‹é—®é¢˜ã€‚é‚£ä¹ˆå¦‚æœæœ€å¼€å§‹ä¸å»æ“ä½œå„ç§å‘½ä»¤ï¼Œé‚£åº”è¯¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ çœ‹ç›‘æ§ï¼ï¼ï¼ï¼ é¦–å…ˆä¸è¦è§‰å¾—è¿™ä¸ªæ˜¯åºŸè¯ï¼Œå¯¹äºå¾ˆå¤šåœºæ™¯æ¥è¯´ï¼Œä¸šåŠ¡è§„æ¨¡æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæœ‰çš„æ—¶å€™å¹¶å‘è¶…è¿‡äº†æé™çš„æ€§èƒ½ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹éƒ½æ²¡æœ‰å¿…è¦å»åå°è¿›è¡Œå„ç§æŸ¥è¯¢ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡å¦‚è¯´æŸå¥—ä¸šåŠ¡ç³»ç»Ÿï¼Œæœ¬èº«åªèƒ½æ”¯æŒ 500 å¹¶å‘ï¼Œç°åœ¨å®é™…ä¸Šçš„é‡åˆ°äº† 2000ï¼Œå¯¼è‡´çº¿ä¸Šå„ç§å†…å­˜ã€CPUã€è´Ÿè½½çš„å‘Šè­¦ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜æœ‰å¿…è¦å»åå°æ•²topã€freeå—ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è€ƒè™‘å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œå¿«é€Ÿçš„æ‰©å®¹ç­‰ã€‚ çœ‹ç›‘æ§çš„æ„ä¹‰åœ¨äºå°½å¯èƒ½çš„æ‰¾åˆ°æ›´å¤šçš„æ€§èƒ½ç“¶é¢ˆæˆ–è€…å¼‚å¸¸çš„ç‚¹ï¼Œä»å…¨å±€å‡ºå‘ï¼Œå¯¹ç³»ç»Ÿå½“å‰å­˜åœ¨çš„é—®é¢˜å’Œå¼‚å¸¸ç‚¹æœ‰å…¨é¢çš„äº†è§£ã€‚ ç›‘æ§ç³»ç»Ÿå¤šç§å¤šæ ·ï¼Œä»è¾ƒæ—©çš„ zabbix åˆ°ç°åœ¨æ¯”è¾ƒæµè¡Œçš„prometheus+grafanaï¼ˆä¸¾ä¸¤ä¸ªå¸¸ç”¨çš„ä¾‹å­ï¼‰ï¼Œå¯¹äºç³»ç»Ÿä¸šåŠ¡éƒ½æœ‰æ¯”è¾ƒå®Œå–„çš„ç›‘æ§ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ å…·ä½“çš„äº†è§£åˆ°ç³»ç»Ÿè¿è¡Œå…¨è²Œã€‚å¦‚æœä½ å¯¹è¿™äº›éƒ½ä¸å–œæ¬¢ï¼Œé‚£ä¹ˆä½ è‡ªå·±å†™ä¸€ä¸ªç›‘æ§ç³»ç»Ÿä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ å½“æˆ‘ä»¬çœ‹å®Œç›‘æ§ä¹‹åï¼ˆå‡è®¾ä½ çœŸçš„çœ‹äº†ï¼‰ï¼Œæ¥ä¸‹æ¥è¿›å…¥å®é™…æ“ä½œç¯èŠ‚ï¼Œæˆ‘ä¼šä»è¿™äº›æŒ‡æ ‡çš„è¯¦ç»†å«ä¹‰å‡ºå‘ï¼Œç„¶åå°½å¯èƒ½åœ°å°†å„ç§å¤„ç†æ–¹å¼åˆ†äº«ç»™å¤§å®¶ã€‚ Linuxæ€§èƒ½è°±å›¾åœ¨åˆ†æé—®é¢˜å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ˜ç¡® Linux æœ‰å“ªäº›æ€§èƒ½åˆ†æå·¥å…·ï¼Œæˆ‘ä»¬å…ˆä¸Šä¸€ä¸‹LINUX æ€§èƒ½ä¸“å®¶ Brendan Gregg æ€»ç»“çš„å›¾ï¼ˆå¤§å®¶å¦‚æœå¯¹æ€§èƒ½åˆ†æç­‰æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è®¤çœŸçœ‹ä¸‹è¿™ä½å¤§ä½¬çš„ä¸ªäººç½‘ç«™ï¼‰: Linux Performance Observability Tool ä¸Šé¢è¿™å¼ å›¾æ˜¯å¼•ç”¨å¤§ä½¬æ–‡ç« çš„å›¾ï¼ŒåŸæ–‡é“¾æ¥åœ¨è¿™é‡Œ: https://www.brendangregg.com/linuxperf.html CPUä½¿ç”¨ç‡é£™å‡å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œåªè¦æœ‰è®¡ç®—ä»»åŠ¡ä¸€ç›´å­˜åœ¨ï¼Œè®© CPU ä¸€ç›´å¤„äºç¹å¿™ä¹‹ä¸­ï¼Œé‚£ä¹ˆ CPU å¿…ç„¶é£™å‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—çš„å·¥å…·å»æ¨¡æ‹Ÿè¿™ä¸ªæƒ…å†µã€‚ github SysStress è¿™æ˜¯æˆ‘è‡ªå·±ç”¨ golang å†™çš„å‹æµ‹å·¥å…·(è¿˜åœ¨å¼€å‘ä¸­ï¼Œå¯ä»¥ç‚¹ä¸ª star è®©æˆ‘æ›´æœ‰åŠ¨åŠ›ğŸ˜‚) ä½¿ç”¨æ–¹æ³•: 1./sysstress cpu --cpu-number 10 --duration 10m è¿™ä¸ªå°±æ˜¯æ¨¡æ‹Ÿå ç”¨ 10 æ ¸å¿ƒçš„ CPU å¹¶æŒç»­ 10minï¼Œå½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„å‹æµ‹å·¥å…·ï¼Œæ¯”å¦‚stress-ng å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œè·Ÿ CPU ä½¿ç”¨ç‡ç›¸å…³çš„æœ‰å“ªäº›æŒ‡æ ‡ã€‚æˆ‘ä»¬é€šè¿‡ top å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„ä¿¡æ¯ top è¿™äº›è¾“å‡ºä¸­æœ‰ä¸€è¡Œæ˜¯ %Cpu(s), è¿™è¡Œå±•ç¤ºäº† CPU çš„æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”çš„å½¢å¼ï¼Œæˆ‘ä»¬è¯¦ç»†é˜è¿°ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰ 12345678us, user : time running un-niced user processes æœªé™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´sy, system : time running kernel processes å†…æ ¸è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´ni, nice : time running niced user processes é™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´id, idle : time spent in the kernel idle handler ç©ºé—²çš„æ—¶é—´wa, IO-wait : time waiting for I/O completion ç­‰å¾… I/O æ“ä½œå®Œæˆæ‰€èŠ±è´¹çš„æ—¶é—´hi : time spent servicing hardware interrupts å¤„ç†ç¡¬ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´si : time spent servicing software interrupts å¤„ç†è½¯ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´st : time stolen from this vm by the hypervisor è¢«è™šæ‹Ÿæœºç®¡ç†ç¨‹åºä»æ­¤è™šæ‹Ÿæœºä¸­çªƒå–çš„æ—¶é—´ åœ¨è¿™äº›æŒ‡æ ‡ä¸­ï¼Œä¸€èˆ¬å…³æ³¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ usã€syã€idã€waï¼ˆå…¶ä»–å‡ ä¸ªæŒ‡æ ‡å¾ˆé«˜çš„æƒ…å†µæˆ‘ä¸ªäººç›®å‰åŸºæœ¬ä¸Šæ²¡æœ‰é‡åˆ°è¿‡ï¼‰ ä¸Šè¿°æŒ‡æ ‡åæ˜ äº†ç³»ç»Ÿæ•´ä½“çš„ CPU æƒ…å†µã€‚è€Œç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­å®é™…ä¸Šæ˜¯ä»¥ä¸€ä¸ªä¸ªçš„è¿›ç¨‹å­˜åœ¨çš„ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•ç¡®å®šåˆ°å ç”¨ CPU é«˜çš„è¿›ç¨‹å‘¢ï¼Ÿè®©æˆ‘ä»¬çš„ç›®å…‰ä» top çš„å¤´éƒ¨ä¿¡æ¯å¾€ä¸‹ç§»åŠ¨ï¼Œä¸‹é¢å°±å±•ç¤ºäº†è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯ è¿™äº›ç¨‹åºé»˜è®¤æ˜¯æŒ‰ç…§ CPU çš„ä½¿ç”¨ç‡ä»é«˜åˆ°åº•è¿›è¡Œæ’åºçš„ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨topçš„æ—¶å€™è¾“å…¥Pè¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ¶ˆè€— CPU èµ„æºçš„è¯¦ç»†è¿›ç¨‹ä¿¡æ¯ ä¸Šé¢æ˜¯æˆ‘é€šè¿‡ ./sysstress cpu --cpu-number 10 --duration 10m å‹æµ‹ç¨‹åºè·‘å‡ºæ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ sysstress ç¨‹åºå ç”¨äº† 1002 çš„ %CPUï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬ä¸Šæ˜¯ 10 ä¸ªæ ¸å¿ƒï¼Œé‚£æˆ‘ä»¬è·‘ä¸€ä¸ªæ›´é«˜çš„ï¼Œå°†--cpu-numberåŠ åˆ° 60 çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ stress-cpu æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¬¡%CPUæ‰“åˆ°äº† 6000ï¼Œé‚£å¾ˆå¤šäººå°±å¥½å¥‡æˆ‘æ—¥å¸¸çš„ç¨‹åºè·‘åˆ°å¤šé«˜ç®—é«˜å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼Œç°åœ¨çš„æœåŠ¡å™¨ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤šæ ¸å¿ƒ CPUï¼ˆ1C2Gè¿™ç§è‡ªå·±ç”¨æ¥ç©çš„å¿½ç•¥ï¼‰ï¼ŒCPU çš„æ ¸å¿ƒæ•°å†³å®šäº†æˆ‘ä»¬ç¨‹åºåœ¨åŒä¸€æ—¶é—´èƒ½å¤Ÿæ‰§è¡Œå¤šå°‘ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé«˜ä¸é«˜æ˜¯ç›¸å¯¹äºæœºå™¨é…ç½®è€Œè¨€çš„ã€‚å¦‚æœä½ çš„æœºå™¨åªæœ‰ 16Cï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 1000ï¼Œé‚£ä¹ˆå…¶å®å·²ç»ç®—æ˜¯æ¯”è¾ƒé«˜äº†ã€‚å¦‚æœæ˜¯ 256C çš„CPUï¼ˆåœŸè±ªçº§é…ç½®ï¼‰ï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 6000ï¼Œå¯¹äºç³»ç»Ÿçš„ç¨³å®šæ€§å½±å“å°±æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚ ä¸Šè¿°æˆ‘ä»¬è¯´çš„æƒ…å†µæ˜¯è¿›ç¨‹å ç”¨ CPU å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œé‚£ä¹ˆè¿›ç¨‹å ç”¨çš„ CPU å¯¹ç³»ç»Ÿçš„å½±å“ä¸å¤§å°±ä»£è¡¨è¿™ä¸ªç¨‹åºä¸€å®šæ²¡æœ‰é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯æœªå¿…çš„ã€‚ æˆ‘ä»¬è¿˜æ˜¯è¦å›å½’åˆ°ä¸šåŠ¡æœ¬èº«ï¼Œå¦‚æœè¿›ç¨‹çš„ CPU å ç”¨åœ¨ä¸šåŠ¡å˜åŠ¨ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿäº†å¼‚å¸¸æ³¢åŠ¨ï¼Œæˆ–è€…æ­£å¸¸æƒ…å†µä¸‹ä¸šåŠ¡ä¸ä¼šæ¶ˆè€—è¿™ä¹ˆé«˜çš„ CPUï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»§ç»­æ’æŸ¥äº†ã€‚ å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æºè¿™ä¸ªé—®é¢˜çš„ æ ¸å¿ƒæ˜¯ CPU ä¸Šåœ¨è¿è¡Œä»€ä¹ˆä¸œè¥¿ã€‚ å¤šæ ¸å¿ƒCPU ä¸‹ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½å¯ä»¥æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šä¸€ä¸ªè¿›ç¨‹ä¸­é‚£äº›æ–¹æ³•åœ¨æ¶ˆè€— CPU å‘¢ï¼Ÿä»è€Œå¼•ç”³ä¸‹é¢è¯¦ç»†çš„é—®é¢˜: ç¨‹åºçš„è°ƒç”¨æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ è°ƒç”¨æ ˆä¿¡æ¯ä¸­å“ªäº›æ˜¯éœ€è¦å…³æ³¨çš„ï¼Œé‚£äº›æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Ÿ çƒ­ç‚¹å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿ è€è¯è¯´å¾—å¥½ï¼Œâ€å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨â€, æˆ‘ä»¬éœ€è¦è¿™äº›ä¸œè¥¿ï¼Œå°±å¿…é¡»äº†è§£åˆ°ä»€ä¹ˆæ ·çš„å·¥å…·å¯ä»¥æ‹¿åˆ°ä¸Šé¢æˆ‘æåˆ°çš„ä¸€äº›ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘å°†é€šè¿‡å¸¸ç”¨çš„åç«¯è¯­è¨€ï¼šgolang å’Œ java ä¸ºä¾‹æ„é€ ä¸€äº›é«˜ CPU çš„ç¨‹åºæ¥è¿›è¡Œå±•ç¤ºã€‚ perfå‘½ä»¤perfæ˜¯ä¸€æ¬¾Linuxæ€§èƒ½åˆ†æå·¥å…·ã€‚Linuxæ€§èƒ½è®¡æ•°å™¨æ˜¯ä¸€ä¸ªæ–°çš„åŸºäºå†…æ ¸çš„å­ç³»ç»Ÿï¼Œå®ƒæä¾›ä¸€ä¸ªæ€§èƒ½åˆ†ææ¡†æ¶ï¼Œæ¯”å¦‚ç¡¬ä»¶ï¼ˆCPUã€PMU(Performance Monitoring Unit)ï¼‰åŠŸèƒ½å’Œè½¯ä»¶(è½¯ä»¶è®¡æ•°å™¨ã€tracepoint)åŠŸèƒ½ã€‚ å®‰è£…: 1yum install perf #Centos å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆçœ‹ä¸‹ perfçš„ç”¨æ³•ï¼Œè¿™é‡Œä¸å±•å¼€å…·ä½“ç”¨æ³•ï¼Œåªåˆ—å‡ºæˆ‘å¹³å¸¸ä½¿ç”¨çš„å‡ ä¸ªå‘½ä»¤: 123top System profiling tool. #å¯¹ç³»ç»Ÿæ€§èƒ½è¿›è¡Œå®æ—¶åˆ†æã€‚record Run a command and record its profile into perf.data #æ”¶é›†é‡‡æ ·ä¿¡æ¯report Read perf.data (created by perf record) and display the profile #åˆ†æé‡‡æ ·ä¿¡æ¯ï¼Œå’Œrecordé…åˆä½¿ç”¨ record å’Œ report çš„ä½¿ç”¨æ›´å¤šåœ¨äº dump å½“å‰ç¯å¢ƒçš„ä¿¡æ¯ç”¨äºåç»­åˆ†æï¼Œå¦‚æœåœ¨è‡ªå·±ç¯å¢ƒä¸Šæµ‹è¯•ï¼Œå¯ä»¥ç”¨ top è¿›è¡Œä¸€äº›ç®€å•çš„å®æ—¶åˆ†æï¼ˆç±»ä¼¼äº top å‘½ä»¤ï¼‰ã€‚ è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‹æµ‹å·¥å…·ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ª 10 æ ¸å¿ƒçš„ 10min çš„å‹æµ‹åœºæ™¯ 1nohup ./sysstress cpu --cpu-number 10 --duration 10m &gt; /dev/null 2&gt;&amp;1 &amp; æ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼Œè®©å‹æµ‹ç¨‹åºåœ¨åå°æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬é€šè¿‡perf topæŸ¥çœ‹å…·ä½“çš„æƒ…å†µï¼ˆå¯ä»¥é€šè¿‡-p æŒ‡å®š pidï¼‰ perf top, ä»æˆªå›¾çš„ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å ç”¨èµ„æºæœ€å¤šçš„ä¸€äº›æ–¹æ³•ï¼ŒåŒ…æ‹¬ sysstress è¿›ç¨‹çš„å„ç§æ–¹æ³•(ä»å›¾ç‰‡ä¸­åŸºæœ¬ä¸Šå°±å¯ä»¥ç¡®å®šé«˜æ¶ˆè€—çš„æ–¹æ³•åœ¨å“ªé‡Œ)ä»¥åŠåº•å±‚çš„ __vdso_clock_gettime, é‚£å†ç»“åˆå‹æµ‹å·¥å…·çš„ä»£ç åˆ†æä¸‹: 12345678910func burnCpu(wg *sync.WaitGroup, start time.Time, durSec int64) &#123;\tdefer wg.Done()\tfor &#123; _ = 1 * 1 now := time.Now() if now.Sub(start) &gt; time.Duration(durSec)*time.Second &#123; break &#125;\t&#125;&#125; è¿™æ˜¯æ–¹æ³•çš„æ ¸å¿ƒï¼Œå…¶å®å°±æ˜¯åšæ— æ„ä¹‰çš„è®¡ç®—ï¼Œå¤–åŠ æ—¶é—´çš„åˆ¤æ–­ï¼Œè¶…è¿‡ duration å°±ç»“æŸã€‚è¿™æ ·å’Œä¸Šé¢çš„ perf top ä¿¡æ¯å°±èƒ½å¯¹åº”èµ·æ¥ã€‚ ç„¶åæˆ‘ä»¬ç”¨ java å†™ä¸€ä¸ªåŒæ ·çš„ç¨‹åºï¼Œå†çœ‹çœ‹ perf topçš„æƒ…å†µ: perf top, ä»è¿™ä¸€å¤§æ®µæ˜¾ç¤ºæ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯çœ‹çš„ä¸€è„¸æ‡µé€¼ï¼Œå¾ˆéš¾å‘ç°åˆ°åº•æ˜¯ä»€ä¹ˆç¨‹åºåœ¨å ç”¨CPU èµ„æºã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æºç¨‹åº: 123456789101112131415161718import java.time.LocalDateTime;public class Main &#123; public static void main(String[] args) &#123; int n = 10; for (int i = 0; i &lt; 10; i++) &#123; new Thread(new Runnable() &#123; public void run() &#123; while (true) &#123; Math.sin(Math.random()); LocalDateTime currentTime = LocalDateTime.now(); &#125; &#125; &#125;).start(); &#125; &#125;&#125; è¿™é‡Œçš„ç¨‹åºä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼Œåšä¸€ä¸ªæ— æ„ä¹‰çš„æ•°å­¦è¿ç®—ï¼Œç„¶åè·å–å½“å‰æ—¶é—´ã€‚ä»è¿™æ®µä»£ç ä¸­æ˜¯ä¸æ˜¯å¾ˆéš¾å’Œä¸Šé¢perf topçš„æ˜¾ç¤ºå…³è”èµ·æ¥ï¼Ÿ åŸå› ä¹Ÿéå¸¸ç®€å•ï¼Œ åƒJava è¿™ç§é€šè¿‡ JVM æ¥è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå †æ ˆç”¨çš„éƒ½æ˜¯ JVM å†…ç½®çš„å‡½æ•°å’Œå †æ ˆç®¡ç†ã€‚æ‰€ä»¥ï¼Œä»ç³»ç»Ÿå±‚é¢åªèƒ½çœ‹åˆ° JVM çš„å‡½æ•°å †æ ˆï¼Œè€Œä¸èƒ½ç›´æ¥å¾—åˆ° Java åº”ç”¨ç¨‹åºçš„å †æ ˆã€‚é‚£æˆ‘ä»¬å¥½èƒ½é€šè¿‡ perf å»çœ‹åˆ° java ç›¸å…³çš„å †æ ˆå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚ å¯ä»¥å€ŸåŠ© perf-map-agent è¿™æ ·çš„å¼€æºå·¥å…·ï¼Œå»ç”Ÿæˆå’Œperf å·¥å…·ä¸€èµ·ä½¿ç”¨çš„æ–¹æ³•æ˜ å°„ï¼Œä½†æ˜¯éœ€è¦åšé¢å¤–çš„ä¸€äº›é…ç½®ã€‚è¿™é‡Œçš„æ–¹æ³•å¤§å®¶å¯ä»¥è‡ªå·±æ¢ç©¶ï¼Œä¸ºä»€ä¹ˆä¸è¯¦ç»†çš„è®²è¿™ä¸ªå‘¢ï¼ŒåŸå› ä¹Ÿç®€å•ï¼Œæ’æŸ¥é—®é¢˜çš„å·¥å…·å¤šç§å¤šæ ·ï¼Œæ²¡å¿…è¦åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»ã€‚ jstackæ—¢ç„¶ perf top å»æŸ¥çœ‹ JAVA çš„è°ƒç”¨æ ˆä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸Š java æä¾›çš„ jstack å·¥å…·å»åˆ†æã€‚ jstack -l pid &gt; xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼ kill -3ï¼Œ jstack ç”¨ä¸äº†çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ kill -3 pid çš„å½¢å¼ï¼Œå †æ ˆä¼šè¾“å‡ºåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ã€‚ å…·ä½“çš„æ“ä½œæ­¥éª¤: top -Hp $pid æ‰¾åˆ°å ç”¨ CPU çš„å…·ä½“çº¿ç¨‹ jstack -l $pid &gt; /tmp/$pid.jstack æˆ–è€… kill -3 $pidå°† java è¿›ç¨‹çš„å †æ ˆæƒ…å†µè¾“å‡ºçš„æ—¥å¿—ä¸­ï¼Œç„¶åæ ¹æ® top -Hp çœ‹åˆ°çš„çº¿ç¨‹ä¿¡æ¯åœ¨è¾“å‡ºçš„å †æ ˆæ—¥å¿—ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ˆtop -Hp è¾“å‡ºçš„æ˜¯ 10 è¿›åˆ¶çš„ idï¼Œjstack è¾“å‡ºçš„æ˜¯ 16 è¿›åˆ¶çš„ï¼Œåœ¨æŸ¥æ‰¾æ—¶æ³¨æ„è¿›åˆ¶è½¬æ¢ï¼‰ æˆ‘ä»¬çœ‹ä¸‹ä¸Šé¢ java ç¨‹åºçš„å †æ ˆçš„ä¿¡æ¯: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151162024-08-16 15:15:40Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.221-b11 mixed mode):&quot;Attach Listener&quot; #35 daemon prio=9 os_prio=0 tid=0x00007f52b4001000 nid=0x71f4 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;DestroyJavaVM&quot; #34 prio=5 os_prio=0 tid=0x00007f53e0009800 nid=0x1693 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;Thread-1&quot; #25 prio=5 os_prio=0 tid=0x00007f53e015a800 nid=0x16d9 runnable [0x00007f52f64e3000] java.lang.Thread.State: RUNNABLE\tat sun.misc.Unsafe.getObjectVolatile(Native Method)\tat java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)\tat java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)\tat java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)\tat java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)\tat java.time.ZoneRegion.ofId(ZoneRegion.java:120)\tat java.time.ZoneId.of(ZoneId.java:411)\tat java.time.ZoneId.of(ZoneId.java:359)\tat java.time.ZoneId.of(ZoneId.java:315)\tat java.util.TimeZone.toZoneId(TimeZone.java:556)\tat java.time.ZoneId.systemDefault(ZoneId.java:274)\tat java.time.Clock.systemDefaultZone(Clock.java:178)\tat java.time.LocalDateTime.now(LocalDateTime.java:180)\tat Main$1.run(Main.java:12)\tat java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers:\t- None&quot;Thread-0&quot; #24 prio=5 os_prio=0 tid=0x00007f53e0159000 nid=0x16d8 runnable [0x00007f52f65e4000] java.lang.Thread.State: RUNNABLE\tat sun.misc.Unsafe.getObjectVolatile(Native Method)\tat java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)\tat java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)\tat java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)\tat java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)\tat java.time.ZoneRegion.ofId(ZoneRegion.java:120)\tat java.time.ZoneId.of(ZoneId.java:411)\tat java.time.ZoneId.of(ZoneId.java:359)\tat java.time.ZoneId.of(ZoneId.java:315)\tat java.util.TimeZone.toZoneId(TimeZone.java:556)\tat java.time.ZoneId.systemDefault(ZoneId.java:274)\tat java.time.Clock.systemDefaultZone(Clock.java:178)\tat java.time.LocalDateTime.now(LocalDateTime.java:180)\tat Main$1.run(Main.java:12)\tat java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers:\t- None --- 10 ä¸ª thread&quot;Service Thread&quot; #23 daemon prio=9 os_prio=0 tid=0x00007f53e0143800 nid=0x16d6 runnable [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;C2 CompilerThread1&quot; #6 daemon prio=9 os_prio=0 tid=0x00007f53e010e000 nid=0x16c5 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None --- ä¸€å¤§å † C2 CompilerThread&quot;C2 CompilerThread0&quot; #5 daemon prio=9 os_prio=0 tid=0x00007f53e010b000 nid=0x16c4 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f53e0109800 nid=0x16c3 runnable [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;Finalizer&quot; #3 daemon prio=8 os_prio=0 tid=0x00007f53e00d8800 nid=0x16c2 in Object.wait() [0x00007f52f7bfa000] java.lang.Thread.State: WAITING (on object monitor)\tat java.lang.Object.wait(Native Method)\t- waiting on &lt;0x000000008021a5e8&gt; (a java.lang.ref.ReferenceQueue$Lock)\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)\t- locked &lt;0x000000008021a5e8&gt; (a java.lang.ref.ReferenceQueue$Lock)\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)\tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216) Locked ownable synchronizers:\t- None&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=0 tid=0x00007f53e00d3800 nid=0x16c1 in Object.wait() [0x00007f52f7cfb000] java.lang.Thread.State: WAITING (on object monitor)\tat java.lang.Object.wait(Native Method)\t- waiting on &lt;0x0000000080218d38&gt; (a java.lang.ref.Reference$Lock)\tat java.lang.Object.wait(Object.java:502)\tat java.lang.ref.Reference.tryHandlePending(Reference.java:191)\t- locked &lt;0x0000000080218d38&gt; (a java.lang.ref.Reference$Lock)\tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153) Locked ownable synchronizers:\t- None&quot;VM Thread&quot; os_prio=0 tid=0x00007f53e00ca000 nid=0x16c0 runnable&quot;GC task thread#0 (ParallelGC)&quot; os_prio=0 tid=0x00007f53e001f000 nid=0x1694 runnable--- ä¸€å¤§å † GC task thread&quot;VM Periodic Task Thread&quot; os_prio=0 tid=0x00007f53e0146000 nid=0x16d7 waiting on conditionJNI global references: 202 æˆ‘ä»¬é€šè¿‡ top -Hp çš„ä¿¡æ¯å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ° Thread-[0-9] è¿™å‡ ä¸ªçº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆéƒ½æ˜¯ java.time.LocalDateTime.now, ä¹Ÿè¯´æ˜äº†è¿™ä¸ªæ–¹æ³•åœ¨ä¸åœæ¶ˆè€— CPUã€‚ï¼ˆä½†æ˜¯ jstack åªèƒ½æ•è·çŸ­æ—¶é—´æˆ–è€…ç¬æ—¶çš„å †æ ˆä¿¡æ¯ï¼Œæ²¡æ³•å¤„ç†é•¿æ—¶é—´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–æ—¶å¯ä»¥å¤šæ‰“å°å‡ æ¬¡æˆ–è€…ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰ è‡³äº jstack çš„è¯¦ç»†ç”¨æ³•ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšå®¢ï¼šjavaé—®é¢˜å®šä½ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰éå¸¸å¤šçš„åˆ†æå·¥å…·ï¼Œpstack\\gstack\\strace\\gdbç­‰ç­‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæ¢ç´¢ä½¿ç”¨ ç«ç„°å›¾ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ“ä½œçš„å‘½ä»¤å’Œæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒç›´è§‚çš„æ–¹å¼èƒ½å¤Ÿç›´æ¥çœ‹åˆ°å„ç§æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶æ¯”é‡ç­‰æƒ…å†µå‘¢ï¼Ÿç«ç„°å›¾å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µè€Œç”Ÿçš„ã€‚ ç«ç„°å›¾çš„åˆ†ç±»æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„åŒ…æ‹¬: CPU ç«ç„°å›¾ (CPU Flame Graph) æè¿°ï¼šå±•ç¤º CPU åœ¨ä¸åŒæ–¹æ³•ä¸Šçš„æ¶ˆè€—æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨æ‰€å ç”¨çš„ CPU æ—¶é—´ã€‚ ç”¨é€”ï¼šç”¨äºåˆ†æ CPU æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å“ªäº›æ–¹æ³•æ¶ˆè€—äº†æœ€å¤šçš„ CPU èµ„æºã€‚ åº”ç”¨ï¼šJavaã€C++ ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€çš„æ€§èƒ½åˆ†æã€‚ å†…å­˜ç«ç„°å›¾ (Memory Flame Graph) æè¿°ï¼šå±•ç¤ºå†…å­˜åˆ†é…æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨åˆ†é…çš„å†…å­˜é‡ã€‚ ç”¨é€”ï¼šç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼ã€è¿‡åº¦å†…å­˜åˆ†é…é—®é¢˜ï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚ åº”ç”¨ï¼šå¸¸ç”¨äºåˆ†æå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¦‚ Java åº”ç”¨çš„å †å†…å­˜åˆ†æã€‚ I&#x2F;O ç«ç„°å›¾ (I&#x2F;O Flame Graph) æè¿°ï¼šå±•ç¤º I&#x2F;O æ“ä½œçš„è€—æ—¶æƒ…å†µï¼Œæ˜¾ç¤ºä¸åŒæ–¹æ³•çš„ I&#x2F;O æ“ä½œå ç”¨çš„æ—¶é—´ã€‚ ç”¨é€”ï¼šç”¨äºåˆ†æåº”ç”¨ç¨‹åºçš„ I&#x2F;O æ€§èƒ½ï¼Œè¯†åˆ«æ…¢é€Ÿæˆ–é¢‘ç¹çš„ I&#x2F;O æ“ä½œã€‚ åº”ç”¨ï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯çš„æ€§èƒ½è°ƒä¼˜ã€‚ æˆ‘ä»¬è¿™é‡Œé€šè¿‡ async-profiler å¯¹æ–‡ç« ä¸Šé¢çš„javaå‹æµ‹ç¨‹åºè¿›è¡ŒæŠ“å–(è¿™ä¸ªå·¥å…·åªèƒ½æŠ“ java çš„, å¯¹äº golang ç¨‹åºï¼Œå¯ä»¥åˆ©ç”¨ golang æä¾›çš„ pprof) 123tar -xzf async-profiler-3.0-linux-x64.tar.gzcd async-profiler-3.0-linux-x64/bin./asprof -d 60 pid -f /tmp/javastress.html æˆ‘ä»¬ç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ html æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç«ç„°å›¾ä¿¡æ¯ï¼ˆå¯ä»¥åœ¨ç½‘é¡µè¿›è¡Œç‚¹å‡»ï¼ŒæŸ¥çœ‹æ›´ç»†èŠ‚çš„æ–¹æ³•ï¼‰ java ç¨‹åºçš„ç«ç„°å›¾, è¿™æ ·çœ‹èµ·æ¥å°±æ¯” jstackè¿™äº›ä¿¡æ¯æ›´åŠ ç›´è§‚ä¸€ç‚¹ã€‚ è´Ÿè½½é£™å‡è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½æˆ‘ä»¬å…ˆçœ‹ä¸‹ç³»ç»Ÿè´Ÿè½½çš„å®˜æ–¹æè¿°: 1System load averages is the average number of processes that are either in a runnable or uninterruptable state. A process in arunnable state is either using the CPU or waiting to use the CPU. A process in uninterruptable state is waiting for some I/O access,eg waiting for disk. The averages are taken over the three time intervals. Load averages are not normalized for the number of CPUs ina system, so a load average of 1 means a single CPU system is loaded all the time while on a 4 CPU system it means it was idle 75% of the time. ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼è¡¨ç¤ºå¤„äºå¯è¿è¡Œæˆ–ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹çš„å¹³å‡æ•°é‡ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹è¦ä¹ˆæ­£åœ¨ä½¿ç”¨ CPUï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…ä½¿ç”¨ CPUã€‚å¤„äºä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸäº› I&#x2F;O è®¿é—®ï¼Œä¾‹å¦‚ç­‰å¾…ç£ç›˜ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯ loadavg è¿™ä¸ªæ•°å€¼ä½“ç°äº†æŸäº›ç‰¹å®šçŠ¶æ€è¿›ç¨‹çš„æ•°é‡ã€‚ é‚£å¼•ç”³å‡ºä¸¤ä¸ªé—®é¢˜: è¿›ç¨‹çš„çŠ¶æ€æœ‰å“ªäº›ï¼Ÿ å¦‚ä½•åœ¨ Linux ä¸ŠæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ å¯è¿è¡Œå’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆ æŸ¥çœ‹çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ps å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¯”å¦‚é€šè¿‡ps -auxf, æˆ‘ä¹ˆå¯ä»¥çœ‹åˆ°æœ‰ä¸€åˆ—ä¸º STAT,è¿™åˆ—å°±ä»£è¡¨è¯¥è¿›ç¨‹çš„çŠ¶æ€: è¿›ç¨‹çŠ¶æ€ è¿›ç¨‹çš„çŠ¶æ€å’Œå…·ä½“å«ä¹‰: D uninterruptible sleep (usually IO) R running or runnable (on run queue) S interruptible sleep (waiting for an event to complete) T stopped by job control signal t stopped by debugger during the tracing W paging (not valid since the 2.6.xx kernel) X dead (should never be seen) Z defunct (â€œzombieâ€) process, terminated but not reaped by its parent è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å¤„äºä¸å¯ä¸­æ–­çš„çŠ¶æ€çš„è¿›ç¨‹å’Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åˆ†åˆ«ä¸º D å’Œ R,æ¢ä¸ªè¯´æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´é€ æˆè´Ÿè½½å‡é«˜çš„åŸå› ä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªçŠ¶æ€çš„è¿›ç¨‹å¼•èµ·çš„ã€‚ ï¼ˆæ’ä¸ªé¢˜å¤–è¯ï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼ŒX çŠ¶æ€çš„è¿›ç¨‹åº”è¯¥æ˜¯ä¸åº”è¯¥è¢«çœ‹åˆ°çš„ï¼Œ ä½†æ˜¯ä¹‹å‰åœ¨è…¾è®¯äº‘åšESçš„æ—¶å€™ï¼Œå¶ç„¶é—´ç¢°åˆ°äº†ä¸€æ¬¡ï¼Œå½“æ—¶è¿˜æˆªäº†ä¸ªå›¾ç”¨åšç•™å¿µğŸ˜‚ï¼Œä½†æ˜¯æ²¡æœ‰æ•è·åˆ°å…·ä½“çš„ä¿¡æ¯ï¼‰ è´Ÿè½½çš„æŒ‡æ ‡å¯ä»¥é€šè¿‡ top ä»¥åŠ uptime æŒ‡ä»¤è·å– 123:35:00 up 1 day, 46 min, 1 user, load average: 49.16, 18.35, 7.87 è¿™é‡Œå±•ç¤ºäº† loadavg çš„ä¸‰ä¸ªæ•°å€¼: åˆ†åˆ«ä»£è¡¨çš„å«ä¹‰æ˜¯ 1minã€5minã€15min çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½ é‚£æˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿçš„è´Ÿè½½æ˜¯é«˜æ˜¯ä½å‘¢ï¼Ÿ è¿™é‡Œä¸€èˆ¬æœ‰ä¸ªç»éªŒå€¼ï¼Œæˆ‘ä»¬ä¸€èˆ¬å’Œ CPU å’Œæ ¸å¿ƒæ•°è¿›è¡Œå¯¹æ¯”ï¼Œä¸€èˆ¬è´Ÿè½½åœ¨ CPU æ ¸å¿ƒçš„ 70% å·¦å³ä»¥åŠä»¥ä¸‹ï¼Œå¯¹ç³»ç»Ÿä¸€èˆ¬æ²¡ä»€ä¹ˆå½±å“ï¼Œè¶…è¿‡ 70%ï¼Œç³»ç»Ÿå¯èƒ½æ”¶åˆ°å½±å“ã€‚ä½†æ˜¯è¿™é‡Œè¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œè´Ÿè½½çš„æ¯”ä¾‹åœ¨ 70% ä»¥ä¸‹æ—¶ä¸ä¸€å®šä»£è¡¨ç³»ç»Ÿå°±æ²¡é—®é¢˜ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿä¸ŠåŸºæœ¬ä¸Šæ²¡æœ‰ä¸šåŠ¡åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè´Ÿè½½åŸºæœ¬ä¸Šå°±åœ¨é›¶ç‚¹å‡ å·¦å³ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œè´Ÿè½½æœ‰å‡é«˜ä¸ä¸€å®šæ˜¯åˆç†çš„ï¼ˆåé¢ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼‰ å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“æ—¢ç„¶è¯´æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¼šå¼•èµ·è´Ÿè½½çš„å˜åŒ–ï¼Œé‚£ä¹ˆè·‘ä¸€äº›ç¨‹åºï¼Œè®©ç¨‹åºä¸åœè¿è¡Œï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶å°±èƒ½æ„é€ å‡ºæŒç»­è¿è¡Œçš„è¿›ç¨‹äº†ã€‚æˆ‘è¿™é‡Œæ‰¾äº†ä¸‰å°æœºå™¨(64C)ï¼Œç”¨æˆ‘çš„å‹æµ‹å·¥å…·å…ˆè·‘ä¸€äº›çº¯ CPU çš„è¿ç®—ï¼Œç„¶åè§‚å¯Ÿä¸‹æ•ˆæœï¼š æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹: 10 å¹¶å‘ 30min nohup ./sysstress cpu --cpu-number 10 --duration 30m &gt; /dev/null 2&gt;&amp;1 30 å¹¶å‘ 30min nohup ./sysstress cpu --cpu-number 30 --duration 30m &gt; /dev/null 2&gt;&amp;1 60 å¹¶å‘ 30min nohup ./sysstress cpu --cpu-number 60 --duration 30m &gt; /dev/null 2&gt;&amp;1 æ•ˆæœå¦‚ä¸‹: 10å¹¶å‘è´Ÿè½½, 30å¹¶å‘è´Ÿè½½, 60å¹¶å‘è´Ÿè½½, ä»ä¸Šè¿°æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨çº¯è¿ç®—è¿™ç§åœºæ™¯ä¸‹ï¼Œå¹¶å‘çš„é‡åŸºæœ¬ä¸Šå’Œè´Ÿè½½æ˜¯å¯¹åº”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´éšç€ CPUçš„ä½¿ç”¨é‡ ä¸Šæ¶¨ï¼Œè´Ÿè½½ä¹Ÿä¼šä¸æ–­å˜é«˜ã€‚ ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“åœ¨åˆšæ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†çº¯è¿ç®—å¯¹è´Ÿè½½çš„å½±å“ï¼ˆR è¿›ç¨‹çš„ä»£è¡¨ï¼‰ï¼Œç„¶ååœ¨å…³äº D è¿›ç¨‹çš„è¯´æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„è¯´æ˜ (usually IO) ,å³é€šå¸¸æ˜¯ IO å¼•èµ·çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ç£ç›˜ IO æ¥æµ‹è¯•ä¸€ä¸‹ æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹: 10 å¹¶å‘ 15min nohup ./sysstress io --operation read --filepath test.access.log -p 10 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp; 30 å¹¶å‘ 15min nohup ./sysstress io --operation read --filepath test.access.log -p 30 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp; 60 å¹¶å‘ 15min nohup ./sysstress io --operation read --filepath test.access.log -p 60 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp; æ•ˆæœå¦‚ä¸‹: 10å¹¶å‘è´Ÿè½½ 30å¹¶å‘è´Ÿè½½ 60å¹¶å‘è´Ÿè½½ æˆ‘ä»¬ä¹Ÿé¡ºä¾¿çœ‹ä¸€ä¸‹ï¼Œ60 å¹¶å‘ä¸‹ CPU çš„æƒ…å†µ: 60å¹¶å‘ç³»ç»Ÿæ•´ä½“æƒ…å†µ è¿™é‡Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç³»ç»Ÿçš„ CPU åŸºæœ¬ä¸Šå·²ç»è·‘æ»¡äº†ã€‚us å’Œ sy éƒ½å çš„æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ç§è¯»å–éå¸¸æœ‰å¯èƒ½èµ°åˆ°ç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬æƒ³æµ‹ç»•è¿‡ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡ DIRECT çš„æ–¹å¼ã€‚ ä½†æ˜¯ä¸Šé¢çš„ä¾‹å­å…¶å®ä¹Ÿè¯æ˜äº†ä¸€ä»¶äº‹ï¼ŒIO çš„æ“ä½œä¹Ÿæ˜¯ä¼šå¯¼è‡´è´Ÿè½½äº§ç”Ÿé£™å‡ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç£ç›˜IO å’Œ CPU æ“ä½œéƒ½ä¼šå¯¼è‡´ç³»ç»Ÿè´Ÿè½½é£™å‡ï¼Œé‚£ä¹ˆè´Ÿè½½é£™å‡ä¸€å®šä¼šæ˜¯è¿™ä¸¤ä¸ªåŸå› å—ï¼Ÿç­”æ¡ˆä¹Ÿæ˜¯æœªå¿…çš„ï¼Œå› ä¸ºä¸Šè¿°æˆ‘ä»¬æ›¾ç»æåˆ°è¿‡ D çŠ¶æ€çš„è¿›ç¨‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¥½åƒè¿˜æ²¡ä»‹ç»è¿‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç»§ç»­æ¨¡æ‹Ÿï¼Œæ—¢ç„¶ D çŠ¶æ€çš„è¿›ç¨‹æ˜¯ IO æ“ä½œå¼•èµ·çš„ï¼Œæ™®é€šçš„ç£ç›˜è¯»å†™ IO å¾ˆéš¾æ¨¡æ‹Ÿï¼Œé‚£æˆ‘ä»¬å°±æ¢ä¸ª IO åœºæ™¯ç»§ç»­æ¨¡æ‹Ÿ â€“ ç½‘ç»œ IOã€‚ é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“è¿™é‡Œç›´æ¥ä¸Šä¸€ä¸ªæ¨¡æ‹Ÿæ–¹æ³•: A æœºå™¨å¼€å¯ NFS Server B æœºå™¨ä½œä¸ºå®¢æˆ·ç«¯è¿›è¡ŒæŒ‚è½½ æ–­å¼€ç½‘ç»œ ç–¯ç‹‚ df -h è¯¦ç»†çš„æ“ä½œæ­¥éª¤: 1234567891011121314151617181920212223242526# å®‰è£… Centossudo yum install nfs-utils# æœåŠ¡ç«¯é…ç½®sudo mkdir -p /mnt/nfs_sharesudo chown nobody:nogroup /mnt/nfs_sharesudo chmod 755 /mnt/nfs_share## æ‰“å¼€ /etc/exports é…ç½®ï¼Œæ·»åŠ ä¸€è¡Œæ¥å®šä¹‰å…±äº«ç›®å½•åŠå…¶æƒé™ã€‚ä¾‹å¦‚ï¼Œå°† /mnt/nfs_share å…±äº«ç»™ç½‘ç»œ 192.168.1.0/24ï¼Œå¹¶æä¾›è¯»å†™æƒé™ï¼š/mnt/nfs_share 192.168.1.0/24(rw,sync,no_subtree_check)## å¯åŠ¨ NFSsudo exportfs -asudo systemctl restart nfs-kernel-serversudo systemctl enable nfs-kernel-server# å®¢æˆ·ç«¯é…ç½®sudo mkdir -p /mnt/nfs_clientsudo mount -t nfs 192.168.1.100(server ip):/mnt/nfs_share /mnt/nfs_client## éªŒè¯df -h /mnt/nfs_client# æ–­ç½‘æ¨¡æ‹Ÿ(å®¢æˆ·ç«¯)iptables -I INPUT -s serverip -j DROP# æŒç»­(ç–¯ç‹‚)æ‰§è¡Œï¼šdu -sh /mnt/nfs_client å› ä¸ºç½‘ç»œå·²ç»æ–­æ‰ï¼Œæ‰€ä»¥du -sh /mnt/nfs_client,è€Œä¸”è¿™ä¸ªç¨‹åºæ²¡æœ‰è‡ªåŠ¨é€€å‡ºæˆ–è€…æŠ¥é”™ï¼Œè¿™æ ·å°±å¯¼è‡´ç¨‹åºæ— æ³•é¡ºåˆ©æ‰§è¡Œä¸‹å»ï¼Œç»§è€Œé˜»å¡ä½å°±å˜æˆäº† D çŠ¶æ€çš„è¿›ç¨‹ã€‚ åŸºäºè¿™ç§æ¨¡æ‹Ÿæ–¹æ³•å¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ä¸‹ï¼Œç¬”è€…ä¹‹å‰åšè¿‡ä¸€ä¸ªåœºæ™¯ï¼Œå°†ä¸€ä¸ªä¸¤æ ¸å¿ƒçš„ CPUè´Ÿè½½å¹²åˆ°äº† 200 å¤šï¼Œä½†æ˜¯å› ä¸ºè¿™ç§æƒ…å†µä¸‹æ›´å¤šæ˜¯é˜»å¡åœ¨ç½‘ç»œä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶çš„è´Ÿè½½è™½é«˜ï¼Œå¹¶ä¸ä¸€å®šå½±å“ç³»ç»Ÿè¿è¡Œã€‚ å½“ç„¶è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼Œç¬”è€…æ›¾ç»ä¹Ÿå› ä¸ºè§è¿‡ ping æ“ä½œé˜»å¡å¯¼è‡´çš„è´Ÿè½½é£™å‡ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯æ˜¯å¤šç§å¤šæ ·çš„ğŸ˜‚ï¼Œå¤§å®¶æœ‰æ›´å¤šçš„ä¾‹å­ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚ è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥åŸºäºä¸Šé¢çš„ä¾‹å­å’Œåœºæ™¯æ¨¡æ‹Ÿï¼Œæˆ‘ä»¬å…¶å®åº”è¯¥å·²ç»æœ‰ä¸€å¥—åŸºæœ¬çš„æ’æŸ¥æ–¹æ³•äº†ï¼Œä¸‹é¢è¿™å¼ å›¾æ˜¯æˆ‘ä¸ªäººçš„ä¸€äº›æ€»ç»“(å›¾è¿˜ä¼šä¸æ–­å®Œå–„) è´Ÿè½½é«˜æ’æŸ¥å¯¼å›¾ å†…å­˜å ç”¨è¿‡é«˜æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æœ‰å“ªäº›å¸¸ç”¨çš„å†…å­˜æ€§èƒ½å·¥å…·: å·¥å…· åŠŸèƒ½ ç”¨æ³• å¸¸ç”¨é€‰é¡¹ free æ˜¾ç¤ºç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨æƒ…å†µ free -h -hï¼šä»¥äººç±»å¯è¯»çš„æ ¼å¼æ˜¾ç¤º top å®æ—¶æ˜¾ç¤ºç³»ç»Ÿçš„è¿›ç¨‹å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ top æ—  htop æä¾›æ›´å‹å¥½çš„ç”¨æˆ·ç•Œé¢çš„è¿›ç¨‹ç›‘æ§å·¥å…· htop æ—  vmstat æŠ¥å‘Šè™šæ‹Ÿå†…å­˜ã€è¿›ç¨‹ã€CPU æ´»åŠ¨ç­‰ç»Ÿè®¡ä¿¡æ¯ vmstat 1 1ï¼šæ¯ç§’æ›´æ–°ä¸€æ¬¡æ•°æ® ps æŸ¥çœ‹ç³»ç»Ÿä¸­è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ ps aux --sort=-%mem auxï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è¿›ç¨‹ï¼Œ --sort=-%memï¼šæŒ‰å†…å­˜ä½¿ç”¨é‡é™åºæ’åˆ— pmap æ˜¾ç¤ºè¿›ç¨‹çš„å†…å­˜æ˜ å°„ pmap -x &lt;pid&gt; -xï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ smem æä¾›è¯¦ç»†çš„å†…å­˜ä½¿ç”¨æŠ¥å‘Š smem -r æ—  /proc æä¾›ç³»ç»Ÿå’Œè¿›ç¨‹çš„è¯¦ç»†å†…å­˜ä¿¡æ¯ cat /proc/meminfocat /proc/&lt;pid&gt;/status æ—  å¦‚ä½•åˆ¤æ–­å†…å­˜å ç”¨è¿‡é«˜ç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µå¯ä»¥é€šè¿‡ top ä»¥åŠ free å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œä»¥ free -mä¸ºä¾‹: freeæŸ¥çœ‹å†…å­˜ä¿¡æ¯ å­—æ®µè¯´æ˜ï¼š total: ç³»ç»Ÿæ€»å†…å­˜ï¼ˆRAMï¼‰æˆ–äº¤æ¢ç©ºé—´ï¼ˆSwapï¼‰çš„æ€»é‡ã€‚ used: å·²ç”¨å†…å­˜æˆ–äº¤æ¢ç©ºé—´çš„é‡ã€‚è¿™åŒ…æ‹¬æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä»¥åŠç³»ç»Ÿç¼“å­˜ï¼ˆå¯¹äºå†…å­˜ï¼‰æˆ–å·²ç»ä½¿ç”¨çš„äº¤æ¢ç©ºé—´ã€‚ free: ç©ºé—²çš„å†…å­˜æˆ–äº¤æ¢ç©ºé—´çš„é‡ã€‚è¡¨ç¤ºå½“å‰æœªè¢«ä»»ä½•è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜æˆ–äº¤æ¢ç©ºé—´ã€‚ shared: è¢«å¤šä¸ªè¿›ç¨‹å…±äº«çš„å†…å­˜é‡ï¼ˆå¯¹äºå†…å­˜ï¼‰ã€‚é€šå¸¸æ˜¯å…±äº«åº“å’Œè¿›ç¨‹é—´é€šä¿¡çš„å†…å­˜ã€‚ buff&#x2F;cache: ç”¨ä½œæ–‡ä»¶ç³»ç»Ÿç¼“å­˜å’Œç¼“å†²åŒºçš„å†…å­˜é‡ã€‚è¿™åŒ…æ‹¬ç¼“å­˜çš„æ–‡ä»¶æ•°æ®ï¼ˆcacheï¼‰å’Œç¼“å†²åŒºï¼ˆbuffï¼‰ã€‚è¿™äº›å†…å­˜å¯ä»¥è¢«ç³»ç»Ÿç”¨ä½œå…¶ä»–ç”¨é€”ã€‚ available: å¯ä»¥åˆ†é…ç»™æ–°å¯åŠ¨çš„åº”ç”¨ç¨‹åºçš„å†…å­˜é‡ï¼Œè€Œä¸éœ€è¦äº¤æ¢åˆ°ç£ç›˜ã€‚è¿™ä¸ªæ•°å­—æ›´èƒ½åæ˜ ç³»ç»Ÿçš„å®é™…å¯ç”¨å†…å­˜ è¿™é‡Œæˆ‘ä»¬éœ€è¦å…³æ³¨ä¸‹ï¼Œä¸€èˆ¬å¯ç”¨å†…å­˜æˆ‘ä»¬å°±æ˜¯ä»¥ avaible ä¸ºå‡†ã€‚å½“ avaible çš„æŒ‡æ ‡è¶Šæ¥è¶Šå°æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å…³æ³¨ç³»ç»Ÿå†…å­˜çš„æ•´ä½“ä½¿ç”¨æƒ…å†µã€‚ è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ï¼šSwapï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¯¦ç»†ä»‹ç»: 123456Swap space in Linux is used when the amount of physical memory (RAM) is full. If the system needs more memory resources and the RAM is full, inactive pages in memory are moved to the swap space. While swap space can help machines with a small amount of RAM, it should not be considered a replacement for more RAM. Swap space is located on hard drives, which have a slower access time than physical memory.Swap space can be a dedicated swap partition (recommended), a swap file, or a combination of swap partitions and swap files. SWAPæ„æ€æ˜¯äº¤æ¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå½“æŸè¿›ç¨‹å‘OSè¯·æ±‚å†…å­˜å‘ç°ä¸è¶³æ—¶ï¼ŒOSä¼šæŠŠå†…å­˜ä¸­æš‚æ—¶ä¸ç”¨çš„æ•°æ®äº¤æ¢å‡ºå»ï¼Œæ”¾åœ¨SWAPåˆ†åŒºä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºSWAP OUTã€‚å½“æŸè¿›ç¨‹åˆéœ€è¦è¿™äº›æ•°æ®ä¸”OSå‘ç°è¿˜æœ‰ç©ºé—²ç‰©ç†å†…å­˜æ—¶ï¼Œåˆä¼šæŠŠSWAPåˆ†åŒºä¸­çš„æ•°æ®äº¤æ¢å›ç‰©ç†å†…å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºSWAP INã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼ŒæŠŠç£ç›˜ç©ºé—´å½“ä½œ swap åˆ†åŒºï¼Œè§£å†³å®¹é‡ä¸è¶³çš„é—®é¢˜ã€‚ è¿™é‡Œæˆ‘ä»¬å…¶å®ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œç‰©ç†å†…å­˜çš„è¯»å†™æ€§èƒ½è‚¯å®šè¦æ¯”ç£ç›˜å¼ºä¸å°‘ï¼Œä½¿ç”¨äº†ç£ç›˜ç©ºé—´ä½œä¸ºå†…å­˜å­˜å‚¨ï¼Œæœ¬èº«è¯»å†™çš„æ€§èƒ½å°±ä¸é«˜ï¼Œè¿˜æ¶‰åŠåˆ°é¢‘ç¹çš„äº¤æ¢ï¼Œåè€Œå¢åŠ äº†ç³»ç»Ÿçš„è´Ÿè½½ï¼Œæ‰€ä»¥åœ¨çº¿ä¸Šç¯å¢ƒä¸­æˆ‘ä»¬ä¸€èˆ¬å»ºè®®å…³é—­ swapï¼Œå…·ä½“çš„å…³é—­æ–¹æ³•è¯·è‡ªè¡Œç™¾åº¦ã€‚ å¦‚ä½•å®šä½å†…å­˜å ç”¨é«˜é’ˆå¯¹å†…å­˜çš„å ç”¨ï¼Œå¸¸è§„æƒ…å†µä¸‹(å½“ç„¶ä¹Ÿæœ‰éå¸¸è§„æƒ…å†µ)ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å ç”¨å†…å­˜é«˜çš„å…·ä½“è¿›ç¨‹ï¼Œè¯¦ç»†çš„æ“ä½œæ–¹å¼æ˜¯:topçš„æ—¶å€™è¾“å…¥Mè¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­è¿›ç¨‹æ¶ˆè€—å†…å­˜çš„è¯¦ç»†å æ¯”äº†: è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸¤åˆ—: %MEM å’Œ RES, å‰è€…æ˜¯è¿™ä¸ªè¿›ç¨‹å ç”¨ç³»ç»Ÿå†…å­˜çš„ç™¾åˆ†æ¯”ï¼Œåè€…æ˜¯å ç”¨å®é™…å†…å­˜çš„å¤§å°ã€‚ æˆ‘ä»¬è¿˜æ˜¯ä»¥ JAVA å’Œ GOLANG ç¨‹åºä¸ºä¾‹æ¥åˆ†æå†…å­˜é«˜è¯¥å¦‚ä½•æ’æŸ¥ JAVA å ç”¨å†…å­˜è¿‡é«˜Java åº”ç”¨çš„å†…å­˜ç®¡ç†ä¾èµ–äº JVM (Java Virtual Machine)ï¼Œé€šå¸¸ä¼šæ¶‰åŠåˆ°å †å†…å­˜ï¼ˆHeapï¼‰ã€éå †å†…å­˜ï¼ˆNon-Heapï¼‰ä»¥åŠæœ¬åœ°å†…å­˜ï¼ˆNative Memoryï¼‰ã€‚ å †å†…å†…å­˜åˆ†æ æŸ¥çœ‹ JVM å¯åŠ¨å‚æ•°ï¼Œå°¤å…¶æ˜¯ -Xms å’Œ -Xmx é€‰é¡¹ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«è®¾ç½®äº†åˆå§‹å †å†…å­˜å¤§å°å’Œæœ€å¤§å †å†…å­˜å¤§å°ã€‚å¯ä»¥é€šè¿‡ ps å‘½ä»¤æŸ¥çœ‹è¿™äº›å‚æ•°ï¼šps -auxf | grep ç¨‹åºåç§° ä½¿ç”¨ jstat æŸ¥çœ‹ gc æƒ…å†µ, å®ä¾‹ï¼šjstat -gc pid 1000gc ä¿¡æ¯ å¦‚æœ GC é¢‘ç¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è¿›è¡Œåˆ†æ é€šè¿‡ jmap ç”Ÿæˆè¿›ç¨‹çš„å †å†…å­˜å¿«ç…§ (åœ¨ JVMå¯åŠ¨æ—¶ï¼Œå»ºè®®æ·»åŠ  OOM æ—¶è‡ªåŠ¨ç”Ÿæˆ heap dump: -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/path/to/dumpfile)ï¼š1jmap -dump:live,format=b,file=heapdump.hprof &lt;pid&gt; æ‹¿åˆ°å¿«ç…§æ–‡ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ MAT æˆ–è€… Jprofiler è¿™æ ·çš„å·¥å…·å»å…·ä½“åˆ†æä»¥ MAT ä¸ºä¾‹ï¼š MAT åˆ†æ JAVAå†…å­˜ æœ¬åœ°å†…å­˜åˆ†æNMTï¼ˆNative Memory Trackingï¼‰æ˜¯ HotSpot JVM å¼•å…¥çš„è·Ÿè¸ª JVM å†…éƒ¨ä½¿ç”¨çš„æœ¬åœ°å†…å­˜çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡ jcmd å·¥å…·è®¿é—® NMT æ•°æ®ã€‚NMT ç›®å‰ä¸æ”¯æŒè·Ÿè¸ªç¬¬ä¸‰æ–¹æœ¬åœ°ä»£ç çš„å†…å­˜åˆ†é…å’Œ JDK ç±»åº“ã€‚NMT ä¸è·Ÿè¸ªé JVM ä»£ç çš„å†…å­˜åˆ†é…ï¼Œæœ¬åœ°ä»£ç é‡Œçš„å†…å­˜æ³„éœ²éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„å·¥å…·æ¥å®šä½ã€‚ å¯ç”¨ NMT ä¼šå¸¦æ¥ 5-10% çš„æ€§èƒ½æŸå¤±ã€‚NMT çš„å†…å­˜ä½¿ç”¨ç‡æƒ…å†µéœ€è¦æ·»åŠ ä¸¤ä¸ªæœºå™¨å­— word åˆ° malloc å†…å­˜çš„ malloc å¤´é‡Œã€‚NMT å†…å­˜ä½¿ç”¨ç‡ä¹Ÿè¢« NMT è·Ÿè¸ªã€‚å¯åŠ¨å‘½ä»¤ï¼š -XX:NativeMemoryTracking=[off | summary | detail]ã€‚ offï¼šNMT é»˜è®¤æ˜¯å…³é—­çš„ï¼› summaryï¼šåªæ”¶é›†å­ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨çš„æ€»è®¡æ•°æ®ï¼› detailï¼šæ”¶é›†æ¯ä¸ªè°ƒç”¨ç‚¹çš„å†…å­˜ä½¿ç”¨æ•°æ®ã€‚ å¼€å¯åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è®¿é—® NMT å†…å­˜ï¼š 1jcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB] å…¶ä»–éå †å†…å­˜ä¸»è¦åŒ…æ‹¬ï¼š JVM è‡ªèº«è¿è¡Œå ç”¨çš„ç©ºé—´ï¼› çº¿ç¨‹æ ˆåˆ†é…å ç”¨çš„ç³»ç»Ÿå†…å­˜ï¼› DirectByteBuffer å ç”¨çš„å†…å­˜ï¼› JNI é‡Œåˆ†é…çš„å†…å­˜ï¼› Java 8 å¼€å§‹çš„å…ƒæ•°æ®ç©ºé—´ï¼› NIO ç¼“å­˜ Unsafe è°ƒç”¨åˆ†é…çš„å†…å­˜ï¼› codecache å¯¹äºè¿™äº›é—®é¢˜ï¼Œé‡åˆ°å†…å­˜å‡é«˜çš„æƒ…å†µè¾ƒå°‘ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰è¿›è¡Œè¿‡è¯¦ç»†çš„æ’æŸ¥ï¼Œå¦‚æœæœ‰è¯»è€…æœ‹å‹æœ‰åšè¿‡ç±»ä¼¼çš„æ’æŸ¥ï¼Œå¯ä»¥åœ¨ä¸‹é¢ç•™è¨€è®¨è®ºã€‚ golangç¨‹åºå ç”¨å†…å­˜é«˜golang å†…ç½®äº† pprof æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ”¯æŒ CPUã€å†…å­˜ï¼ˆHeapï¼‰ã€æ ˆã€åç¨‹ç­‰çš„åˆ†æã€‚å¯ä»¥é€šè¿‡ HTTP æœåŠ¡æš´éœ² pprof æ¥å£ï¼Œå¹¶ä½¿ç”¨æµè§ˆå™¨æˆ– go tool pprof è¿›è¡Œåˆ†æï¼šåœ¨ä»£ç ä¸­å¼•å…¥ net&#x2F;http&#x2F;pprof åŒ…ï¼š 12345678import _ &quot;net/http/pprof&quot;func main() &#123; go func() &#123; log.Println(http.ListenAndServe(&quot;localhost:6060&quot;, nil)) &#125;() // ä½ çš„åº”ç”¨ä»£ç &#125; å¯åŠ¨åº”ç”¨åï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—® http://localhost:6060/debug/pprof/heap ä¸‹è½½å †å†…å­˜å¿«ç…§ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ†æï¼š 1go tool pprof -http=:8080 heap.prof è¿™å°†å¯åŠ¨ä¸€ä¸ª Web ç•Œé¢ï¼Œä¾›ä½ åˆ†æå†…å­˜å ç”¨çš„çƒ­ç‚¹ã€‚å…·ä½“çš„ä½¿ç”¨æ–¹å¼å¤§å®¶å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚ åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿå ç”¨åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è¯´äº†å¸¸è§„æƒ…å†µä¸‹çš„æ’æŸ¥ï¼Œé‚£æ¥ä¸ªéå¸¸è§„çš„ï¼Œå…ˆä¸Šå¼ å›¾ï¼š å†…å­˜å ç”¨æ¨¡æ‹Ÿ è¿™é‡Œå¤§å®¶çœ‹çœ‹åˆ°ï¼Œå†…å­˜æ€»é‡å¤§æ¦‚æœ‰ 250 ä¸ª Gï¼Œå¯ç”¨å†…å­˜åªæœ‰ 126Gï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡ top çœ‹å†…å­˜å æ¯”è·Ÿå®é™…çš„æ•°å€¼ç›¸å·®ç”šè¿œã€‚ è¿™ç§åœºæ™¯æ˜¯ä¸æ˜¯éå¸¸å¥‡æ€ªå‘¢ï¼Ÿæ²¡æœ‰è¿›ç¨‹å ç”¨å†…å­˜ï¼Œä½†æ˜¯å†…å­˜è¢«æ¶ˆè€—äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½è·ŸåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿæœ‰å…³ã€‚ è¿™é‡Œæˆ‘è¯´ä¸€ä¸‹æ¨¡æ‹Ÿæ–¹æ³•: 123456789101112131415# systemd çš„åŒ…ä¸­ä¼šé»˜è®¤è‡ªå¸¦ä¸€ä¸ª tmp.mountæœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡é»˜è®¤æ˜¯å…³é—­çš„ï¼ˆé»˜è®¤æ˜¯æ€»å†…å­˜çš„ä¸€åŠï¼‰# è¿™ä¸ªæœåŠ¡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆæŠŠå†…å­˜å½“ç£ç›˜ä½¿ï¼Œåœ¨ä¸Šé¢å¯ä»¥åˆ›å»ºæ–‡ä»¶ï¼‰systemctl start tmp.mount# ç„¶åæˆ‘ä»¬é€šè¿‡ df -h /tmp å¯ä»¥çœ‹åˆ°Filesystem Size Used Avail Use% Mounted ontmpfs 126G 111G 16G 88% /tmpè¿™é‡ŒæŒ‚è½½äº†/tmp ç›®å½•ï¼Œæ–‡ä»¶ç³»ç»Ÿæ˜¯ tmpfs# ç„¶åæˆ‘ä»¬è¿›å…¥ /tmpç›®å½•# æ¨¡æ‹Ÿæ–‡ä»¶åˆ›å»ºdd if=/dev/zero of=test.txt bs=G count=100# ç„¶åæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œç„¶å free -g å°±å¯ä»¥çœ‹åˆ°å†…å­˜æˆåŠŸæ¶ˆè€—äº†100GğŸ˜‚ è¿™ç§åœºæ™¯ä¹Ÿæ˜¯æˆ‘ä¹‹å‰åœ¨æ’æŸ¥é—®é¢˜çš„æ—¶å€™é‡åˆ°çš„ï¼Œå¤§å®¶æœ‰å…¶ä»–ç±»ä¼¼åœºæ™¯ä¹Ÿå¯ä»¥è¿›è¡Œè¡¥å…… ç£ç›˜é—®é¢˜çº¿ä¸Šçš„ç£ç›˜é—®é¢˜ï¼Œé™¤äº†ç£ç›˜æ•…éšœ(åå—ã€æ–‡ä»¶ç³»ç»ŸæŸåã€RAID ç­‰)ä¹‹å¤–ï¼Œå¸¸è§çš„æ¯”è¾ƒå¤šçš„é—®é¢˜å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šç£ç›˜ç©ºé—´ä¸è¶³å’Œ IO æ€§èƒ½é—®é¢˜ ç£ç›˜ç©ºé—´ä¸è¶³å¯¹äºè¿™ç±»é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ¬èº«å¯èƒ½å°±æ˜¯æ•°æ®æ–‡ä»¶ã€æ—¥å¿—ä¿¡æ¯ç­‰è¿‡å¤šå¯¼è‡´çš„çœŸå®å ç”¨ï¼Œè¿˜æœ‰ä¸€ç±»æ˜¯æ–‡ä»¶å¥æŸ„æ³„éœ²å¯¼è‡´ç£ç›˜æ²¡æœ‰é‡Šæ”¾ä»è€Œå æ®äº†å¤šä½™çš„ç£ç›˜ç©ºé—´ å¯¹äºè¿™ç±»é—®é¢˜æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡ä»¥ä¸‹æ‰‹æ®µè¿›è¡Œæ’æŸ¥ï¼Œå‡å¦‚è¯´æˆ‘ä»¬ç°åœ¨æ¥åˆ°å‘Šè­¦ è¯´æ ¹ç›®å½•çš„ç£ç›˜ç©ºé—´ä¸è¶³äº† é€šè¿‡df -hå‘½ä»¤æŸ¥çœ‹ç£ç›˜åˆ†åŒºçš„ä½¿ç”¨æƒ…å†µã€‚ è¿›å…¥ &quot;/&quot; ç›®å½•ä¸‹ï¼Œå¯ä»¥å¯¹å¸¸ç”¨çš„ç›®å½•è¿›è¡Œ du -shæ“ä½œï¼Œç„¶åè¿›è¡Œç®€å•çš„ç›¸åŠ  å¦‚æœåŠ èµ·æ¥çš„ç£ç›˜ç©ºé—´ï¼Œå’Œåˆ†åŒºä½¿ç”¨çš„ç£ç›˜ç©ºé—´ç›¸å·®ä¸å¤šï¼Œé‚£å°±åŸºæœ¬ä¸Šè¯´æ˜ç£ç›˜ç©ºé—´æ˜¯è¢«çœŸå®å ç”¨çš„ï¼Œæ‰¾åˆ°å ç”¨é«˜çš„ç›®å½•ç»§ç»­é€šè¿‡du -sh ç›®å½•ï¼Œä¸æ–­é€’å½’ã€‚æˆ–è€…æƒ³å¿«é€Ÿæ‰¾åˆ°ç£ç›˜ä¸­è¶…è¿‡ 1G çš„æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡find ç›®å½• -type f -size +1G è¿™æ ·çš„æ–¹å¼ã€‚å¦‚æœæƒ³å¿«é€Ÿç»Ÿè®¡åˆ°æ‰€æœ‰å­ç›®å½•çš„ç£ç›˜ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è¿™æ ·çš„æ–¹å¼è¿›è¡Œæ“ä½œ1du -ah / 2&gt;/dev/null | grep -E &#x27;^([0-9]+([KMGT]?)|([0-9]+(\\.[0-9]+)?[KMGT]))&#x27; | sort -rh | head -10 å¦‚æœåŠ èµ·æ¥çš„ç£ç›˜ç©ºé—´ï¼Œå’Œåˆ†åŒºä½¿ç”¨çš„ç£ç›˜ç©ºé—´ç›¸å·®çš„æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å¥æŸ„æ³„éœ²ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶æœ¬èº«è¢«åˆ æ‰ï¼Œä½†æ˜¯å¥æŸ„æ²¡æœ‰é‡Šæ”¾ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹æ–¹å¼: 1234567#åˆ—å‡ºè¿›æ‰“å¼€æ–‡ä»¶æœ€å¤šçš„ 10 ä¸ªè¿›ç¨‹ï¼›lsof +L1 | awk &#x27;&#123;print $2&#125;&#x27; | sort | uniq -c | sort -rn | head -n 10# æŸ¥çœ‹æŸä¸ªè¿›ç¨‹çš„å ç”¨lsof -p $pid (æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å·²ç»åˆ é™¤çš„æ–‡ä»¶å¥æŸ„æ²¡æœ‰é‡Šæ”¾ï¼Œå¯ä»¥é€šè¿‡ grep deleted è¿‡æ»¤)# æˆ–è€… ls /proc/$pid/fd è¿›è¡ŒæŸ¥çœ‹ ç£ç›˜IOæ€§èƒ½é—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡ iostat çœ‹ä¸‹ç£ç›˜æ•´ä½“çš„è¯»å†™æƒ…å†µ: iostat è¯¦ç»†çš„ä»‹ç»å¦‚ä¸‹ï¼š CPU ä½¿ç”¨æƒ…å†µ Metric Description %user ç”¨æˆ·æ¨¡å¼ä¸‹æ¶ˆè€—çš„ CPU æ—¶é—´ç™¾åˆ†æ¯” %nice è°ƒæ•´ä¼˜å…ˆçº§çš„ç”¨æˆ·æ¨¡å¼ä¸‹çš„ CPU æ—¶é—´ç™¾åˆ†æ¯” %system å†…æ ¸æ¨¡å¼ä¸‹æ¶ˆè€—çš„ CPU æ—¶é—´ç™¾åˆ†æ¯” %iowait CPU ç­‰å¾… I&#x2F;O æ“ä½œå®Œæˆçš„æ—¶é—´ç™¾åˆ†æ¯” %steal ç­‰å¾…è™šæ‹Ÿ CPU è¢«å®é™… CPU æœåŠ¡çš„æ—¶é—´ç™¾åˆ†æ¯” %idle CPU ç©ºé—²æ—¶é—´ç™¾åˆ†æ¯” è®¾å¤‡ I&#x2F;O ä½¿ç”¨æƒ…å†µ Metric Description Device è®¾å¤‡åç§° tps æ¯ç§’ä¼ è¾“æ•°ï¼ˆI&#x2F;O è¯·æ±‚æ•°ï¼‰ kB_read&#x2F;s æ¯ç§’è¯»å–çš„ kB æ•° kB_wrtn&#x2F;s æ¯ç§’å†™å…¥çš„ kB æ•° kB_read è¯»å–çš„ kB æ€»æ•° kB_wrtn å†™å…¥çš„ kB æ€»æ•° rrqm&#x2F;s æ¯ç§’è¿›è¡Œçš„åˆå¹¶è¯»è¯·æ±‚æ•° wrqm&#x2F;s æ¯ç§’è¿›è¡Œçš„åˆå¹¶å†™è¯·æ±‚æ•° r&#x2F;s æ¯ç§’å®Œæˆçš„è¯»è¯·æ±‚æ•° w&#x2F;s æ¯ç§’å®Œæˆçš„å†™è¯·æ±‚æ•° rMB&#x2F;s æ¯ç§’è¯»å–çš„ MB æ•° wMB&#x2F;s æ¯ç§’å†™å…¥çš„ MB æ•° avgrq-sz å¹³å‡æ¯æ¬¡ I&#x2F;O è¯·æ±‚çš„æ•°æ®å¤§å° avgqu-sz å¹³å‡ I&#x2F;O é˜Ÿåˆ—é•¿åº¦ await å¹³å‡æ¯æ¬¡ I&#x2F;O æ“ä½œçš„ç­‰å¾…æ—¶é—´ svctm å¹³å‡æ¯æ¬¡ I&#x2F;O æ“ä½œçš„æœåŠ¡æ—¶é—´ %util è®¾å¤‡ I&#x2F;O æ´»åŠ¨æ—¶é—´ç™¾åˆ†æ¯”ï¼ˆè¡¨ç¤ºè®¾å¤‡å¿™ç¢Œåº¦ï¼‰ é€šè¿‡è¿™ä¸ªæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°ç£ç›˜çš„æ•´ä½“æƒ…å†µã€‚ å½“æˆ‘ä»¬æƒ³æŸ¥çœ‹è¿›ç¨‹å ç”¨çš„ io æƒ…å†µæ—¶ï¼Œå¯ä»¥é€šè¿‡ iotopå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œå¦‚ä¸‹: iotop ç»“åˆä¸Šæ–‡è®²çš„ä¸€äº›å †æ ˆåˆ†æå·¥å…·ï¼Œæ¨æµ‹åˆ°è¿›ç¨‹å…·ä½“åœ¨åšé‚£äº›æ“ä½œç„¶åé’ˆå¯¹æ€§è¿›è¡Œå¤„ç†ã€‚","tags":["Linux","Java","Golang","commands"],"categories":["é—®é¢˜æ’æŸ¥"]},{"title":"JAVAé—®é¢˜å®šä½","path":"/p/JAVAé—®é¢˜å®šä½/","content":"ä¸€ã€JAVA ç›¸å…³å‘½ä»¤1.jpsjps - Lists the instrumented Java Virtual Machines (JVMs) on the target system. This command is experimental and unsupported. ç›¸å…³å‚æ•° 123456789101112131415OPTIONS The jps command supports a number of options that modify the output of the command. These options are subject to change or removal in the future. -q Suppresses the output of the class name, JAR file name, and arguments passed to the main method, producing only a list of local JVM identifiers. -m Displays the arguments passed to the main method. The output may be null for embedded JVMs. -l Displays the full package name for the application&#x27;s main class or the full path name to the application&#x27;s JAR file. -v Displays the arguments passed to the JVM. -V Suppresses the output of the class name, JAR file name, and arguments passed to the main method, producing only a list of local JVM identifiers. -Joption Passes option to the JVM, where option is one of the options described on the reference page for the Java application launcher. For example, -J-Xms48m sets the startup memory to 48 MB. See java(1). 2.jinfojinfoï¼ˆJava Virtual Machine Configuration Informationï¼‰æ˜¯JDKæä¾›çš„ä¸€ä¸ªå¯ä»¥å®æ—¶æŸ¥çœ‹Javaè™šæ‹Ÿæœºå„ç§é…ç½®å‚æ•°å’Œç³»ç»Ÿå±æ€§çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä½¿ç”¨jpså‘½ä»¤çš„-vå‚æ•°å¯ä»¥æŸ¥çœ‹Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶æ˜¾å¼æŒ‡å®šçš„é…ç½®å‚æ•°ï¼Œå¦‚æœæƒ³æŸ¥çœ‹æ²¡æœ‰æ˜¾å¼æŒ‡å®šçš„é…ç½®å‚æ•°å°±å¯ä»¥ä½¿ç”¨jinfoå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ã€‚å¦å¤–ï¼Œjinfoå‘½ä»¤è¿˜å¯ä»¥æŸ¥è¯¢Javaè™šæ‹Ÿæœºè¿›ç¨‹çš„System.getProperties()çš„å†…å®¹ã€‚ ä»¥tomcatè¿›ç¨‹ä¸ºä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889Attaching to process ID 2045, please wait...Debugger attached successfully.Server compiler detected.JVM version is 25.242-b08Java System Properties:java.vendor = Huawei Technologies Co., Ltdsun.java.launcher = SUN_STANDARDcatalina.base = /usr/share/tomcatsun.management.compiler = HotSpot 64-Bit Tiered Compilerssun.nio.ch.bugLevel = catalina.useNaming = truejnidispatch.path = /var/cache/tomcat/temp/jna--903012287/jna4240128671455089550.tmpos.name = Linuxsun.boot.class.path = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/resources.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/rt.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/sunrsasign.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jsse.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jce.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/charsets.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jfr.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/classesjava.vm.specification.vendor = Oracle Corporationjava.runtime.version = 1.8.0_242-b08jna.loaded = trueuser.name = xxxtomcat.util.scan.StandardJarScanFilter.jarsToScan = taglibs-standard-impl*.jarshared.loader = tomcat.util.buf.StringCache.byte.enabled = trueuser.language = enjava.naming.factory.initial = org.apache.naming.java.javaURLContextFactorysun.boot.library.path = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/amd64java.version = 1.8.0_242java.util.logging.manager = org.apache.juli.ClassLoaderLogManageruser.timezone = Asia/Shanghaisun.arch.data.model = 64java.util.concurrent.ForkJoinPool.common.threadFactory = org.apache.catalina.startup.SafeForkJoinWorkerThreadFactoryjava.endorsed.dirs = sun.cpu.isalist = sun.jnu.encoding = UTF-8file.encoding.pkg = sun.iopackage.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.jasper.,org.apache.tomcat.file.separator = /java.specification.name = Java Platform API Specificationjava.class.version = 52.0user.country = USjava.home = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jrejava.vm.info = mixed modeos.version = 4.19.90-24.4.v2101.ky10.x86_64sun.font.fontmanager = sun.awt.X11FontManagerpath.separator = :java.vm.version = 25.242-b08jboss.i18n.generate-proxies = truejava.awt.printerjob = sun.print.PSPrinterJobsun.io.unicode.encoding = UnicodeLittleawt.toolkit = sun.awt.X11.XToolkitpackage.definition = sun.,java.,org.apache.catalina.,org.apache.coyote.,org.apache.jasper.,org.apache.naming.,org.apache.tomcat.java.naming.factory.url.pkgs = org.apache.namingmail.mime.splitlongparameters = falsejava.security.egd = file:/dev/./urandomuser.home = /home/shtermjava.specification.vendor = Oracle Corporationtomcat.util.scan.StandardJarScanFilter.jarsToSkip = activ*.jar,amqp-client.jar,annotations-api.jar,ant-junit*.jar,ant-launcher.jar,ant.jar,antlr.jar,aopalliance.jar,asm-*.jar,aspectj*.jar,bcp*.jar,bootstrap.jar,catalina-ant.jar,catalina-ha.jar,catalina-jmx-remote.jar,catalina-storeconfig.jar,catalina-tribes.jar,catalina-ws.jar,catalina.jar,cglib-*.jar,classmate.jar,cobertura-*.jar,commons-*.jar,compress-lzf.jar,curator-*.jar,db2-jdbc.jar,dom4j-*.jar,easymock-*.jar,ecj-*.jar,el-api.jar,elasticsearch.jar,geronimo-spec-jaxrpc*.jar,groovy-all.jar,guava.jar,h2*.jar,hamcrest-*.jar,hibernate*.jar,hppc.jar,http*.jar,icu4j-*.jar,itext*.jar,jackson-*.jar,jandex.jar,jasper-el.jar,jasper.jar,jasperreports*.jar,jaspic-api.jar,javamail.jar,javassist.jar,jaxb-*.jar,jaxen*.jar,jboss*.jar,jc*.jar,jdom-*.jar,jedis.jar,jetty-*.jar,jfreechart.jar,jgit.jar,jline.jar,jmx-tools.jar,jmx.jar,jna.jar,joda-time.jar,jr-*.jar,jsch.jar,json*.jar,jsoup.jar,jsp-api.jar,jsr166e.jar,jstl.jar,jta*.jar,junit-*.jar,junit.jar,liquibase-*.jar,log4j*.jar,lucene*.jar,mail*.jar,mariadb-jdbc.jar,mssql-jdbc.jar,mybatis.jar,netty.jar,nmap4j.jar,objenesis*.jar,olap4j.jar,opc*.jar,oracle-jdbc.jar,oraclepki.jar,oro-*.jar,poi*.jar,postgresql-jdbc.jar,quartz.jar,servlet-api-*.jar,servlet-api.jar,slf4j*.jar,snakeyaml.jar,snmp4j.jar,spring*.jar,sshd-core.jar,taglibs-standard-spec-*.jar,tagsoup-*.jar,t-digest.jar,tomcat-api.jar,tomcat-coyote.jar,tomcat-dbcp.jar,tomcat-i18n-*.jar,tomcat-jdbc.jar,tomcat-jni.jar,tomcat-juli-adapters.jar,tomcat-juli.jar,tomcat-util-scan.jar,tomcat-util.jar,tomcat-websocket.jar,tools.jar,validation-api.jar,velocypack.jar,websocket-api.jar,wl*.jar,wsdl4j*.jar,xercesImpl.jar,xml-apis.jar,xmlbeans.jar,xmlParserAPIs-*.jar,xmlParserAPIs.jar,xom-*.jar,xz.jar,zip4j.jar,zookeeper.jarjava.library.path = /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/libjava.vendor.url = http://jdk.rnd.huawei.com/java.vm.vendor = Huawei Technologies Co., Ltdcommon.loader = &quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;java.runtime.name = OpenJDK Runtime Environmentsun.java.command = org.apache.catalina.startup.Bootstrap startjava.class.path = /usr/share/tomcat/bin/bootstrap.jar:/usr/share/tomcat/bin/tomcat-juli.jar:/usr/lib/java/commons-daemon.jarjava.vm.specification.name = Java Virtual Machine Specificationjava.vm.specification.version = 1.8catalina.home = /usr/share/tomcatsun.cpu.endian = littlesun.os.patch.level = unknownjava.awt.headless = truejava.io.tmpdir = /var/cache/tomcat/tempjava.vendor.url.bug = http://jdk.rnd.huawei.com/server.loader = java.rmi.server.hostname = 127.0.0.1jna.platform.library.path = /usr/lib64:/lib64:/usr/lib:/lib:/usr/lib64/tracker-miners-2.0:/usr/lib64/tracker-2.0:/usr/lib64/dyninst:/usr/libexec/sudo:/usr/lib64/sssd:/usr/pgsql-9.6/lib:/usr/lib64/perl5/CORE:/usr/lib64/opencryptoki:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/amd64/jli:/usr/lib64/bind9-exportos.arch = amd64java.awt.graphicsenv = sun.awt.X11GraphicsEnvironmentjava.ext.dirs = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/ext:/usr/java/packages/lib/extuser.dir = /usr/share/tomcatline.separator = java.vm.name = OpenJDK 64-Bit Server VMlog4j.configurationFile = /etc/tomcat/log4j2.xmlfile.encoding = UTF-8com.sun.jndi.ldap.object.disableEndpointIdentification = java.specification.version = 1.8VM Flags:Non-default VM flags: -XX:CICompilerCount=4 -XX:GCLogFileSize=20971520 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=null -XX:InitialHeapSize=243269632 -XX:MaxHeapSize=1610612736 -XX:MaxNewSize=536870912 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=80740352 -XX:NumberOfGCLogFiles=15 -XX:OldSize=162529280 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseGCLogFileRotation -XX:+UseParallelGC Command line: -Xmx1536m -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/tomcat -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=15 -XX:GCLogFileSize=20m -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/var/log/tomcat/tomcat-gc-%t.log -Dcom.sun.jndi.ldap.object.disableEndpointIdentification -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Dlog4j.configurationFile=/etc/tomcat/log4j2.xml -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager 3.jstatå‘½ä»¤å‚æ•°è¯´æ˜ï¼š generalOptionsï¼šé€šç”¨é€‰é¡¹ï¼Œå¦‚æœæŒ‡å®šä¸€ä¸ªé€šç”¨é€‰é¡¹ï¼Œå°±ä¸èƒ½æŒ‡å®šä»»ä½•å…¶ä»–é€‰é¡¹æˆ–å‚æ•°ã€‚å®ƒåŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªé€‰é¡¹ï¼š -helpï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚ -optionsï¼šæ˜¾ç¤ºoutputOptionså‚æ•°çš„åˆ—è¡¨ã€‚ outputOptionsï¼šè¾“å‡ºé€‰é¡¹ï¼ŒæŒ‡å®šæ˜¾ç¤ºæŸä¸€ç§Javaè™šæ‹Ÿæœºä¿¡æ¯ã€‚ -tï¼šæŠŠæ—¶é—´æˆ³åˆ—æ˜¾ç¤ºä¸ºè¾“å‡ºçš„ç¬¬ä¸€åˆ—ã€‚è¿™ä¸ªæ—¶é—´æˆ³æ˜¯ä»Javaè™šæ‹Ÿæœºçš„å¼€å§‹è¿è¡Œåˆ°ç°åœ¨çš„ç§’æ•°ã€‚ -h nï¼šæ¯æ˜¾ç¤ºnè¡Œæ˜¾ç¤ºä¸€æ¬¡è¡¨å¤´ï¼Œå…¶ä¸­nä¸ºæ­£æ•´æ•°ã€‚é»˜è®¤å€¼ä¸º 0ï¼Œå³ä»…åœ¨ç¬¬ä¸€è¡Œæ•°æ®æ˜¾ç¤ºä¸€æ¬¡è¡¨å¤´ã€‚ vmidï¼šè™šæ‹Ÿæœºå”¯ä¸€IDï¼ˆLVMIDï¼ŒLocal Virtual Machine Identifierï¼‰ï¼Œå¦‚æœæŸ¥çœ‹æœ¬æœºå°±æ˜¯Javaè¿›ç¨‹çš„è¿›ç¨‹IDã€‚ intervalï¼šæ˜¾ç¤ºä¿¡æ¯çš„æ—¶é—´é—´éš”ï¼Œå•ä½é»˜è®¤æ¯«ç§’ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šç§’ä¸ºå•ä½ï¼Œæ¯”å¦‚ï¼š1sã€‚å¦‚æœæŒ‡å®šäº†è¯¥å‚æ•°ï¼Œjstatå‘½ä»¤å°†æ¯éš”è¿™æ®µæ—¶é—´æ˜¾ç¤ºä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ã€‚ countï¼šæ˜¾ç¤ºæ•°æ®çš„æ¬¡æ•°ï¼Œé»˜è®¤å€¼æ˜¯æ— ç©·å¤§ï¼Œè¿™å°†å¯¼è‡´jstatå‘½ä»¤ä¸€ç›´æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼Œç›´åˆ°ç›®æ ‡JVMç»ˆæ­¢æˆ–jstatå‘½ä»¤ç»ˆæ­¢ã€‚è¾“å‡ºé€‰é¡¹å¦‚æœä¸æŒ‡å®šé€šç”¨é€‰é¡¹ï¼ˆgeneralOptionsï¼‰ï¼Œåˆ™å¯ä»¥æŒ‡å®šè¾“å‡ºé€‰é¡¹ï¼ˆoutputOptionsï¼‰ã€‚è¾“å‡ºé€‰é¡¹å†³å®šjstatå‘½ä»¤æ˜¾ç¤ºçš„å†…å®¹å’Œæ ¼å¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š -classï¼šæ˜¾ç¤ºç±»åŠ è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´å’Œè£…è½½è€—æ—¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -compilerï¼šæ˜¾ç¤ºå³æ—¶ç¼–è¯‘çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯ã€‚ -gcï¼šæ˜¾ç¤ºå †å„ä¸ªåŒºåŸŸå†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -gccapacityï¼šæ˜¾ç¤ºå †å„ä¸ªåŒºåŸŸçš„å®¹é‡åŠå…¶å¯¹åº”çš„ç©ºé—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcutilï¼šæ˜¾ç¤ºæœ‰å…³åƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ‘˜è¦ã€‚ -gccauseï¼šæ˜¾ç¤ºå…³äºåƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ‘˜è¦(ä¸-gcutilç›¸åŒ)ï¼Œä»¥åŠæœ€è¿‘å’Œå½“å‰åƒåœ¾å›æ”¶çš„åŸå› ã€‚ -gcnewï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcnewcapacityï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£çš„å¤§å°åŠå…¶å¯¹åº”çš„ç©ºé—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcold: æ˜¾ç¤ºè€å¹´ä»£å’Œå…ƒç©ºé—´çš„åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcoldcapacityï¼šæ˜¾ç¤ºè€å¹´ä»£çš„å¤§å°ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcmetacapacityï¼šæ˜¾ç¤ºå…ƒç©ºé—´çš„å¤§å°çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -printcompilationï¼šæ˜¾ç¤ºå³æ—¶ç¼–è¯‘æ–¹æ³•çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ äºŒã€çº¿ç¨‹å †æ ˆ1.è¾“å‡ºJavaè™šæ‹Ÿæœºæä¾›äº†çº¿ç¨‹è½¬å‚¨(Thread dump)çš„åé—¨ï¼Œé€šè¿‡è¿™ä¸ªåé—¨ï¼Œå¯ä»¥å°†çº¿ç¨‹å †æ ˆæ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªåé—¨å°±æ˜¯é€šè¿‡å‘Javaè¿›ç¨‹å‘é€ä¸€ä¸ªQUITä¿¡å·ï¼ŒJavaè™šæ‹Ÿæœºæ”¶åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œå°†ç³»ç»Ÿå½“å‰çš„JAVAçº¿ç¨‹è°ƒç”¨å †æ ˆæ‰“å°å‡ºæ¥ã€‚ æ‰“å°æ–¹æ³•ï¼š jstack -l pid &gt; xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼ kill -3åŒæ—¶è¯·ç¡®ä¿Javaå‘½ä»¤è¡Œä¸­æ²¡æœ‰DISABLE_JAVADUMPè¿è¡Œé€‰é¡¹ 2.çº¿ç¨‹åˆ†æé€šè¿‡è¾“å‡ºå †æ ˆè¿›è¡Œåˆ†æ jstack -l $(jps | grep xxx | awk &#39;&#123;print $1&#125;&#39;) &gt; &#x2F;tmp&#x2F;xxx.jstack 12345678910111213141516171819202122232425262728293031&quot;SYS_STATUS_CHECKER&quot; #14 daemon prio=5 os_prio=0 tid=0x00007f5e047bf000 nid=0xe15 waiting on condition [0x00007f5dd43d1000] java.lang.Thread.State: TIMED_WAITING (sleeping) at java.lang.Thread.sleep(Native Method)ru at com.xxx.xxx.SystemStatusChecker.run(SystemStatusChecker.java:xx) at java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers: - None &quot;RMI Reaper&quot; #39 prio=5 os_prio=0 tid=0x00007f5e04e4c800 nid=0xf0b in Object.wait() [0x00007f5dae2c4000] java.lang.Thread.State: WAITING (on object monitor) at java.lang.Object.wait(Native Method) - waiting on &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock) at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144) - locked &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock) at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165) at sun.rmi.transport.ObjectTable$Reaper.run(ObjectTable.java:351) at java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers: - None &quot;main&quot; #1 prio=5 os_prio=0 tid=0x00007f5e0400a000 nid=0xdcb runnable [0x00007f5e0b393000] java.lang.Thread.State: RUNNABLE at java.net.PlainSocketImpl.socketAccept(Native Method) at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409) at java.net.ServerSocket.implAccept(ServerSocket.java:545) at java.net.ServerSocket.accept(ServerSocket.java:513) at com.xxx.common.xxx.await(CommonMain.java:244) at com.xxx.common.xxx.startup(CommonMain.java:207) at com.xxx.common.xxx.main(CommonMain.java:147) Locked ownable synchronizers: - None åœ¨RMIçº¿ç¨‹ä¸­å¯ä»¥çœ‹åˆ° â€œ - locked &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock)â€ è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»ä½¿ç”¨äº†IDä¸ºâ€0x00000000c0c88d2â€çš„é”ï¼Œé”çš„IDç”±ç³»ç»Ÿè‡ªåŠ¨äº§ç”Ÿ 123&quot;main&quot; prio=5 os_prio=0 tid=0x00007f5e0400a000 nid=0xdcb runnable [0x00007f5e0b393000]| | | | | | |çº¿ç¨‹åç§° çº¿ç¨‹ä¼˜å…ˆçº§ æ“ä½œç³»ç»Ÿçº§åˆ«çš„ä¼˜å…ˆçº§ çº¿ç¨‹id å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹ID çŠ¶æ€ çº¿ç¨‹å ç”¨å†…å­˜åœ°å€ å…¶ä¸­â€çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹idå·â€æ‰€æŒ‡çš„â€æœ¬åœ°çº¿ç¨‹â€æ˜¯æŒ‡è¯¥Javaçº¿ç¨‹æ‰€å¯¹åº”çš„è™šæ‹Ÿæœºä¸­çš„æœ¬åœ°çº¿ç¨‹ã€‚æˆ‘ä»¬çŸ¥é“Javaæ˜¯è§£æå‹è¯­è¨€ï¼Œæ‰§è¡Œçš„å®ä½“æ˜¯Javaè™šæ‹Ÿæœºï¼Œå› æ­¤Javaè¯­è¨€ä¸­çš„çº¿ç¨‹æ˜¯ ä¾é™„äºJavaè™šæ‹Ÿæœºä¸­çš„æœ¬åœ°çº¿ç¨‹æ¥è¿è¡Œçš„ï¼Œå®é™…ä¸Šæ˜¯æœ¬åœ°çº¿ç¨‹åœ¨æ‰§è¡ŒJavaçº¿ç¨‹ä»£ç ã€‚ Javaä»£ç  ä¸­åˆ›å»ºä¸€ä¸ªthreadï¼Œè™šæ‹Ÿæœºåœ¨è¿è¡ŒæœŸå°±ä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°çº¿ç¨‹ï¼Œè€Œè¿™ä¸ªæœ¬åœ°çº¿ç¨‹æ‰æ˜¯çœŸæ­£çš„çº¿ç¨‹å®ä½“ã€‚ä¸ºäº†æ›´åŠ æ·±å…¥å¾—ç†è§£æœ¬åœ°çº¿ç¨‹å’ŒJavaçº¿ç¨‹çš„å…³ç³»ï¼Œåœ¨Unix&#x2F;Linuxä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€š å¦‚ä¸‹æ–¹å¼æŠŠJavaè™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹æ‰“å°å‡ºæ¥ï¼š ä½¿ç”¨ps -ef | grep java è·å¾—Javaè¿›ç¨‹IDã€‚ ä½¿ç”¨pstack è·å¾—Javaè™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹çš„å †æ ˆå…¶ä¸­æœ¬åœ°çº¿ç¨‹å„é¡¹å«ä¹‰å¦‚ä¸‹ï¼š12345Thread 56 (Thread 0x7f5e0b394700 (LWP 3531))| | || | +----æœ¬åœ°çº¿ç¨‹id(å¦ä¸€ç§è¡¨ç¤º,LWP-light weight process)| +-------------------æœ¬åœ°çº¿ç¨‹id+------------------------------çº¿ç¨‹åç§° è€Œé€šè¿‡jstackè¾“å‡ºçš„mainæœ¬åœ°çº¿ç¨‹IDä¸º0xdcbï¼Œå…¶10è¿›åˆ¶æ­£å¥½ä¸º3531ã€‚ â€œrunnableâ€è¡¨ç¤ºå½“å‰çº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ã€‚è¿™ä¸ªrunnableçŠ¶æ€æ˜¯ä»è™šæ‹Ÿæœºçš„è§’åº¦æ¥çœ‹çš„, è¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹æ­£åœ¨è¿è¡Œ âš ï¸ NOTE: ä½†æ˜¯å¤„äºRunnableçŠ¶æ€çš„çº¿ç¨‹ä¸ä¸€å®šçœŸçš„æ¶ˆè€—CPU. å¤„äºRunnableçš„çº¿ç¨‹åªèƒ½è¯´æ˜è¯¥çº¿ç¨‹æ²¡æœ‰é˜»å¡åœ¨javaçš„waitæˆ–è€…sleepæ–¹æ³•ä¸Šï¼ŒåŒæ—¶ä¹Ÿæ²¡ç­‰å¾…åœ¨é”ä¸Šé¢ã€‚ä½†æ˜¯å¦‚æœè¯¥çº¿ç¨‹è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•ï¼Œè€Œæœ¬åœ°æ–¹æ³•å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™è™šæ‹Ÿæœºæ˜¯ä¸çŸ¥é“æœ¬åœ°ä»£ç ä¸­å‘ç”Ÿ äº†ä»€ä¹ˆï¼ˆä½†æ“ä½œç³»ç»Ÿæ˜¯çŸ¥é“çš„ï¼Œpstackå°±æ˜¯æ“ä½œæä¾›çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒçŸ¥é“å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æœ¬åœ°ä»£ç ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ­¤æ—¶å°½ç®¡å½“å‰çº¿ç¨‹å®é™…ä¸Šä¹Ÿæ˜¯é˜»å¡çš„çŠ¶æ€ï¼Œä½†å®é™…ä¸Šæ˜¾ç¤ºå‡ºæ¥çš„è¿˜æ˜¯runnableçŠ¶æ€ï¼Œ è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸æ¶ˆè€—CPUçš„ 121. å¤„äºwaittigå’ŒblockedçŠ¶æ€çš„çº¿ç¨‹éƒ½ä¸ä¼šæ¶ˆè€—CPU 2. çº¿ç¨‹é¢‘ç¹åœ°æŒ‚èµ·å’Œå”¤é†’éœ€è¦æ¶ˆè€—CPU, è€Œä¸”ä»£ä»·é¢‡å¤§ TIMED_WAITING(on object monitor) è¡¨ç¤ºå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,è¯´æ˜è¯¥çº¿ç¨‹æ­£åœ¨ æ‰§è¡Œobj.wait(int time)æ–¹æ³•. TIMED_WAITING(sleeping) è¡¨ç¤ºå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,å³æ­£åœ¨æ‰§è¡ŒThread.sleep(int time)æ–¹æ³•. TIMED_WAITING(parking) å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,å³æ­£åœ¨æ‰§è¡ŒThread.sleep(int time)æ–¹æ³•. WAINTING(on object monitor) å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œå³æ­£åœ¨æ‰§è¡Œobj.wait()æ–¹æ³•(æ— å‚æ•°çš„wait()æ–¹æ³•).1234å¤„äºTIMED_WAITINGã€WAINTINGçŠ¶æ€çš„çº¿ç¨‹ä¸€å®šä¸æ¶ˆè€—CPU. å¤„äºRUNNABLEçš„çº¿ç¨‹ï¼Œè¦ç»“åˆå½“å‰çº¿ç¨‹ä»£ç çš„æ€§è´¨åˆ¤æ–­ï¼Œæ˜¯å¦æ¶ˆè€—CPU.â€¢ å¦‚æœæ˜¯çº¯Javaè¿ç®—ä»£ç ï¼Œåˆ™æ¶ˆè€—CPU.â€¢ å¦‚æœæ˜¯ç½‘ç»œIO,å¾ˆå°‘æ¶ˆè€—CPU.â€¢ å¦‚æœæ˜¯æœ¬åœ°ä»£ç ï¼Œç»“åˆæœ¬åœ°ä»£ç çš„æ€§è´¨åˆ¤æ–­(å¯ä»¥é€šè¿‡pstack/gstackè·å–æœ¬åœ°çº¿ç¨‹å †æ ˆ)ï¼Œ å¦‚æœæ˜¯çº¯è¿ç®—ä»£ç ï¼Œåˆ™æ¶ˆè€—CPU, å¦‚æœè¢«æŒ‚èµ·ï¼Œåˆ™ä¸æ¶ˆè€—CPU,å¦‚æœæ˜¯IO,åˆ™ä¸æ€ä¹ˆæ¶ˆ è€—CPUã€‚ ä¸‰ã€ç›¸å…³çš„æ’æŸ¥æ–¹æ³•1.CPUç”Ÿäº§ç¯å¢ƒä¸­å¾€å¾€ä¼šå‡ºç°CPUé£™é«˜çš„æƒ…å†µï¼Œå¯¹äºJAVAåº”ç”¨è€Œè¨€ï¼Œæ­¤ç±»é—®é¢˜ç›¸å¯¹è¾ƒå¥½ç¡®å®šé—®é¢˜æ–¹å‘ã€‚ 1.1 ä½¿ç”¨jstackç¡®å®šCPUå ç”¨é«˜çš„çº¿ç¨‹\\é€šè¿‡topæŒ‡ä»¤ï¼Œå¯ä»¥çœ‹åˆ°è¿›ç¨‹å ç”¨çš„ä¸€äº›åŸºç¡€èµ„æºä¿¡æ¯ï¼Œç„¶åâ€œPâ€é”®å¯ä»¥æŒ‰ç…§CPUä½¿ç”¨ç‡è¿›è¡Œæ’åºï¼Œâ€œMâ€é”®å¯ä»¥æŒ‰ç…§å†…å­˜å ç”¨æƒ…å†µè¿›è¡Œæ’åº æ‰¾åˆ°CPUå ç”¨é«˜çš„è¿›ç¨‹pidï¼Œç„¶åå°†jstackä¿¡æ¯å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼Œé€šè¿‡top -Hp pidæŸ¥çœ‹å…·ä½“çš„æƒ…å†µã€‚ é€šè¿‡ printf &#39;%x &#39; pidå°†pidè½¬æ¢ä¸º16è¿›åˆ¶ï¼Œç„¶ååœ¨jstackæ–‡ä»¶ä¸­æ ¹æ®å¯¹åº”çš„æ•°å­—è¿›è¡ŒæŸ¥æ‰¾ï¼Œç„¶åé’ˆå¯¹æ€§çš„è¿›è¡Œåˆ†æ 1.2 é¢‘ç¹GCæœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥å…ˆç¡®å®šä¸‹gcæ˜¯ä¸æ˜¯å¤ªé¢‘ç¹ï¼Œä½¿ç”¨jstat -gc pid 1000å‘½ä»¤æ¥å¯¹gcåˆ†ä»£å˜åŒ–æƒ…å†µè¿›è¡Œè§‚å¯Ÿï¼Œ1000è¡¨ç¤ºé‡‡æ ·é—´éš”(ms)ï¼ŒS0C/S1Cã€S0U/S1Uã€EC/EUã€OC/OUã€MC/MUåˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªSurvivoråŒºã€EdenåŒºã€è€å¹´ä»£ã€å…ƒæ•°æ®åŒºçš„å®¹é‡å’Œä½¿ç”¨é‡ã€‚YGC/YGTã€FGC/FGCTã€GCTåˆ™ä»£è¡¨YoungGcã€FullGcçš„è€—æ—¶å’Œæ¬¡æ•°ä»¥åŠæ€»è€—æ—¶ã€‚å¦‚æœçœ‹åˆ°gcæ¯”è¾ƒé¢‘ç¹ï¼Œå†é’ˆå¯¹gcæ–¹é¢åšè¿›ä¸€æ­¥åˆ†æã€‚ 1.3 é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢é’ˆå¯¹é¢‘ç¹ä¸Šä¸‹æ–‡é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨vmstatå‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹cs(context switch)ä¸€åˆ—åˆ™ä»£è¡¨äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ã€‚ å¦‚æœæˆ‘ä»¬å¸Œæœ›å¯¹ç‰¹å®šçš„pidè¿›è¡Œç›‘æ§é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ pidstat -w pidå‘½ä»¤ï¼Œcswchå’Œnvcswchè¡¨ç¤ºè‡ªæ„¿åŠéè‡ªæ„¿åˆ‡æ¢ã€‚ 2.å†…å­˜å¯¹äºJAVAåº”ç”¨ï¼Œæ¶‰åŠåˆ°çš„å†…å­˜é—®é¢˜ä¸»è¦åŒ…æ‹¬OOMã€GCé—®é¢˜å’Œå †å¤–å†…å­˜ã€‚ 2.1 OOMJVMä¸­çš„å†…å­˜ä¸è¶³ï¼ŒOOMå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µ Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: unable to create new native thread è¿™ä¸ªæ„æ€æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ç»™çº¿ç¨‹åˆ†é…javaæ ˆï¼ŒåŸºæœ¬ä¸Šè¿˜æ˜¯çº¿ç¨‹æ± ä»£ç å†™çš„æœ‰é—®é¢˜ï¼Œæ¯”å¦‚è¯´å¿˜è®°shutdownï¼Œæ‰€ä»¥è¯´åº”è¯¥é¦–å…ˆä»ä»£ç å±‚é¢æ¥å¯»æ‰¾é—®é¢˜ï¼Œä½¿ç”¨jstackæˆ–è€…jmapã€‚å¦‚æœä¸€åˆ‡éƒ½æ­£å¸¸ï¼ŒJVMæ–¹é¢å¯ä»¥é€šè¿‡æŒ‡å®šXssæ¥å‡å°‘å•ä¸ªthread stackçš„å¤§å°ã€‚å¦å¤–ä¹Ÿå¯ä»¥åœ¨ç³»ç»Ÿå±‚é¢ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹/etc/security/limits.confnofileå’Œnprocæ¥å¢å¤§oså¯¹çº¿ç¨‹çš„é™åˆ¶ Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space è¿™ä¸ªæ„æ€æ˜¯å †çš„å†…å­˜å ç”¨å·²ç»è¾¾åˆ°-Xmxè®¾ç½®çš„æœ€å¤§å€¼ï¼Œåº”è¯¥æ˜¯æœ€å¸¸è§çš„OOMé”™è¯¯äº†ã€‚è§£å†³æ€è·¯ä»ç„¶æ˜¯å…ˆåº”è¯¥åœ¨ä»£ç ä¸­æ‰¾ï¼Œæ€€ç–‘å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œé€šè¿‡jstackå’Œjmapå»å®šä½é—®é¢˜ã€‚å¦‚æœè¯´ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œæ‰éœ€è¦é€šè¿‡è°ƒæ•´Xmxçš„å€¼æ¥æ‰©å¤§å†…å­˜ã€‚ Caused by: java.lang.OutOfMemoryError: Meta space è¿™ä¸ªæ„æ€æ˜¯å…ƒæ•°æ®åŒºçš„å†…å­˜å ç”¨å·²ç»è¾¾åˆ°XX:MaxMetaspaceSizeè®¾ç½®çš„æœ€å¤§å€¼ï¼Œæ’æŸ¥æ€è·¯å’Œä¸Šé¢çš„ä¸€è‡´ï¼Œå‚æ•°æ–¹é¢å¯ä»¥é€šè¿‡XX:MaxPermSizeæ¥è¿›è¡Œè°ƒæ•´ Exception in thread &quot;main&quot; java.lang.StackOverflowError è¡¨ç¤ºçº¿ç¨‹æ ˆéœ€è¦çš„å†…å­˜å¤§äºXsså€¼ï¼ŒåŒæ ·ä¹Ÿæ˜¯å…ˆè¿›è¡Œæ’æŸ¥ï¼Œå‚æ•°æ–¹é¢é€šè¿‡Xssæ¥è°ƒæ•´ï¼Œä½†è°ƒæ•´çš„å¤ªå¤§å¯èƒ½åˆä¼šå¼•èµ·OOMã€‚ 2.2 GCé—®é¢˜gcé—®é¢˜é™¤äº†å½±å“cpuä¹Ÿä¼šå½±å“å†…å­˜ï¼Œæ’æŸ¥æ€è·¯ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚ä¸€èˆ¬å…ˆä½¿ç”¨jstatæ¥æŸ¥çœ‹åˆ†ä»£å˜åŒ–æƒ…å†µï¼Œæ¯”å¦‚youngGCæˆ–è€…fullGCæ¬¡æ•°æ˜¯ä¸æ˜¯å¤ªå¤šå‘€ï¼›EUã€OUç­‰æŒ‡æ ‡å¢é•¿æ˜¯ä¸æ˜¯å¼‚å¸¸ç­‰ã€‚ çº¿ç¨‹çš„è¯å¤ªå¤šè€Œä¸”ä¸è¢«åŠæ—¶gcä¹Ÿä¼šå¼•å‘oomï¼Œå¤§éƒ¨åˆ†å°±æ˜¯ä¹‹å‰è¯´çš„unable to create new native threadã€‚é™¤äº†jstackç»†ç»†åˆ†ædumpæ–‡ä»¶å¤–ï¼Œæˆ‘ä»¬ä¸€èˆ¬å…ˆä¼šçœ‹ä¸‹æ€»ä½“çº¿ç¨‹ï¼Œé€šè¿‡pstreee -p pid |wc -l 2.3 å †å¤–å†…å­˜JVM çš„å †å¤–å†…å­˜ä¸»è¦åŒ…æ‹¬ï¼š JVM è‡ªèº«è¿è¡Œå ç”¨çš„ç©ºé—´ï¼› çº¿ç¨‹æ ˆåˆ†é…å ç”¨çš„ç³»ç»Ÿå†…å­˜ï¼› DirectByteBuffer å ç”¨çš„å†…å­˜ï¼› JNI é‡Œåˆ†é…çš„å†…å­˜ï¼› Java 8 å¼€å§‹çš„å…ƒæ•°æ®ç©ºé—´ï¼› NIO ç¼“å­˜ Unsafe è°ƒç”¨åˆ†é…çš„å†…å­˜ï¼› codecache å†°å±±å¯¹è±¡ï¼šå†°å±±å¯¹è±¡æ˜¯æŒ‡åœ¨ JVM å †é‡Œå ç”¨çš„å†…å­˜å¾ˆå°ï¼Œä½†å…¶å®å¼•ç”¨äº†ä¸€å—å¾ˆå¤§çš„æœ¬åœ°å†…å­˜ã€‚DirectByteBuffer å’Œ çº¿ç¨‹éƒ½å±äºè¿™ç±»å¯¹è±¡ã€‚ 2.3.1NMTåˆ†æå †å¤–å†…å­˜NMTï¼ˆNative Memory Trackingï¼‰æ˜¯ HotSpot JVM å¼•å…¥çš„è·Ÿè¸ª JVM å†…éƒ¨ä½¿ç”¨çš„æœ¬åœ°å†…å­˜çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡ jcmd å·¥å…·è®¿é—® NMT æ•°æ®ã€‚NMT ç›®å‰ä¸æ”¯æŒè·Ÿè¸ªç¬¬ä¸‰æ–¹æœ¬åœ°ä»£ç çš„å†…å­˜åˆ†é…å’Œ JDK ç±»åº“ã€‚ NMT ä¸è·Ÿè¸ªé JVM ä»£ç çš„å†…å­˜åˆ†é…ï¼Œæœ¬åœ°ä»£ç é‡Œçš„å†…å­˜æ³„éœ²éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„å·¥å…·æ¥å®šä½ã€‚ 2.3.2 å¼€å¯ NMTå¯ç”¨ NMT ä¼šå¸¦æ¥ 5-10% çš„æ€§èƒ½æŸå¤±ã€‚NMT çš„å†…å­˜ä½¿ç”¨ç‡æƒ…å†µéœ€è¦æ·»åŠ ä¸¤ä¸ªæœºå™¨å­— word åˆ° malloc å†…å­˜çš„ malloc å¤´é‡Œã€‚NMT å†…å­˜ä½¿ç”¨ç‡ä¹Ÿè¢« NMT è·Ÿè¸ªã€‚å¯åŠ¨å‘½ä»¤ï¼š -XX:NativeMemoryTracking=[off | summary | detail]ã€‚ offï¼šNMT é»˜è®¤æ˜¯å…³é—­çš„ï¼› summaryï¼šåªæ”¶é›†å­ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨çš„æ€»è®¡æ•°æ®ï¼› detailï¼šæ”¶é›†æ¯ä¸ªè°ƒç”¨ç‚¹çš„å†…å­˜ä½¿ç”¨æ•°æ®ã€‚ 2.3.3 jcmd è®¿é—® NMT æ•°æ®å‘½ä»¤ï¼šjcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]","tags":["JAVA","Linux"],"categories":["é—®é¢˜æ’æŸ¥"]},{"title":"ä¸ªäººä»‹ç»","path":"/about/index.html","content":"ç®€ä»‹ èŒä¸š: è¿ç»´å¼€å‘å·¥ç¨‹å¸ˆ å‡ºç”Ÿæ—¶é—´: 98å¹´ æ€§åˆ«: ç”· è”ç³»æ–¹å¼: &#x34;&#52;&#x36;&#x33;&#48;&#50;&#x38;&#x36;&#x34;&#x40;&#x71;&#x71;&#46;&#99;&#x6f;&#109;&#x2F;&#x62;&#x61;&#105;&#x78;&#105;&#x61;&#111;&#122;&#x68;&#x6f;&#x75;&#x39;&#54;&#x40;&#x67;&#x6d;&#97;&#105;&#x6c;&#46;&#99;&#111;&#109; å·¥ä½œå±¥å† 2020.7-2023.6 æ­å·é½æ²»ç§‘æŠ€ è½¯ä»¶å¼€å‘å·¥ç¨‹å¸ˆ 2023.7-2024.1 è…¾è®¯äº‘ ES SRE 2024.3- é‡‘å±±äº‘ SRE ä¸ªäººé¡¹ç›® SysStress è‡ªå·±å†™çš„ä¸€ä¸ªæ€§èƒ½å‹æµ‹å·¥å…·ï¼Œè¿˜åœ¨ä¸æ–­å®Œå–„ä¸­"},{"title":"ä¸ªäººä»‹ç»","path":"/friends/index.html","content":"Test"},{"path":"/comments/index.html","content":"ç•™è¨€æ¿ æ¬¢è¿å¤§å®¶åœ¨è¿™é‡Œè¿›è¡Œç•™è¨€ï¼Œè¿›è¡Œé—®é¢˜æ¢è®¨"}]