[{"title":"çº¿ä¸Šæ•…éšœæ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»","path":"/2024/08/15/çº¿ä¸Šé—®é¢˜æ’æŸ¥æ–¹æ³•æ±‡æ€»/","content":"å†™åœ¨å‰é¢ CPUä½¿ç”¨ç‡é£™å‡ å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡ å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡ å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº perfå‘½ä»¤ jstack ç«ç„°å›¾ è´Ÿè½½é£™å‡ è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½ å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜ çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“ ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“ é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“ è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥ å†™åœ¨å‰é¢åœ¨å¾ˆå¤šæ–‡ç« ä¸­ï¼Œæ¯å½“æåˆ°å»è§£å†³çº¿ä¸Šé—®é¢˜çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†çš„å¤„ç†æ–¹å¼å°±æ˜¯ç™»å½•ç¯å¢ƒï¼Œå“å“å„ç§æ•²å‘½ä»¤ã€‚æ“ä½œæœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—è¿™ç§åšæ³•å…¶å®æ˜¯æœ¬æœ«å€’ç½®çš„ï¼Œè¿‡äºåœ¨ä¹å»å¿«é€ŸæŠ“ä½é‡ç‚¹é—®é¢˜ï¼Œè€Œå¿½ç•¥äº†ä»å…¨å±€å»çœ‹é—®é¢˜ã€‚é‚£ä¹ˆå¦‚æœæœ€å¼€å§‹ä¸å»æ“ä½œå„ç§å‘½ä»¤ï¼Œé‚£åº”è¯¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ çœ‹ç›‘æ§ï¼ï¼ï¼ï¼ é¦–å…ˆä¸è¦è§‰å¾—è¿™ä¸ªæ˜¯åºŸè¯ï¼Œå¯¹äºå¾ˆå¤šåœºæ™¯æ¥è¯´ï¼Œä¸šåŠ¡è§„æ¨¡æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæœ‰çš„æ—¶å€™å¹¶å‘è¶…è¿‡äº†æé™çš„æ€§èƒ½ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹éƒ½æ²¡æœ‰å¿…è¦å»åå°è¿›è¡Œå„ç§æŸ¥è¯¢ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡å¦‚è¯´æŸå¥—ä¸šåŠ¡ç³»ç»Ÿï¼Œæœ¬èº«åªèƒ½æ”¯æŒ 500 å¹¶å‘ï¼Œç°åœ¨å®é™…ä¸Šçš„é‡åˆ°äº† 2000ï¼Œå¯¼è‡´çº¿ä¸Šå„ç§å†…å­˜ã€CPUã€è´Ÿè½½çš„å‘Šè­¦ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜æœ‰å¿…è¦å»åå°æ•²topã€freeå—ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è€ƒè™‘å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œå¿«é€Ÿçš„æ‰©å®¹ç­‰ã€‚ çœ‹ç›‘æ§çš„æ„ä¹‰åœ¨äºå°½å¯èƒ½çš„æ‰¾åˆ°æ›´å¤šçš„æ€§èƒ½ç“¶é¢ˆæˆ–è€…å¼‚å¸¸çš„ç‚¹ï¼Œä»å…¨å±€å‡ºå‘ï¼Œå¯¹ç³»ç»Ÿå½“å‰å­˜åœ¨çš„é—®é¢˜å’Œå¼‚å¸¸ç‚¹æœ‰å…¨é¢çš„äº†è§£ã€‚ ç›‘æ§ç³»ç»Ÿå¤šç§å¤šæ ·ï¼Œä»è¾ƒæ—©çš„ zabbix åˆ°ç°åœ¨æ¯”è¾ƒæµè¡Œçš„prometheus+grafanaï¼ˆä¸¾ä¸¤ä¸ªå¸¸ç”¨çš„ä¾‹å­ï¼‰ï¼Œå¯¹äºç³»ç»Ÿä¸šåŠ¡éƒ½æœ‰æ¯”è¾ƒå®Œå–„çš„ç›‘æ§ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ å…·ä½“çš„äº†è§£åˆ°ç³»ç»Ÿè¿è¡Œå…¨è²Œã€‚å¦‚æœä½ å¯¹è¿™äº›éƒ½ä¸å–œæ¬¢ï¼Œé‚£ä¹ˆä½ è‡ªå·±å†™ä¸€ä¸ªç›‘æ§ç³»ç»Ÿä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ å½“æˆ‘ä»¬çœ‹å®Œç›‘æ§ä¹‹åï¼ˆå‡è®¾ä½ çœŸçš„çœ‹äº†ï¼‰ï¼Œæ¥ä¸‹æ¥è¿›å…¥å®é™…æ“ä½œç¯èŠ‚ï¼Œæˆ‘ä¼šä»è¿™äº›æŒ‡æ ‡çš„è¯¦ç»†å«ä¹‰å‡ºå‘ï¼Œç„¶åå°½å¯èƒ½åœ°å°†å„ç§å¤„ç†æ–¹å¼åˆ†äº«ç»™å¤§å®¶ã€‚ CPUä½¿ç”¨ç‡é£™å‡å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œåªè¦æœ‰è®¡ç®—ä»»åŠ¡ä¸€ç›´å­˜åœ¨ï¼Œè®© CPU ä¸€ç›´å¤„äºç¹å¿™ä¹‹ä¸­ï¼Œé‚£ä¹ˆ CPU å¿…ç„¶é£™å‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—çš„å·¥å…·å»æ¨¡æ‹Ÿè¿™ä¸ªæƒ…å†µã€‚ github SysStress è¿™æ˜¯æˆ‘è‡ªå·±ç”¨ golang å†™çš„å‹æµ‹å·¥å…·(è¿˜åœ¨å¼€å‘ä¸­ï¼Œå¯ä»¥ç‚¹ä¸ª star è®©æˆ‘æ›´æœ‰åŠ¨åŠ›ğŸ˜‚) ä½¿ç”¨æ–¹æ³•: 1./sysstress cpu --cpu-number 10 --duration 10m è¿™ä¸ªå°±æ˜¯æ¨¡æ‹Ÿå ç”¨ 10 æ ¸å¿ƒçš„ CPU å¹¶æŒç»­ 10minï¼Œå½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„å‹æµ‹å·¥å…·ï¼Œæ¯”å¦‚stress-ng å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œè·Ÿ CPU ä½¿ç”¨ç‡ç›¸å…³çš„æœ‰å“ªäº›æŒ‡æ ‡ã€‚æˆ‘ä»¬é€šè¿‡ top å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„ä¿¡æ¯ top è¿™äº›è¾“å‡ºä¸­æœ‰ä¸€è¡Œæ˜¯ %Cpu(s), è¿™è¡Œå±•ç¤ºäº† CPU çš„æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”çš„å½¢å¼ï¼Œæˆ‘ä»¬è¯¦ç»†é˜è¿°ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰ 12345678us, user : time running un-niced user processes æœªé™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´sy, system : time running kernel processes å†…æ ¸è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´ni, nice : time running niced user processes é™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´id, idle : time spent in the kernel idle handler ç©ºé—²çš„æ—¶é—´wa, IO-wait : time waiting for I/O completion ç­‰å¾… I/O æ“ä½œå®Œæˆæ‰€èŠ±è´¹çš„æ—¶é—´hi : time spent servicing hardware interrupts å¤„ç†ç¡¬ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´si : time spent servicing software interrupts å¤„ç†è½¯ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´st : time stolen from this vm by the hypervisor è¢«è™šæ‹Ÿæœºç®¡ç†ç¨‹åºä»æ­¤è™šæ‹Ÿæœºä¸­çªƒå–çš„æ—¶é—´ åœ¨è¿™äº›æŒ‡æ ‡ä¸­ï¼Œä¸€èˆ¬å…³æ³¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ usã€syã€idã€waï¼ˆå…¶ä»–å‡ ä¸ªæŒ‡æ ‡å¾ˆé«˜çš„æƒ…å†µæˆ‘ä¸ªäººç›®å‰åŸºæœ¬ä¸Šæ²¡æœ‰é‡åˆ°è¿‡ï¼‰ ä¸Šè¿°æŒ‡æ ‡åæ˜ äº†ç³»ç»Ÿæ•´ä½“çš„ CPU æƒ…å†µã€‚è€Œç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­å®é™…ä¸Šæ˜¯ä»¥ä¸€ä¸ªä¸ªçš„è¿›ç¨‹å­˜åœ¨çš„ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•ç¡®å®šåˆ°å ç”¨ CPU é«˜çš„è¿›ç¨‹å‘¢ï¼Ÿè®©æˆ‘ä»¬çš„ç›®å…‰ä» top çš„å¤´éƒ¨ä¿¡æ¯å¾€ä¸‹ç§»åŠ¨ï¼Œä¸‹é¢å°±å±•ç¤ºäº†è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯ top-process è¿™äº›ç¨‹åºé»˜è®¤æ˜¯æŒ‰ç…§ CPU çš„ä½¿ç”¨ç‡ä»é«˜åˆ°åº•è¿›è¡Œæ’åºçš„ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨topçš„æ—¶å€™è¾“å…¥Pè¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ¶ˆè€— CPU èµ„æºçš„è¯¦ç»†è¿›ç¨‹ä¿¡æ¯ ä¸Šé¢æ˜¯æˆ‘é€šè¿‡ ./sysstress cpu --cpu-number 10 --duration 10m å‹æµ‹ç¨‹åºè·‘å‡ºæ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ sysstress ç¨‹åºå ç”¨äº† 1002 çš„ %CPUï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬ä¸Šæ˜¯ 10 ä¸ªæ ¸å¿ƒï¼Œé‚£æˆ‘ä»¬è·‘ä¸€ä¸ªæ›´é«˜çš„ï¼Œå°†--cpu-numberåŠ åˆ° 60 çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ stress-cpu æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¬¡%CPUæ‰“åˆ°äº† 6000ï¼Œé‚£å¾ˆå¤šäººå°±å¥½å¥‡æˆ‘æ—¥å¸¸çš„ç¨‹åºè·‘åˆ°å¤šé«˜ç®—é«˜å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼Œç°åœ¨çš„æœåŠ¡å™¨ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤šæ ¸å¿ƒ CPUï¼ˆ1C2Gè¿™ç§è‡ªå·±ç”¨æ¥ç©çš„å¿½ç•¥ï¼‰ï¼ŒCPU çš„æ ¸å¿ƒæ•°å†³å®šäº†æˆ‘ä»¬ç¨‹åºåœ¨åŒä¸€æ—¶é—´èƒ½å¤Ÿæ‰§è¡Œå¤šå°‘ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé«˜ä¸é«˜æ˜¯ç›¸å¯¹äºæœºå™¨é…ç½®è€Œè¨€çš„ã€‚å¦‚æœä½ çš„æœºå™¨åªæœ‰ 16Cï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 1000ï¼Œé‚£ä¹ˆå…¶å®å·²ç»ç®—æ˜¯æ¯”è¾ƒé«˜äº†ã€‚å¦‚æœæ˜¯ 256C çš„CPUï¼ˆåœŸè±ªçº§é…ç½®ï¼‰ï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 6000ï¼Œå¯¹äºç³»ç»Ÿçš„ç¨³å®šæ€§å½±å“å°±æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚ ä¸Šè¿°æˆ‘ä»¬è¯´çš„æƒ…å†µæ˜¯è¿›ç¨‹å ç”¨ CPU å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œé‚£ä¹ˆè¿›ç¨‹å ç”¨çš„ CPU å¯¹ç³»ç»Ÿçš„å½±å“ä¸å¤§å°±ä»£è¡¨è¿™ä¸ªç¨‹åºä¸€å®šæ²¡æœ‰é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯æœªå¿…çš„ã€‚ æˆ‘ä»¬è¿˜æ˜¯è¦å›å½’åˆ°ä¸šåŠ¡æœ¬èº«ï¼Œå¦‚æœè¿›ç¨‹çš„ CPU å ç”¨åœ¨ä¸šåŠ¡å˜åŠ¨ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿäº†å¼‚å¸¸æ³¢åŠ¨ï¼Œæˆ–è€…æ­£å¸¸æƒ…å†µä¸‹ä¸šåŠ¡ä¸ä¼šæ¶ˆè€—è¿™ä¹ˆé«˜çš„ CPUï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»§ç»­æ’æŸ¥äº†ã€‚ å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æºè¿™ä¸ªé—®é¢˜çš„ æ ¸å¿ƒæ˜¯ CPU ä¸Šåœ¨è¿è¡Œä»€ä¹ˆä¸œè¥¿ã€‚ å¤šæ ¸å¿ƒCPU ä¸‹ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½å¯ä»¥æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šä¸€ä¸ªè¿›ç¨‹ä¸­é‚£äº›æ–¹æ³•åœ¨æ¶ˆè€— CPU å‘¢ï¼Ÿä»è€Œå¼•ç”³ä¸‹é¢è¯¦ç»†çš„é—®é¢˜: ç¨‹åºçš„è°ƒç”¨æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ è°ƒç”¨æ ˆä¿¡æ¯ä¸­å“ªäº›æ˜¯éœ€è¦å…³æ³¨çš„ï¼Œé‚£äº›æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Ÿ çƒ­ç‚¹å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿ è€è¯è¯´å¾—å¥½ï¼Œâ€å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨â€, æˆ‘ä»¬éœ€è¦è¿™äº›ä¸œè¥¿ï¼Œå°±å¿…é¡»äº†è§£åˆ°ä»€ä¹ˆæ ·çš„å·¥å…·å¯ä»¥æ‹¿åˆ°ä¸Šé¢æˆ‘æåˆ°çš„ä¸€äº›ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘å°†é€šè¿‡å¸¸ç”¨çš„åç«¯è¯­è¨€ï¼šgolang å’Œ java ä¸ºä¾‹æ„é€ ä¸€äº›é«˜ CPU çš„ç¨‹åºæ¥è¿›è¡Œå±•ç¤ºã€‚ perfå‘½ä»¤perfæ˜¯ä¸€æ¬¾Linuxæ€§èƒ½åˆ†æå·¥å…·ã€‚Linuxæ€§èƒ½è®¡æ•°å™¨æ˜¯ä¸€ä¸ªæ–°çš„åŸºäºå†…æ ¸çš„å­ç³»ç»Ÿï¼Œå®ƒæä¾›ä¸€ä¸ªæ€§èƒ½åˆ†ææ¡†æ¶ï¼Œæ¯”å¦‚ç¡¬ä»¶ï¼ˆCPUã€PMU(Performance Monitoring Unit)ï¼‰åŠŸèƒ½å’Œè½¯ä»¶(è½¯ä»¶è®¡æ•°å™¨ã€tracepoint)åŠŸèƒ½ã€‚ å®‰è£…: 1yum install perf #Centos å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆçœ‹ä¸‹ perfçš„ç”¨æ³•ï¼Œè¿™é‡Œä¸å±•å¼€å…·ä½“ç”¨æ³•ï¼Œåªåˆ—å‡ºæˆ‘å¹³å¸¸ä½¿ç”¨çš„å‡ ä¸ªå‘½ä»¤: 123top System profiling tool. #å¯¹ç³»ç»Ÿæ€§èƒ½è¿›è¡Œå®æ—¶åˆ†æã€‚record Run a command and record its profile into perf.data #æ”¶é›†é‡‡æ ·ä¿¡æ¯report Read perf.data (created by perf record) and display the profile #åˆ†æé‡‡æ ·ä¿¡æ¯ï¼Œå’Œrecordé…åˆä½¿ç”¨ record å’Œ report çš„ä½¿ç”¨æ›´å¤šåœ¨äº dump å½“å‰ç¯å¢ƒçš„ä¿¡æ¯ç”¨äºåç»­åˆ†æï¼Œå¦‚æœåœ¨è‡ªå·±ç¯å¢ƒä¸Šæµ‹è¯•ï¼Œå¯ä»¥ç”¨ top è¿›è¡Œä¸€äº›ç®€å•çš„å®æ—¶åˆ†æï¼ˆç±»ä¼¼äº top å‘½ä»¤ï¼‰ã€‚ è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‹æµ‹å·¥å…·ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ª 10 æ ¸å¿ƒçš„ 10min çš„å‹æµ‹åœºæ™¯ 1nohup ./sysstress cpu --cpu-number 10 --duration 10m &gt; /dev/null 2&gt;&amp;1 &amp; æ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼Œè®©å‹æµ‹ç¨‹åºåœ¨åå°æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬é€šè¿‡perf topæŸ¥çœ‹å…·ä½“çš„æƒ…å†µï¼ˆå¯ä»¥é€šè¿‡-p æŒ‡å®š pidï¼‰ perf top, ä»æˆªå›¾çš„ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å ç”¨èµ„æºæœ€å¤šçš„ä¸€äº›æ–¹æ³•ï¼ŒåŒ…æ‹¬ sysstress è¿›ç¨‹çš„å„ç§æ–¹æ³•(ä»å›¾ç‰‡ä¸­åŸºæœ¬ä¸Šå°±å¯ä»¥ç¡®å®šé«˜æ¶ˆè€—çš„æ–¹æ³•åœ¨å“ªé‡Œ)ä»¥åŠåº•å±‚çš„ __vdso_clock_gettime, é‚£å†ç»“åˆå‹æµ‹å·¥å…·çš„ä»£ç åˆ†æä¸‹: 12345678910func burnCpu(wg *sync.WaitGroup, start time.Time, durSec int64) &#123;\tdefer wg.Done()\tfor &#123; _ = 1 * 1 now := time.Now() if now.Sub(start) &gt; time.Duration(durSec)*time.Second &#123; break &#125;\t&#125;&#125; è¿™æ˜¯æ–¹æ³•çš„æ ¸å¿ƒï¼Œå…¶å®å°±æ˜¯åšæ— æ„ä¹‰çš„è®¡ç®—ï¼Œå¤–åŠ æ—¶é—´çš„åˆ¤æ–­ï¼Œè¶…è¿‡ duration å°±ç»“æŸã€‚è¿™æ ·å’Œä¸Šé¢çš„ perf top ä¿¡æ¯å°±èƒ½å¯¹åº”èµ·æ¥ã€‚ ç„¶åæˆ‘ä»¬ç”¨ java å†™ä¸€ä¸ªåŒæ ·çš„ç¨‹åºï¼Œå†çœ‹çœ‹ perf topçš„æƒ…å†µ: perf top, ä»è¿™ä¸€å¤§æ®µæ˜¾ç¤ºæ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯çœ‹çš„ä¸€è„¸æ‡µé€¼ï¼Œå¾ˆéš¾å‘ç°åˆ°åº•æ˜¯ä»€ä¹ˆç¨‹åºåœ¨å ç”¨CPU èµ„æºã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æºç¨‹åº: 123456789101112131415161718import java.time.LocalDateTime;public class Main &#123; public static void main(String[] args) &#123; int n = 10; for (int i = 0; i &lt; 10; i++) &#123; new Thread(new Runnable() &#123; public void run() &#123; while (true) &#123; Math.sin(Math.random()); LocalDateTime currentTime = LocalDateTime.now(); &#125; &#125; &#125;).start(); &#125; &#125;&#125; è¿™é‡Œçš„ç¨‹åºä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼Œåšä¸€ä¸ªæ— æ„ä¹‰çš„æ•°å­¦è¿ç®—ï¼Œç„¶åè·å–å½“å‰æ—¶é—´ã€‚ä»è¿™æ®µä»£ç ä¸­æ˜¯ä¸æ˜¯å¾ˆéš¾å’Œä¸Šé¢perf topçš„æ˜¾ç¤ºå…³è”èµ·æ¥ï¼Ÿ åŸå› ä¹Ÿéå¸¸ç®€å•ï¼Œ åƒJava è¿™ç§é€šè¿‡ JVM æ¥è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå †æ ˆç”¨çš„éƒ½æ˜¯ JVM å†…ç½®çš„å‡½æ•°å’Œå †æ ˆç®¡ç†ã€‚æ‰€ä»¥ï¼Œä»ç³»ç»Ÿå±‚é¢åªèƒ½çœ‹åˆ° JVM çš„å‡½æ•°å †æ ˆï¼Œè€Œä¸èƒ½ç›´æ¥å¾—åˆ° Java åº”ç”¨ç¨‹åºçš„å †æ ˆã€‚é‚£æˆ‘ä»¬å¥½èƒ½é€šè¿‡ perf å»çœ‹åˆ° java ç›¸å…³çš„å †æ ˆå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚ å¯ä»¥å€ŸåŠ© perf-map-agent è¿™æ ·çš„å¼€æºå·¥å…·ï¼Œå»ç”Ÿæˆå’Œperf å·¥å…·ä¸€èµ·ä½¿ç”¨çš„æ–¹æ³•æ˜ å°„ï¼Œä½†æ˜¯éœ€è¦åšé¢å¤–çš„ä¸€äº›é…ç½®ã€‚è¿™é‡Œçš„æ–¹æ³•å¤§å®¶å¯ä»¥è‡ªå·±æ¢ç©¶ï¼Œä¸ºä»€ä¹ˆä¸è¯¦ç»†çš„è®²è¿™ä¸ªå‘¢ï¼ŒåŸå› ä¹Ÿç®€å•ï¼Œæ’æŸ¥é—®é¢˜çš„å·¥å…·å¤šç§å¤šæ ·ï¼Œæ²¡å¿…è¦åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»ã€‚ jstackæ—¢ç„¶ perf top å»æŸ¥çœ‹ JAVA çš„è°ƒç”¨æ ˆä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸Š java æä¾›çš„ jstack å·¥å…·å»åˆ†æã€‚ jstack -l pid &gt; xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼ kill -3ï¼Œ jstack ç”¨ä¸äº†çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ kill -3 pid çš„å½¢å¼ï¼Œå †æ ˆä¼šè¾“å‡ºåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ã€‚ å…·ä½“çš„æ“ä½œæ­¥éª¤: top -Hp $pid æ‰¾åˆ°å ç”¨ CPU çš„å…·ä½“çº¿ç¨‹ jstack -l $pid &gt; /tmp/$pid.jstack æˆ–è€… kill -3 $pidå°† java è¿›ç¨‹çš„å †æ ˆæƒ…å†µè¾“å‡ºçš„æ—¥å¿—ä¸­ï¼Œç„¶åæ ¹æ® top -Hp çœ‹åˆ°çš„çº¿ç¨‹ä¿¡æ¯åœ¨è¾“å‡ºçš„å †æ ˆæ—¥å¿—ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ˆtop -Hp è¾“å‡ºçš„æ˜¯ 10 è¿›åˆ¶çš„ idï¼Œjstack è¾“å‡ºçš„æ˜¯ 16 è¿›åˆ¶çš„ï¼Œåœ¨æŸ¥æ‰¾æ—¶æ³¨æ„è¿›åˆ¶è½¬æ¢ï¼‰ æˆ‘ä»¬çœ‹ä¸‹ä¸Šé¢ java ç¨‹åºçš„å †æ ˆçš„ä¿¡æ¯: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151162024-08-16 15:15:40Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.221-b11 mixed mode):&quot;Attach Listener&quot; #35 daemon prio=9 os_prio=0 tid=0x00007f52b4001000 nid=0x71f4 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;DestroyJavaVM&quot; #34 prio=5 os_prio=0 tid=0x00007f53e0009800 nid=0x1693 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;Thread-1&quot; #25 prio=5 os_prio=0 tid=0x00007f53e015a800 nid=0x16d9 runnable [0x00007f52f64e3000] java.lang.Thread.State: RUNNABLE\tat sun.misc.Unsafe.getObjectVolatile(Native Method)\tat java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)\tat java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)\tat java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)\tat java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)\tat java.time.ZoneRegion.ofId(ZoneRegion.java:120)\tat java.time.ZoneId.of(ZoneId.java:411)\tat java.time.ZoneId.of(ZoneId.java:359)\tat java.time.ZoneId.of(ZoneId.java:315)\tat java.util.TimeZone.toZoneId(TimeZone.java:556)\tat java.time.ZoneId.systemDefault(ZoneId.java:274)\tat java.time.Clock.systemDefaultZone(Clock.java:178)\tat java.time.LocalDateTime.now(LocalDateTime.java:180)\tat Main$1.run(Main.java:12)\tat java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers:\t- None&quot;Thread-0&quot; #24 prio=5 os_prio=0 tid=0x00007f53e0159000 nid=0x16d8 runnable [0x00007f52f65e4000] java.lang.Thread.State: RUNNABLE\tat sun.misc.Unsafe.getObjectVolatile(Native Method)\tat java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)\tat java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)\tat java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)\tat java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)\tat java.time.ZoneRegion.ofId(ZoneRegion.java:120)\tat java.time.ZoneId.of(ZoneId.java:411)\tat java.time.ZoneId.of(ZoneId.java:359)\tat java.time.ZoneId.of(ZoneId.java:315)\tat java.util.TimeZone.toZoneId(TimeZone.java:556)\tat java.time.ZoneId.systemDefault(ZoneId.java:274)\tat java.time.Clock.systemDefaultZone(Clock.java:178)\tat java.time.LocalDateTime.now(LocalDateTime.java:180)\tat Main$1.run(Main.java:12)\tat java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers:\t- None --- 10 ä¸ª thread&quot;Service Thread&quot; #23 daemon prio=9 os_prio=0 tid=0x00007f53e0143800 nid=0x16d6 runnable [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;C2 CompilerThread1&quot; #6 daemon prio=9 os_prio=0 tid=0x00007f53e010e000 nid=0x16c5 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None --- ä¸€å¤§å † C2 CompilerThread&quot;C2 CompilerThread0&quot; #5 daemon prio=9 os_prio=0 tid=0x00007f53e010b000 nid=0x16c4 waiting on condition [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f53e0109800 nid=0x16c3 runnable [0x0000000000000000] java.lang.Thread.State: RUNNABLE Locked ownable synchronizers:\t- None&quot;Finalizer&quot; #3 daemon prio=8 os_prio=0 tid=0x00007f53e00d8800 nid=0x16c2 in Object.wait() [0x00007f52f7bfa000] java.lang.Thread.State: WAITING (on object monitor)\tat java.lang.Object.wait(Native Method)\t- waiting on &lt;0x000000008021a5e8&gt; (a java.lang.ref.ReferenceQueue$Lock)\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)\t- locked &lt;0x000000008021a5e8&gt; (a java.lang.ref.ReferenceQueue$Lock)\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)\tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216) Locked ownable synchronizers:\t- None&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=0 tid=0x00007f53e00d3800 nid=0x16c1 in Object.wait() [0x00007f52f7cfb000] java.lang.Thread.State: WAITING (on object monitor)\tat java.lang.Object.wait(Native Method)\t- waiting on &lt;0x0000000080218d38&gt; (a java.lang.ref.Reference$Lock)\tat java.lang.Object.wait(Object.java:502)\tat java.lang.ref.Reference.tryHandlePending(Reference.java:191)\t- locked &lt;0x0000000080218d38&gt; (a java.lang.ref.Reference$Lock)\tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153) Locked ownable synchronizers:\t- None&quot;VM Thread&quot; os_prio=0 tid=0x00007f53e00ca000 nid=0x16c0 runnable&quot;GC task thread#0 (ParallelGC)&quot; os_prio=0 tid=0x00007f53e001f000 nid=0x1694 runnable--- ä¸€å¤§å † GC task thread&quot;VM Periodic Task Thread&quot; os_prio=0 tid=0x00007f53e0146000 nid=0x16d7 waiting on conditionJNI global references: 202 æˆ‘ä»¬é€šè¿‡ top -Hp çš„ä¿¡æ¯å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ° Thread-[0-9] è¿™å‡ ä¸ªçº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆéƒ½æ˜¯ java.time.LocalDateTime.now, ä¹Ÿè¯´æ˜äº†è¿™ä¸ªæ–¹æ³•åœ¨ä¸åœæ¶ˆè€— CPUã€‚ï¼ˆä½†æ˜¯ jstack åªèƒ½æ•è·çŸ­æ—¶é—´æˆ–è€…ç¬æ—¶çš„å †æ ˆä¿¡æ¯ï¼Œæ²¡æ³•å¤„ç†é•¿æ—¶é—´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–æ—¶å¯ä»¥å¤šæ‰“å°å‡ æ¬¡æˆ–è€…ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰ è‡³äº jstack çš„è¯¦ç»†ç”¨æ³•ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšå®¢ï¼šjavaé—®é¢˜å®šä½ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰éå¸¸å¤šçš„åˆ†æå·¥å…·ï¼Œpstack\\gstack\\strace\\gdbç­‰ç­‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæ¢ç´¢ä½¿ç”¨ ç«ç„°å›¾ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ“ä½œçš„å‘½ä»¤å’Œæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒç›´è§‚çš„æ–¹å¼èƒ½å¤Ÿç›´æ¥çœ‹åˆ°å„ç§æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶æ¯”é‡ç­‰æƒ…å†µå‘¢ï¼Ÿç«ç„°å›¾å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µè€Œç”Ÿçš„ã€‚ ç«ç„°å›¾çš„åˆ†ç±»æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„åŒ…æ‹¬: CPU ç«ç„°å›¾ (CPU Flame Graph) æè¿°ï¼šå±•ç¤º CPU åœ¨ä¸åŒæ–¹æ³•ä¸Šçš„æ¶ˆè€—æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨æ‰€å ç”¨çš„ CPU æ—¶é—´ã€‚ ç”¨é€”ï¼šç”¨äºåˆ†æ CPU æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å“ªäº›æ–¹æ³•æ¶ˆè€—äº†æœ€å¤šçš„ CPU èµ„æºã€‚ åº”ç”¨ï¼šJavaã€C++ ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€çš„æ€§èƒ½åˆ†æã€‚ å†…å­˜ç«ç„°å›¾ (Memory Flame Graph) æè¿°ï¼šå±•ç¤ºå†…å­˜åˆ†é…æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨åˆ†é…çš„å†…å­˜é‡ã€‚ ç”¨é€”ï¼šç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼ã€è¿‡åº¦å†…å­˜åˆ†é…é—®é¢˜ï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚ åº”ç”¨ï¼šå¸¸ç”¨äºåˆ†æå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¦‚ Java åº”ç”¨çš„å †å†…å­˜åˆ†æã€‚ I&#x2F;O ç«ç„°å›¾ (I&#x2F;O Flame Graph) æè¿°ï¼šå±•ç¤º I&#x2F;O æ“ä½œçš„è€—æ—¶æƒ…å†µï¼Œæ˜¾ç¤ºä¸åŒæ–¹æ³•çš„ I&#x2F;O æ“ä½œå ç”¨çš„æ—¶é—´ã€‚ ç”¨é€”ï¼šç”¨äºåˆ†æåº”ç”¨ç¨‹åºçš„ I&#x2F;O æ€§èƒ½ï¼Œè¯†åˆ«æ…¢é€Ÿæˆ–é¢‘ç¹çš„ I&#x2F;O æ“ä½œã€‚ åº”ç”¨ï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯çš„æ€§èƒ½è°ƒä¼˜ã€‚ æˆ‘ä»¬è¿™é‡Œé€šè¿‡ async-profiler å¯¹æ–‡ç« ä¸Šé¢çš„javaå‹æµ‹ç¨‹åºè¿›è¡ŒæŠ“å–(è¿™ä¸ªå·¥å…·åªèƒ½æŠ“ java çš„) 123tar -xzf async-profiler-3.0-linux-x64.tar.gzcd async-profiler-3.0-linux-x64/bin./asprof -d 60 pid -f /tmp/javastress.html æˆ‘ä»¬ç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ html æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç«ç„°å›¾ä¿¡æ¯ï¼ˆå¯ä»¥åœ¨ç½‘é¡µè¿›è¡Œç‚¹å‡»ï¼ŒæŸ¥çœ‹æ›´ç»†èŠ‚çš„æ–¹æ³•ï¼‰ java ç¨‹åºçš„ç«ç„°å›¾, è¿™æ ·çœ‹èµ·æ¥å°±æ¯” jstackè¿™äº›ä¿¡æ¯æ›´åŠ ç›´è§‚ä¸€ç‚¹ã€‚ è´Ÿè½½é£™å‡è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½æˆ‘ä»¬å…ˆçœ‹ä¸‹ç³»ç»Ÿè´Ÿè½½çš„å®˜æ–¹æè¿°: 1System load averages is the average number of processes that are either in a runnable or uninterruptable state. A process in arunnable state is either using the CPU or waiting to use the CPU. A process in uninterruptable state is waiting for some I/O access,eg waiting for disk. The averages are taken over the three time intervals. Load averages are not normalized for the number of CPUs ina system, so a load average of 1 means a single CPU system is loaded all the time while on a 4 CPU system it means it was idle 75% of the time. ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼è¡¨ç¤ºå¤„äºå¯è¿è¡Œæˆ–ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹çš„å¹³å‡æ•°é‡ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹è¦ä¹ˆæ­£åœ¨ä½¿ç”¨ CPUï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…ä½¿ç”¨ CPUã€‚å¤„äºä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸäº› I&#x2F;O è®¿é—®ï¼Œä¾‹å¦‚ç­‰å¾…ç£ç›˜ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯ loadavg è¿™ä¸ªæ•°å€¼ä½“ç°äº†æŸäº›ç‰¹å®šçŠ¶æ€è¿›ç¨‹çš„æ•°é‡ã€‚ é‚£å¼•ç”³å‡ºä¸¤ä¸ªé—®é¢˜: è¿›ç¨‹çš„çŠ¶æ€æœ‰å“ªäº›ï¼Ÿ å¦‚ä½•åœ¨ Linux ä¸ŠæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ å¯è¿è¡Œå’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆ æŸ¥çœ‹çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ps å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¯”å¦‚é€šè¿‡ps -auxf, æˆ‘ä¹ˆå¯ä»¥çœ‹åˆ°æœ‰ä¸€åˆ—ä¸º STAT,è¿™åˆ—å°±ä»£è¡¨è¯¥è¿›ç¨‹çš„çŠ¶æ€: è¿›ç¨‹çŠ¶æ€ è¿›ç¨‹çš„çŠ¶æ€å’Œå…·ä½“å«ä¹‰: D uninterruptible sleep (usually IO) R running or runnable (on run queue) S interruptible sleep (waiting for an event to complete) T stopped by job control signal t stopped by debugger during the tracing W paging (not valid since the 2.6.xx kernel) X dead (should never be seen) Z defunct (â€œzombieâ€) process, terminated but not reaped by its parent è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å¤„äºä¸å¯ä¸­æ–­çš„çŠ¶æ€çš„è¿›ç¨‹å’Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åˆ†åˆ«ä¸º D å’Œ R,æ¢ä¸ªè¯´æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´é€ æˆè´Ÿè½½å‡é«˜çš„åŸå› ä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªçŠ¶æ€çš„è¿›ç¨‹å¼•èµ·çš„ã€‚ ï¼ˆæ’ä¸ªé¢˜å¤–è¯ï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼ŒX çŠ¶æ€çš„è¿›ç¨‹åº”è¯¥æ˜¯ä¸åº”è¯¥è¢«çœ‹åˆ°çš„ï¼Œ ä½†æ˜¯ä¹‹å‰åœ¨è…¾è®¯äº‘åšESçš„æ—¶å€™ï¼Œå¶ç„¶é—´ç¢°åˆ°äº†ä¸€æ¬¡ï¼Œå½“æ—¶è¿˜æˆªäº†ä¸ªå›¾ç”¨åšç•™å¿µğŸ˜‚ï¼Œä½†æ˜¯æ²¡æœ‰æ•è·åˆ°å…·ä½“çš„ä¿¡æ¯ï¼‰ è´Ÿè½½çš„æŒ‡æ ‡å¯ä»¥é€šè¿‡ top ä»¥åŠ uptime æŒ‡ä»¤è·å– 123:35:00 up 1 day, 46 min, 1 user, load average: 49.16, 18.35, 7.87 è¿™é‡Œå±•ç¤ºäº† loadavg çš„ä¸‰ä¸ªæ•°å€¼: åˆ†åˆ«ä»£è¡¨çš„å«ä¹‰æ˜¯ 1minã€5minã€15min çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½ é‚£æˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿçš„è´Ÿè½½æ˜¯é«˜æ˜¯ä½å‘¢ï¼Ÿ è¿™é‡Œä¸€èˆ¬æœ‰ä¸ªç»éªŒå€¼ï¼Œæˆ‘ä»¬ä¸€èˆ¬å’Œ CPU å’Œæ ¸å¿ƒæ•°è¿›è¡Œå¯¹æ¯”ï¼Œä¸€èˆ¬è´Ÿè½½åœ¨ CPU æ ¸å¿ƒçš„ 70% å·¦å³ä»¥åŠä»¥ä¸‹ï¼Œå¯¹ç³»ç»Ÿä¸€èˆ¬æ²¡ä»€ä¹ˆå½±å“ï¼Œè¶…è¿‡ 70%ï¼Œç³»ç»Ÿå¯èƒ½æ”¶åˆ°å½±å“ã€‚ä½†æ˜¯è¿™é‡Œè¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œè´Ÿè½½çš„æ¯”ä¾‹åœ¨ 70% ä»¥ä¸‹æ—¶ä¸ä¸€å®šä»£è¡¨ç³»ç»Ÿå°±æ²¡é—®é¢˜ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿä¸ŠåŸºæœ¬ä¸Šæ²¡æœ‰ä¸šåŠ¡åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè´Ÿè½½åŸºæœ¬ä¸Šå°±åœ¨é›¶ç‚¹å‡ å·¦å³ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œè´Ÿè½½æœ‰å‡é«˜ä¸ä¸€å®šæ˜¯åˆç†çš„ï¼ˆåé¢ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼‰ å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“æ—¢ç„¶è¯´æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¼šå¼•èµ·è´Ÿè½½çš„å˜åŒ–ï¼Œé‚£ä¹ˆè·‘ä¸€äº›ç¨‹åºï¼Œè®©ç¨‹åºä¸åœè¿è¡Œï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶å°±èƒ½æ„é€ å‡ºæŒç»­è¿è¡Œçš„è¿›ç¨‹äº†ã€‚æˆ‘è¿™é‡Œæ‰¾äº†ä¸‰å°æœºå™¨(64C)ï¼Œç”¨æˆ‘çš„å‹æµ‹å·¥å…·å…ˆè·‘ä¸€äº›çº¯ CPU çš„è¿ç®—ï¼Œç„¶åè§‚å¯Ÿä¸‹æ•ˆæœï¼š æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹: 10 å¹¶å‘ 30min nohup ./sysstress cpu --cpu-number 10 --duration 30m &gt; /dev/null 2&gt;&amp;1 30 å¹¶å‘ 30min nohup ./sysstress cpu --cpu-number 30 --duration 30m &gt; /dev/null 2&gt;&amp;1 60 å¹¶å‘ 30min nohup ./sysstress cpu --cpu-number 60 --duration 30m &gt; /dev/null 2&gt;&amp;1 æ•ˆæœå¦‚ä¸‹: 10å¹¶å‘è´Ÿè½½, 30å¹¶å‘è´Ÿè½½, 60å¹¶å‘è´Ÿè½½, ä»ä¸Šè¿°æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨çº¯è¿ç®—è¿™ç§åœºæ™¯ä¸‹ï¼Œå¹¶å‘çš„é‡åŸºæœ¬ä¸Šå’Œè´Ÿè½½æ˜¯å¯¹åº”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´éšç€ CPUçš„ä½¿ç”¨é‡ ä¸Šæ¶¨ï¼Œè´Ÿè½½ä¹Ÿä¼šä¸æ–­å˜é«˜ã€‚ ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“åœ¨åˆšæ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†çº¯è¿ç®—å¯¹è´Ÿè½½çš„å½±å“ï¼ˆR è¿›ç¨‹çš„ä»£è¡¨ï¼‰ï¼Œç„¶ååœ¨å…³äº D è¿›ç¨‹çš„è¯´æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„è¯´æ˜ (usually IO) ,å³é€šå¸¸æ˜¯ IO å¼•èµ·çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ç£ç›˜ IO æ¥æµ‹è¯•ä¸€ä¸‹ æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹: 10 å¹¶å‘ 15min nohup ./sysstress io --operation read --filepath test.access.log -p 10 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp; 30 å¹¶å‘ 15min nohup ./sysstress io --operation read --filepath test.access.log -p 30 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp; 60 å¹¶å‘ 15min nohup ./sysstress io --operation read --filepath test.access.log -p 60 -d 15m &gt; /dev/null 2&gt;&amp;1 &amp; æ•ˆæœå¦‚ä¸‹: 10å¹¶å‘è´Ÿè½½ 30å¹¶å‘è´Ÿè½½ 60å¹¶å‘è´Ÿè½½ æˆ‘ä»¬ä¹Ÿé¡ºä¾¿çœ‹ä¸€ä¸‹ï¼Œ60 å¹¶å‘ä¸‹ CPU çš„æƒ…å†µ: 60å¹¶å‘ç³»ç»Ÿæ•´ä½“æƒ…å†µ è¿™é‡Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç³»ç»Ÿçš„ CPU åŸºæœ¬ä¸Šå·²ç»è·‘æ»¡äº†ã€‚us å’Œ sy éƒ½å çš„æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ç§è¯»å–éå¸¸æœ‰å¯èƒ½èµ°åˆ°ç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬æƒ³æµ‹ç»•è¿‡ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡ DIRECT çš„æ–¹å¼ã€‚ ä½†æ˜¯ä¸Šé¢çš„ä¾‹å­å…¶å®ä¹Ÿè¯æ˜äº†ä¸€ä»¶äº‹ï¼ŒIO çš„æ“ä½œä¹Ÿæ˜¯ä¼šå¯¼è‡´è´Ÿè½½äº§ç”Ÿé£™å‡ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç£ç›˜IO å’Œ CPU æ“ä½œéƒ½ä¼šå¯¼è‡´ç³»ç»Ÿè´Ÿè½½é£™å‡ï¼Œé‚£ä¹ˆè´Ÿè½½é£™å‡ä¸€å®šä¼šæ˜¯è¿™ä¸¤ä¸ªåŸå› å—ï¼Ÿç­”æ¡ˆä¹Ÿæ˜¯æœªå¿…çš„ï¼Œå› ä¸ºä¸Šè¿°æˆ‘ä»¬æ›¾ç»æåˆ°è¿‡ D çŠ¶æ€çš„è¿›ç¨‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¥½åƒè¿˜æ²¡ä»‹ç»è¿‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç»§ç»­æ¨¡æ‹Ÿï¼Œæ—¢ç„¶ D çŠ¶æ€çš„è¿›ç¨‹æ˜¯ IO æ“ä½œå¼•èµ·çš„ï¼Œæ™®é€šçš„ç£ç›˜è¯»å†™ IO å¾ˆéš¾æ¨¡æ‹Ÿï¼Œé‚£æˆ‘ä»¬å°±æ¢ä¸ª IO åœºæ™¯ç»§ç»­æ¨¡æ‹Ÿ â€“ ç½‘ç»œ IOã€‚ é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“è¿™é‡Œç›´æ¥ä¸Šä¸€ä¸ªæ¨¡æ‹Ÿæ–¹æ³•: A æœºå™¨å¼€å¯ NFS Server B æœºå™¨ä½œä¸ºå®¢æˆ·ç«¯è¿›è¡ŒæŒ‚è½½ æ–­å¼€ç½‘ç»œ ç–¯ç‹‚ df -h è¯¦ç»†çš„æ“ä½œæ­¥éª¤: 1234567891011121314151617181920212223242526# å®‰è£… Centossudo yum install nfs-utils# æœåŠ¡ç«¯é…ç½®sudo mkdir -p /mnt/nfs_sharesudo chown nobody:nogroup /mnt/nfs_sharesudo chmod 755 /mnt/nfs_share## æ‰“å¼€ /etc/exports é…ç½®ï¼Œæ·»åŠ ä¸€è¡Œæ¥å®šä¹‰å…±äº«ç›®å½•åŠå…¶æƒé™ã€‚ä¾‹å¦‚ï¼Œå°† /mnt/nfs_share å…±äº«ç»™ç½‘ç»œ 192.168.1.0/24ï¼Œå¹¶æä¾›è¯»å†™æƒé™ï¼š/mnt/nfs_share 192.168.1.0/24(rw,sync,no_subtree_check)## å¯åŠ¨ NFSsudo exportfs -asudo systemctl restart nfs-kernel-serversudo systemctl enable nfs-kernel-server# å®¢æˆ·ç«¯é…ç½®sudo mkdir -p /mnt/nfs_clientsudo mount -t nfs 192.168.1.100(server ip):/mnt/nfs_share /mnt/nfs_client## éªŒè¯df -h /mnt/nfs_client# æ–­ç½‘æ¨¡æ‹Ÿ(å®¢æˆ·ç«¯)iptables -I INPUT -s serverip -j DROP# æŒç»­(ç–¯ç‹‚)æ‰§è¡Œï¼šdu -sh /mnt/nfs_client å› ä¸ºç½‘ç»œå·²ç»æ–­æ‰ï¼Œæ‰€ä»¥du -sh /mnt/nfs_client,è€Œä¸”è¿™ä¸ªç¨‹åºæ²¡æœ‰è‡ªåŠ¨é€€å‡ºæˆ–è€…æŠ¥é”™ï¼Œè¿™æ ·å°±å¯¼è‡´ç¨‹åºæ— æ³•é¡ºåˆ©æ‰§è¡Œä¸‹å»ï¼Œç»§è€Œé˜»å¡ä½å°±å˜æˆäº† D çŠ¶æ€çš„è¿›ç¨‹ã€‚ åŸºäºè¿™ç§æ¨¡æ‹Ÿæ–¹æ³•å¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ä¸‹ï¼Œç¬”è€…ä¹‹å‰åšè¿‡ä¸€ä¸ªåœºæ™¯ï¼Œå°†ä¸€ä¸ªä¸¤æ ¸å¿ƒçš„ CPUè´Ÿè½½å¹²åˆ°äº† 200 å¤šï¼Œä½†æ˜¯å› ä¸ºè¿™ç§æƒ…å†µä¸‹æ›´å¤šæ˜¯é˜»å¡åœ¨ç½‘ç»œä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶çš„è´Ÿè½½è™½é«˜ï¼Œå¹¶ä¸ä¸€å®šå½±å“ç³»ç»Ÿè¿è¡Œã€‚ å½“ç„¶è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼Œç¬”è€…æ›¾ç»ä¹Ÿå› ä¸ºè§è¿‡ ping æ“ä½œé˜»å¡å¯¼è‡´çš„è´Ÿè½½é£™å‡ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯æ˜¯å¤šç§å¤šæ ·çš„ğŸ˜‚ï¼Œå¤§å®¶æœ‰æ›´å¤šçš„ä¾‹å­ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚ è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥åŸºäºä¸Šé¢çš„ä¾‹å­å’Œåœºæ™¯æ¨¡æ‹Ÿï¼Œæˆ‘ä»¬å…¶å®åº”è¯¥å·²ç»æœ‰ä¸€å¥—åŸºæœ¬çš„æ’æŸ¥æ–¹æ³•äº†ï¼Œä¸‹é¢è¿™å¼ å›¾æ˜¯æˆ‘ä¸ªäººçš„ä¸€äº›æ€»ç»“(å›¾è¿˜ä¼šä¸æ–­å®Œå–„) è´Ÿè½½é«˜æ’æŸ¥å¯¼å›¾","tags":["Linux","Java","Golang","commands"],"categories":["é—®é¢˜æ’æŸ¥"]},{"title":"JAVAé—®é¢˜å®šä½","path":"/2024/07/30/JAVAé—®é¢˜å®šä½/","content":"ä¸€ã€JAVA ç›¸å…³å‘½ä»¤1.jpsjps - Lists the instrumented Java Virtual Machines (JVMs) on the target system. This command is experimental and unsupported. ç›¸å…³å‚æ•° 123456789101112131415OPTIONS The jps command supports a number of options that modify the output of the command. These options are subject to change or removal in the future. -q Suppresses the output of the class name, JAR file name, and arguments passed to the main method, producing only a list of local JVM identifiers. -m Displays the arguments passed to the main method. The output may be null for embedded JVMs. -l Displays the full package name for the application&#x27;s main class or the full path name to the application&#x27;s JAR file. -v Displays the arguments passed to the JVM. -V Suppresses the output of the class name, JAR file name, and arguments passed to the main method, producing only a list of local JVM identifiers. -Joption Passes option to the JVM, where option is one of the options described on the reference page for the Java application launcher. For example, -J-Xms48m sets the startup memory to 48 MB. See java(1). 2.jinfojinfoï¼ˆJava Virtual Machine Configuration Informationï¼‰æ˜¯JDKæä¾›çš„ä¸€ä¸ªå¯ä»¥å®æ—¶æŸ¥çœ‹Javaè™šæ‹Ÿæœºå„ç§é…ç½®å‚æ•°å’Œç³»ç»Ÿå±æ€§çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä½¿ç”¨jpså‘½ä»¤çš„-vå‚æ•°å¯ä»¥æŸ¥çœ‹Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶æ˜¾å¼æŒ‡å®šçš„é…ç½®å‚æ•°ï¼Œå¦‚æœæƒ³æŸ¥çœ‹æ²¡æœ‰æ˜¾å¼æŒ‡å®šçš„é…ç½®å‚æ•°å°±å¯ä»¥ä½¿ç”¨jinfoå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ã€‚å¦å¤–ï¼Œjinfoå‘½ä»¤è¿˜å¯ä»¥æŸ¥è¯¢Javaè™šæ‹Ÿæœºè¿›ç¨‹çš„System.getProperties()çš„å†…å®¹ã€‚ ä»¥tomcatè¿›ç¨‹ä¸ºä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889Attaching to process ID 2045, please wait...Debugger attached successfully.Server compiler detected.JVM version is 25.242-b08Java System Properties:java.vendor = Huawei Technologies Co., Ltdsun.java.launcher = SUN_STANDARDcatalina.base = /usr/share/tomcatsun.management.compiler = HotSpot 64-Bit Tiered Compilerssun.nio.ch.bugLevel = catalina.useNaming = truejnidispatch.path = /var/cache/tomcat/temp/jna--903012287/jna4240128671455089550.tmpos.name = Linuxsun.boot.class.path = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/resources.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/rt.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/sunrsasign.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jsse.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jce.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/charsets.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/jfr.jar:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/classesjava.vm.specification.vendor = Oracle Corporationjava.runtime.version = 1.8.0_242-b08jna.loaded = trueuser.name = xxxtomcat.util.scan.StandardJarScanFilter.jarsToScan = taglibs-standard-impl*.jarshared.loader = tomcat.util.buf.StringCache.byte.enabled = trueuser.language = enjava.naming.factory.initial = org.apache.naming.java.javaURLContextFactorysun.boot.library.path = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/amd64java.version = 1.8.0_242java.util.logging.manager = org.apache.juli.ClassLoaderLogManageruser.timezone = Asia/Shanghaisun.arch.data.model = 64java.util.concurrent.ForkJoinPool.common.threadFactory = org.apache.catalina.startup.SafeForkJoinWorkerThreadFactoryjava.endorsed.dirs = sun.cpu.isalist = sun.jnu.encoding = UTF-8file.encoding.pkg = sun.iopackage.access = sun.,org.apache.catalina.,org.apache.coyote.,org.apache.jasper.,org.apache.tomcat.file.separator = /java.specification.name = Java Platform API Specificationjava.class.version = 52.0user.country = USjava.home = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jrejava.vm.info = mixed modeos.version = 4.19.90-24.4.v2101.ky10.x86_64sun.font.fontmanager = sun.awt.X11FontManagerpath.separator = :java.vm.version = 25.242-b08jboss.i18n.generate-proxies = truejava.awt.printerjob = sun.print.PSPrinterJobsun.io.unicode.encoding = UnicodeLittleawt.toolkit = sun.awt.X11.XToolkitpackage.definition = sun.,java.,org.apache.catalina.,org.apache.coyote.,org.apache.jasper.,org.apache.naming.,org.apache.tomcat.java.naming.factory.url.pkgs = org.apache.namingmail.mime.splitlongparameters = falsejava.security.egd = file:/dev/./urandomuser.home = /home/shtermjava.specification.vendor = Oracle Corporationtomcat.util.scan.StandardJarScanFilter.jarsToSkip = activ*.jar,amqp-client.jar,annotations-api.jar,ant-junit*.jar,ant-launcher.jar,ant.jar,antlr.jar,aopalliance.jar,asm-*.jar,aspectj*.jar,bcp*.jar,bootstrap.jar,catalina-ant.jar,catalina-ha.jar,catalina-jmx-remote.jar,catalina-storeconfig.jar,catalina-tribes.jar,catalina-ws.jar,catalina.jar,cglib-*.jar,classmate.jar,cobertura-*.jar,commons-*.jar,compress-lzf.jar,curator-*.jar,db2-jdbc.jar,dom4j-*.jar,easymock-*.jar,ecj-*.jar,el-api.jar,elasticsearch.jar,geronimo-spec-jaxrpc*.jar,groovy-all.jar,guava.jar,h2*.jar,hamcrest-*.jar,hibernate*.jar,hppc.jar,http*.jar,icu4j-*.jar,itext*.jar,jackson-*.jar,jandex.jar,jasper-el.jar,jasper.jar,jasperreports*.jar,jaspic-api.jar,javamail.jar,javassist.jar,jaxb-*.jar,jaxen*.jar,jboss*.jar,jc*.jar,jdom-*.jar,jedis.jar,jetty-*.jar,jfreechart.jar,jgit.jar,jline.jar,jmx-tools.jar,jmx.jar,jna.jar,joda-time.jar,jr-*.jar,jsch.jar,json*.jar,jsoup.jar,jsp-api.jar,jsr166e.jar,jstl.jar,jta*.jar,junit-*.jar,junit.jar,liquibase-*.jar,log4j*.jar,lucene*.jar,mail*.jar,mariadb-jdbc.jar,mssql-jdbc.jar,mybatis.jar,netty.jar,nmap4j.jar,objenesis*.jar,olap4j.jar,opc*.jar,oracle-jdbc.jar,oraclepki.jar,oro-*.jar,poi*.jar,postgresql-jdbc.jar,quartz.jar,servlet-api-*.jar,servlet-api.jar,slf4j*.jar,snakeyaml.jar,snmp4j.jar,spring*.jar,sshd-core.jar,taglibs-standard-spec-*.jar,tagsoup-*.jar,t-digest.jar,tomcat-api.jar,tomcat-coyote.jar,tomcat-dbcp.jar,tomcat-i18n-*.jar,tomcat-jdbc.jar,tomcat-jni.jar,tomcat-juli-adapters.jar,tomcat-juli.jar,tomcat-util-scan.jar,tomcat-util.jar,tomcat-websocket.jar,tools.jar,validation-api.jar,velocypack.jar,websocket-api.jar,wl*.jar,wsdl4j*.jar,xercesImpl.jar,xml-apis.jar,xmlbeans.jar,xmlParserAPIs-*.jar,xmlParserAPIs.jar,xom-*.jar,xz.jar,zip4j.jar,zookeeper.jarjava.library.path = /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/libjava.vendor.url = http://jdk.rnd.huawei.com/java.vm.vendor = Huawei Technologies Co., Ltdcommon.loader = &quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;java.runtime.name = OpenJDK Runtime Environmentsun.java.command = org.apache.catalina.startup.Bootstrap startjava.class.path = /usr/share/tomcat/bin/bootstrap.jar:/usr/share/tomcat/bin/tomcat-juli.jar:/usr/lib/java/commons-daemon.jarjava.vm.specification.name = Java Virtual Machine Specificationjava.vm.specification.version = 1.8catalina.home = /usr/share/tomcatsun.cpu.endian = littlesun.os.patch.level = unknownjava.awt.headless = truejava.io.tmpdir = /var/cache/tomcat/tempjava.vendor.url.bug = http://jdk.rnd.huawei.com/server.loader = java.rmi.server.hostname = 127.0.0.1jna.platform.library.path = /usr/lib64:/lib64:/usr/lib:/lib:/usr/lib64/tracker-miners-2.0:/usr/lib64/tracker-2.0:/usr/lib64/dyninst:/usr/libexec/sudo:/usr/lib64/sssd:/usr/pgsql-9.6/lib:/usr/lib64/perl5/CORE:/usr/lib64/opencryptoki:/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/amd64/jli:/usr/lib64/bind9-exportos.arch = amd64java.awt.graphicsenv = sun.awt.X11GraphicsEnvironmentjava.ext.dirs = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.ky10.x86_64/jre/lib/ext:/usr/java/packages/lib/extuser.dir = /usr/share/tomcatline.separator = java.vm.name = OpenJDK 64-Bit Server VMlog4j.configurationFile = /etc/tomcat/log4j2.xmlfile.encoding = UTF-8com.sun.jndi.ldap.object.disableEndpointIdentification = java.specification.version = 1.8VM Flags:Non-default VM flags: -XX:CICompilerCount=4 -XX:GCLogFileSize=20971520 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=null -XX:InitialHeapSize=243269632 -XX:MaxHeapSize=1610612736 -XX:MaxNewSize=536870912 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=80740352 -XX:NumberOfGCLogFiles=15 -XX:OldSize=162529280 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseGCLogFileRotation -XX:+UseParallelGC Command line: -Xmx1536m -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/tomcat -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=15 -XX:GCLogFileSize=20m -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/var/log/tomcat/tomcat-gc-%t.log -Dcom.sun.jndi.ldap.object.disableEndpointIdentification -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Dlog4j.configurationFile=/etc/tomcat/log4j2.xml -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager 3.jstatå‘½ä»¤å‚æ•°è¯´æ˜ï¼š generalOptionsï¼šé€šç”¨é€‰é¡¹ï¼Œå¦‚æœæŒ‡å®šä¸€ä¸ªé€šç”¨é€‰é¡¹ï¼Œå°±ä¸èƒ½æŒ‡å®šä»»ä½•å…¶ä»–é€‰é¡¹æˆ–å‚æ•°ã€‚å®ƒåŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªé€‰é¡¹ï¼š -helpï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚ -optionsï¼šæ˜¾ç¤ºoutputOptionså‚æ•°çš„åˆ—è¡¨ã€‚ outputOptionsï¼šè¾“å‡ºé€‰é¡¹ï¼ŒæŒ‡å®šæ˜¾ç¤ºæŸä¸€ç§Javaè™šæ‹Ÿæœºä¿¡æ¯ã€‚ -tï¼šæŠŠæ—¶é—´æˆ³åˆ—æ˜¾ç¤ºä¸ºè¾“å‡ºçš„ç¬¬ä¸€åˆ—ã€‚è¿™ä¸ªæ—¶é—´æˆ³æ˜¯ä»Javaè™šæ‹Ÿæœºçš„å¼€å§‹è¿è¡Œåˆ°ç°åœ¨çš„ç§’æ•°ã€‚ -h nï¼šæ¯æ˜¾ç¤ºnè¡Œæ˜¾ç¤ºä¸€æ¬¡è¡¨å¤´ï¼Œå…¶ä¸­nä¸ºæ­£æ•´æ•°ã€‚é»˜è®¤å€¼ä¸º 0ï¼Œå³ä»…åœ¨ç¬¬ä¸€è¡Œæ•°æ®æ˜¾ç¤ºä¸€æ¬¡è¡¨å¤´ã€‚ vmidï¼šè™šæ‹Ÿæœºå”¯ä¸€IDï¼ˆLVMIDï¼ŒLocal Virtual Machine Identifierï¼‰ï¼Œå¦‚æœæŸ¥çœ‹æœ¬æœºå°±æ˜¯Javaè¿›ç¨‹çš„è¿›ç¨‹IDã€‚ intervalï¼šæ˜¾ç¤ºä¿¡æ¯çš„æ—¶é—´é—´éš”ï¼Œå•ä½é»˜è®¤æ¯«ç§’ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šç§’ä¸ºå•ä½ï¼Œæ¯”å¦‚ï¼š1sã€‚å¦‚æœæŒ‡å®šäº†è¯¥å‚æ•°ï¼Œjstatå‘½ä»¤å°†æ¯éš”è¿™æ®µæ—¶é—´æ˜¾ç¤ºä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ã€‚ countï¼šæ˜¾ç¤ºæ•°æ®çš„æ¬¡æ•°ï¼Œé»˜è®¤å€¼æ˜¯æ— ç©·å¤§ï¼Œè¿™å°†å¯¼è‡´jstatå‘½ä»¤ä¸€ç›´æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼Œç›´åˆ°ç›®æ ‡JVMç»ˆæ­¢æˆ–jstatå‘½ä»¤ç»ˆæ­¢ã€‚è¾“å‡ºé€‰é¡¹å¦‚æœä¸æŒ‡å®šé€šç”¨é€‰é¡¹ï¼ˆgeneralOptionsï¼‰ï¼Œåˆ™å¯ä»¥æŒ‡å®šè¾“å‡ºé€‰é¡¹ï¼ˆoutputOptionsï¼‰ã€‚è¾“å‡ºé€‰é¡¹å†³å®šjstatå‘½ä»¤æ˜¾ç¤ºçš„å†…å®¹å’Œæ ¼å¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š -classï¼šæ˜¾ç¤ºç±»åŠ è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´å’Œè£…è½½è€—æ—¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -compilerï¼šæ˜¾ç¤ºå³æ—¶ç¼–è¯‘çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯ã€‚ -gcï¼šæ˜¾ç¤ºå †å„ä¸ªåŒºåŸŸå†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -gccapacityï¼šæ˜¾ç¤ºå †å„ä¸ªåŒºåŸŸçš„å®¹é‡åŠå…¶å¯¹åº”çš„ç©ºé—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcutilï¼šæ˜¾ç¤ºæœ‰å…³åƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ‘˜è¦ã€‚ -gccauseï¼šæ˜¾ç¤ºå…³äºåƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ‘˜è¦(ä¸-gcutilç›¸åŒ)ï¼Œä»¥åŠæœ€è¿‘å’Œå½“å‰åƒåœ¾å›æ”¶çš„åŸå› ã€‚ -gcnewï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcnewcapacityï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£çš„å¤§å°åŠå…¶å¯¹åº”çš„ç©ºé—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcold: æ˜¾ç¤ºè€å¹´ä»£å’Œå…ƒç©ºé—´çš„åƒåœ¾å›æ”¶ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcoldcapacityï¼šæ˜¾ç¤ºè€å¹´ä»£çš„å¤§å°ç»Ÿè®¡ä¿¡æ¯ã€‚ -gcmetacapacityï¼šæ˜¾ç¤ºå…ƒç©ºé—´çš„å¤§å°çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ -printcompilationï¼šæ˜¾ç¤ºå³æ—¶ç¼–è¯‘æ–¹æ³•çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ äºŒã€çº¿ç¨‹å †æ ˆ1.è¾“å‡ºJavaè™šæ‹Ÿæœºæä¾›äº†çº¿ç¨‹è½¬å‚¨(Thread dump)çš„åé—¨ï¼Œé€šè¿‡è¿™ä¸ªåé—¨ï¼Œå¯ä»¥å°†çº¿ç¨‹å †æ ˆæ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªåé—¨å°±æ˜¯é€šè¿‡å‘Javaè¿›ç¨‹å‘é€ä¸€ä¸ªQUITä¿¡å·ï¼ŒJavaè™šæ‹Ÿæœºæ”¶åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œå°†ç³»ç»Ÿå½“å‰çš„JAVAçº¿ç¨‹è°ƒç”¨å †æ ˆæ‰“å°å‡ºæ¥ã€‚ æ‰“å°æ–¹æ³•ï¼š jstack -l pid &gt; xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼ kill -3åŒæ—¶è¯·ç¡®ä¿Javaå‘½ä»¤è¡Œä¸­æ²¡æœ‰DISABLE_JAVADUMPè¿è¡Œé€‰é¡¹ 2.çº¿ç¨‹åˆ†æé€šè¿‡è¾“å‡ºå †æ ˆè¿›è¡Œåˆ†æ jstack -l $(jps | grep xxx | awk &#39;&#123;print $1&#125;&#39;) &gt; &#x2F;tmp&#x2F;xxx.jstack 12345678910111213141516171819202122232425262728293031&quot;SYS_STATUS_CHECKER&quot; #14 daemon prio=5 os_prio=0 tid=0x00007f5e047bf000 nid=0xe15 waiting on condition [0x00007f5dd43d1000] java.lang.Thread.State: TIMED_WAITING (sleeping) at java.lang.Thread.sleep(Native Method)ru at com.xxx.xxx.SystemStatusChecker.run(SystemStatusChecker.java:xx) at java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers: - None &quot;RMI Reaper&quot; #39 prio=5 os_prio=0 tid=0x00007f5e04e4c800 nid=0xf0b in Object.wait() [0x00007f5dae2c4000] java.lang.Thread.State: WAITING (on object monitor) at java.lang.Object.wait(Native Method) - waiting on &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock) at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144) - locked &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock) at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165) at sun.rmi.transport.ObjectTable$Reaper.run(ObjectTable.java:351) at java.lang.Thread.run(Thread.java:748) Locked ownable synchronizers: - None &quot;main&quot; #1 prio=5 os_prio=0 tid=0x00007f5e0400a000 nid=0xdcb runnable [0x00007f5e0b393000] java.lang.Thread.State: RUNNABLE at java.net.PlainSocketImpl.socketAccept(Native Method) at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409) at java.net.ServerSocket.implAccept(ServerSocket.java:545) at java.net.ServerSocket.accept(ServerSocket.java:513) at com.xxx.common.xxx.await(CommonMain.java:244) at com.xxx.common.xxx.startup(CommonMain.java:207) at com.xxx.common.xxx.main(CommonMain.java:147) Locked ownable synchronizers: - None åœ¨RMIçº¿ç¨‹ä¸­å¯ä»¥çœ‹åˆ° â€œ - locked &lt;0x00000000c0c88d20&gt; (a java.lang.ref.ReferenceQueue$Lock)â€ è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»ä½¿ç”¨äº†IDä¸ºâ€0x00000000c0c88d2â€çš„é”ï¼Œé”çš„IDç”±ç³»ç»Ÿè‡ªåŠ¨äº§ç”Ÿ 123&quot;main&quot; prio=5 os_prio=0 tid=0x00007f5e0400a000 nid=0xdcb runnable [0x00007f5e0b393000]| | | | | | |çº¿ç¨‹åç§° çº¿ç¨‹ä¼˜å…ˆçº§ æ“ä½œç³»ç»Ÿçº§åˆ«çš„ä¼˜å…ˆçº§ çº¿ç¨‹id å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹ID çŠ¶æ€ çº¿ç¨‹å ç”¨å†…å­˜åœ°å€ å…¶ä¸­â€çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹idå·â€æ‰€æŒ‡çš„â€æœ¬åœ°çº¿ç¨‹â€æ˜¯æŒ‡è¯¥Javaçº¿ç¨‹æ‰€å¯¹åº”çš„è™šæ‹Ÿæœºä¸­çš„æœ¬åœ°çº¿ç¨‹ã€‚æˆ‘ä»¬çŸ¥é“Javaæ˜¯è§£æå‹è¯­è¨€ï¼Œæ‰§è¡Œçš„å®ä½“æ˜¯Javaè™šæ‹Ÿæœºï¼Œå› æ­¤Javaè¯­è¨€ä¸­çš„çº¿ç¨‹æ˜¯ ä¾é™„äºJavaè™šæ‹Ÿæœºä¸­çš„æœ¬åœ°çº¿ç¨‹æ¥è¿è¡Œçš„ï¼Œå®é™…ä¸Šæ˜¯æœ¬åœ°çº¿ç¨‹åœ¨æ‰§è¡ŒJavaçº¿ç¨‹ä»£ç ã€‚ Javaä»£ç  ä¸­åˆ›å»ºä¸€ä¸ªthreadï¼Œè™šæ‹Ÿæœºåœ¨è¿è¡ŒæœŸå°±ä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°çº¿ç¨‹ï¼Œè€Œè¿™ä¸ªæœ¬åœ°çº¿ç¨‹æ‰æ˜¯çœŸæ­£çš„çº¿ç¨‹å®ä½“ã€‚ä¸ºäº†æ›´åŠ æ·±å…¥å¾—ç†è§£æœ¬åœ°çº¿ç¨‹å’ŒJavaçº¿ç¨‹çš„å…³ç³»ï¼Œåœ¨Unix&#x2F;Linuxä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€š å¦‚ä¸‹æ–¹å¼æŠŠJavaè™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹æ‰“å°å‡ºæ¥ï¼š ä½¿ç”¨ps -ef | grep java è·å¾—Javaè¿›ç¨‹IDã€‚ ä½¿ç”¨pstack è·å¾—Javaè™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹çš„å †æ ˆå…¶ä¸­æœ¬åœ°çº¿ç¨‹å„é¡¹å«ä¹‰å¦‚ä¸‹ï¼š12345Thread 56 (Thread 0x7f5e0b394700 (LWP 3531))| | || | +----æœ¬åœ°çº¿ç¨‹id(å¦ä¸€ç§è¡¨ç¤º,LWP-light weight process)| +-------------------æœ¬åœ°çº¿ç¨‹id+------------------------------çº¿ç¨‹åç§° è€Œé€šè¿‡jstackè¾“å‡ºçš„mainæœ¬åœ°çº¿ç¨‹IDä¸º0xdcbï¼Œå…¶10è¿›åˆ¶æ­£å¥½ä¸º3531ã€‚ â€œrunnableâ€è¡¨ç¤ºå½“å‰çº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ã€‚è¿™ä¸ªrunnableçŠ¶æ€æ˜¯ä»è™šæ‹Ÿæœºçš„è§’åº¦æ¥çœ‹çš„, è¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹æ­£åœ¨è¿è¡Œ âš ï¸ NOTE: ä½†æ˜¯å¤„äºRunnableçŠ¶æ€çš„çº¿ç¨‹ä¸ä¸€å®šçœŸçš„æ¶ˆè€—CPU. å¤„äºRunnableçš„çº¿ç¨‹åªèƒ½è¯´æ˜è¯¥çº¿ç¨‹æ²¡æœ‰é˜»å¡åœ¨javaçš„waitæˆ–è€…sleepæ–¹æ³•ä¸Šï¼ŒåŒæ—¶ä¹Ÿæ²¡ç­‰å¾…åœ¨é”ä¸Šé¢ã€‚ä½†æ˜¯å¦‚æœè¯¥çº¿ç¨‹è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•ï¼Œè€Œæœ¬åœ°æ–¹æ³•å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™è™šæ‹Ÿæœºæ˜¯ä¸çŸ¥é“æœ¬åœ°ä»£ç ä¸­å‘ç”Ÿ äº†ä»€ä¹ˆï¼ˆä½†æ“ä½œç³»ç»Ÿæ˜¯çŸ¥é“çš„ï¼Œpstackå°±æ˜¯æ“ä½œæä¾›çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒçŸ¥é“å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æœ¬åœ°ä»£ç ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ­¤æ—¶å°½ç®¡å½“å‰çº¿ç¨‹å®é™…ä¸Šä¹Ÿæ˜¯é˜»å¡çš„çŠ¶æ€ï¼Œä½†å®é™…ä¸Šæ˜¾ç¤ºå‡ºæ¥çš„è¿˜æ˜¯runnableçŠ¶æ€ï¼Œ è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸æ¶ˆè€—CPUçš„ 121. å¤„äºwaittigå’ŒblockedçŠ¶æ€çš„çº¿ç¨‹éƒ½ä¸ä¼šæ¶ˆè€—CPU 2. çº¿ç¨‹é¢‘ç¹åœ°æŒ‚èµ·å’Œå”¤é†’éœ€è¦æ¶ˆè€—CPU, è€Œä¸”ä»£ä»·é¢‡å¤§ TIMED_WAITING(on object monitor) è¡¨ç¤ºå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,è¯´æ˜è¯¥çº¿ç¨‹æ­£åœ¨ æ‰§è¡Œobj.wait(int time)æ–¹æ³•. TIMED_WAITING(sleeping) è¡¨ç¤ºå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,å³æ­£åœ¨æ‰§è¡ŒThread.sleep(int time)æ–¹æ³•. TIMED_WAITING(parking) å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ä¸€æ®µæ—¶é—´,å³æ­£åœ¨æ‰§è¡ŒThread.sleep(int time)æ–¹æ³•. WAINTING(on object monitor) å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œå³æ­£åœ¨æ‰§è¡Œobj.wait()æ–¹æ³•(æ— å‚æ•°çš„wait()æ–¹æ³•).1234å¤„äºTIMED_WAITINGã€WAINTINGçŠ¶æ€çš„çº¿ç¨‹ä¸€å®šä¸æ¶ˆè€—CPU. å¤„äºRUNNABLEçš„çº¿ç¨‹ï¼Œè¦ç»“åˆå½“å‰çº¿ç¨‹ä»£ç çš„æ€§è´¨åˆ¤æ–­ï¼Œæ˜¯å¦æ¶ˆè€—CPU.â€¢ å¦‚æœæ˜¯çº¯Javaè¿ç®—ä»£ç ï¼Œåˆ™æ¶ˆè€—CPU.â€¢ å¦‚æœæ˜¯ç½‘ç»œIO,å¾ˆå°‘æ¶ˆè€—CPU.â€¢ å¦‚æœæ˜¯æœ¬åœ°ä»£ç ï¼Œç»“åˆæœ¬åœ°ä»£ç çš„æ€§è´¨åˆ¤æ–­(å¯ä»¥é€šè¿‡pstack/gstackè·å–æœ¬åœ°çº¿ç¨‹å †æ ˆ)ï¼Œ å¦‚æœæ˜¯çº¯è¿ç®—ä»£ç ï¼Œåˆ™æ¶ˆè€—CPU, å¦‚æœè¢«æŒ‚èµ·ï¼Œåˆ™ä¸æ¶ˆè€—CPU,å¦‚æœæ˜¯IO,åˆ™ä¸æ€ä¹ˆæ¶ˆ è€—CPUã€‚ ä¸‰ã€ç›¸å…³çš„æ’æŸ¥æ–¹æ³•1.CPUç”Ÿäº§ç¯å¢ƒä¸­å¾€å¾€ä¼šå‡ºç°CPUé£™é«˜çš„æƒ…å†µï¼Œå¯¹äºJAVAåº”ç”¨è€Œè¨€ï¼Œæ­¤ç±»é—®é¢˜ç›¸å¯¹è¾ƒå¥½ç¡®å®šé—®é¢˜æ–¹å‘ã€‚ 1.1 ä½¿ç”¨jstackç¡®å®šCPUå ç”¨é«˜çš„çº¿ç¨‹\\é€šè¿‡topæŒ‡ä»¤ï¼Œå¯ä»¥çœ‹åˆ°è¿›ç¨‹å ç”¨çš„ä¸€äº›åŸºç¡€èµ„æºä¿¡æ¯ï¼Œç„¶åâ€œPâ€é”®å¯ä»¥æŒ‰ç…§CPUä½¿ç”¨ç‡è¿›è¡Œæ’åºï¼Œâ€œMâ€é”®å¯ä»¥æŒ‰ç…§å†…å­˜å ç”¨æƒ…å†µè¿›è¡Œæ’åº æ‰¾åˆ°CPUå ç”¨é«˜çš„è¿›ç¨‹pidï¼Œç„¶åå°†jstackä¿¡æ¯å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼Œé€šè¿‡top -Hp pidæŸ¥çœ‹å…·ä½“çš„æƒ…å†µã€‚ é€šè¿‡ printf &#39;%x &#39; pidå°†pidè½¬æ¢ä¸º16è¿›åˆ¶ï¼Œç„¶ååœ¨jstackæ–‡ä»¶ä¸­æ ¹æ®å¯¹åº”çš„æ•°å­—è¿›è¡ŒæŸ¥æ‰¾ï¼Œç„¶åé’ˆå¯¹æ€§çš„è¿›è¡Œåˆ†æ 1.2 é¢‘ç¹GCæœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥å…ˆç¡®å®šä¸‹gcæ˜¯ä¸æ˜¯å¤ªé¢‘ç¹ï¼Œä½¿ç”¨jstat -gc pid 1000å‘½ä»¤æ¥å¯¹gcåˆ†ä»£å˜åŒ–æƒ…å†µè¿›è¡Œè§‚å¯Ÿï¼Œ1000è¡¨ç¤ºé‡‡æ ·é—´éš”(ms)ï¼ŒS0C/S1Cã€S0U/S1Uã€EC/EUã€OC/OUã€MC/MUåˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªSurvivoråŒºã€EdenåŒºã€è€å¹´ä»£ã€å…ƒæ•°æ®åŒºçš„å®¹é‡å’Œä½¿ç”¨é‡ã€‚YGC/YGTã€FGC/FGCTã€GCTåˆ™ä»£è¡¨YoungGcã€FullGcçš„è€—æ—¶å’Œæ¬¡æ•°ä»¥åŠæ€»è€—æ—¶ã€‚å¦‚æœçœ‹åˆ°gcæ¯”è¾ƒé¢‘ç¹ï¼Œå†é’ˆå¯¹gcæ–¹é¢åšè¿›ä¸€æ­¥åˆ†æã€‚ 1.3 é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢é’ˆå¯¹é¢‘ç¹ä¸Šä¸‹æ–‡é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨vmstatå‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹cs(context switch)ä¸€åˆ—åˆ™ä»£è¡¨äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ã€‚ å¦‚æœæˆ‘ä»¬å¸Œæœ›å¯¹ç‰¹å®šçš„pidè¿›è¡Œç›‘æ§é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ pidstat -w pidå‘½ä»¤ï¼Œcswchå’Œnvcswchè¡¨ç¤ºè‡ªæ„¿åŠéè‡ªæ„¿åˆ‡æ¢ã€‚ 2.å†…å­˜å¯¹äºJAVAåº”ç”¨ï¼Œæ¶‰åŠåˆ°çš„å†…å­˜é—®é¢˜ä¸»è¦åŒ…æ‹¬OOMã€GCé—®é¢˜å’Œå †å¤–å†…å­˜ã€‚ 2.1 OOMJVMä¸­çš„å†…å­˜ä¸è¶³ï¼ŒOOMå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µ Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: unable to create new native thread è¿™ä¸ªæ„æ€æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ç»™çº¿ç¨‹åˆ†é…javaæ ˆï¼ŒåŸºæœ¬ä¸Šè¿˜æ˜¯çº¿ç¨‹æ± ä»£ç å†™çš„æœ‰é—®é¢˜ï¼Œæ¯”å¦‚è¯´å¿˜è®°shutdownï¼Œæ‰€ä»¥è¯´åº”è¯¥é¦–å…ˆä»ä»£ç å±‚é¢æ¥å¯»æ‰¾é—®é¢˜ï¼Œä½¿ç”¨jstackæˆ–è€…jmapã€‚å¦‚æœä¸€åˆ‡éƒ½æ­£å¸¸ï¼ŒJVMæ–¹é¢å¯ä»¥é€šè¿‡æŒ‡å®šXssæ¥å‡å°‘å•ä¸ªthread stackçš„å¤§å°ã€‚å¦å¤–ä¹Ÿå¯ä»¥åœ¨ç³»ç»Ÿå±‚é¢ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹/etc/security/limits.confnofileå’Œnprocæ¥å¢å¤§oså¯¹çº¿ç¨‹çš„é™åˆ¶ Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space è¿™ä¸ªæ„æ€æ˜¯å †çš„å†…å­˜å ç”¨å·²ç»è¾¾åˆ°-Xmxè®¾ç½®çš„æœ€å¤§å€¼ï¼Œåº”è¯¥æ˜¯æœ€å¸¸è§çš„OOMé”™è¯¯äº†ã€‚è§£å†³æ€è·¯ä»ç„¶æ˜¯å…ˆåº”è¯¥åœ¨ä»£ç ä¸­æ‰¾ï¼Œæ€€ç–‘å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œé€šè¿‡jstackå’Œjmapå»å®šä½é—®é¢˜ã€‚å¦‚æœè¯´ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œæ‰éœ€è¦é€šè¿‡è°ƒæ•´Xmxçš„å€¼æ¥æ‰©å¤§å†…å­˜ã€‚ Caused by: java.lang.OutOfMemoryError: Meta space è¿™ä¸ªæ„æ€æ˜¯å…ƒæ•°æ®åŒºçš„å†…å­˜å ç”¨å·²ç»è¾¾åˆ°XX:MaxMetaspaceSizeè®¾ç½®çš„æœ€å¤§å€¼ï¼Œæ’æŸ¥æ€è·¯å’Œä¸Šé¢çš„ä¸€è‡´ï¼Œå‚æ•°æ–¹é¢å¯ä»¥é€šè¿‡XX:MaxPermSizeæ¥è¿›è¡Œè°ƒæ•´ Exception in thread &quot;main&quot; java.lang.StackOverflowError è¡¨ç¤ºçº¿ç¨‹æ ˆéœ€è¦çš„å†…å­˜å¤§äºXsså€¼ï¼ŒåŒæ ·ä¹Ÿæ˜¯å…ˆè¿›è¡Œæ’æŸ¥ï¼Œå‚æ•°æ–¹é¢é€šè¿‡Xssæ¥è°ƒæ•´ï¼Œä½†è°ƒæ•´çš„å¤ªå¤§å¯èƒ½åˆä¼šå¼•èµ·OOMã€‚ 2.2 GCé—®é¢˜gcé—®é¢˜é™¤äº†å½±å“cpuä¹Ÿä¼šå½±å“å†…å­˜ï¼Œæ’æŸ¥æ€è·¯ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚ä¸€èˆ¬å…ˆä½¿ç”¨jstatæ¥æŸ¥çœ‹åˆ†ä»£å˜åŒ–æƒ…å†µï¼Œæ¯”å¦‚youngGCæˆ–è€…fullGCæ¬¡æ•°æ˜¯ä¸æ˜¯å¤ªå¤šå‘€ï¼›EUã€OUç­‰æŒ‡æ ‡å¢é•¿æ˜¯ä¸æ˜¯å¼‚å¸¸ç­‰ã€‚ çº¿ç¨‹çš„è¯å¤ªå¤šè€Œä¸”ä¸è¢«åŠæ—¶gcä¹Ÿä¼šå¼•å‘oomï¼Œå¤§éƒ¨åˆ†å°±æ˜¯ä¹‹å‰è¯´çš„unable to create new native threadã€‚é™¤äº†jstackç»†ç»†åˆ†ædumpæ–‡ä»¶å¤–ï¼Œæˆ‘ä»¬ä¸€èˆ¬å…ˆä¼šçœ‹ä¸‹æ€»ä½“çº¿ç¨‹ï¼Œé€šè¿‡pstreee -p pid |wc -l 2.3 å †å¤–å†…å­˜JVM çš„å †å¤–å†…å­˜ä¸»è¦åŒ…æ‹¬ï¼š JVM è‡ªèº«è¿è¡Œå ç”¨çš„ç©ºé—´ï¼› çº¿ç¨‹æ ˆåˆ†é…å ç”¨çš„ç³»ç»Ÿå†…å­˜ï¼› DirectByteBuffer å ç”¨çš„å†…å­˜ï¼› JNI é‡Œåˆ†é…çš„å†…å­˜ï¼› Java 8 å¼€å§‹çš„å…ƒæ•°æ®ç©ºé—´ï¼› NIO ç¼“å­˜ Unsafe è°ƒç”¨åˆ†é…çš„å†…å­˜ï¼› codecache å†°å±±å¯¹è±¡ï¼šå†°å±±å¯¹è±¡æ˜¯æŒ‡åœ¨ JVM å †é‡Œå ç”¨çš„å†…å­˜å¾ˆå°ï¼Œä½†å…¶å®å¼•ç”¨äº†ä¸€å—å¾ˆå¤§çš„æœ¬åœ°å†…å­˜ã€‚DirectByteBuffer å’Œ çº¿ç¨‹éƒ½å±äºè¿™ç±»å¯¹è±¡ã€‚ 2.3.1NMTåˆ†æå †å¤–å†…å­˜NMTï¼ˆNative Memory Trackingï¼‰æ˜¯ HotSpot JVM å¼•å…¥çš„è·Ÿè¸ª JVM å†…éƒ¨ä½¿ç”¨çš„æœ¬åœ°å†…å­˜çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡ jcmd å·¥å…·è®¿é—® NMT æ•°æ®ã€‚NMT ç›®å‰ä¸æ”¯æŒè·Ÿè¸ªç¬¬ä¸‰æ–¹æœ¬åœ°ä»£ç çš„å†…å­˜åˆ†é…å’Œ JDK ç±»åº“ã€‚ NMT ä¸è·Ÿè¸ªé JVM ä»£ç çš„å†…å­˜åˆ†é…ï¼Œæœ¬åœ°ä»£ç é‡Œçš„å†…å­˜æ³„éœ²éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„å·¥å…·æ¥å®šä½ã€‚ 2.3.2 å¼€å¯ NMTå¯ç”¨ NMT ä¼šå¸¦æ¥ 5-10% çš„æ€§èƒ½æŸå¤±ã€‚NMT çš„å†…å­˜ä½¿ç”¨ç‡æƒ…å†µéœ€è¦æ·»åŠ ä¸¤ä¸ªæœºå™¨å­— word åˆ° malloc å†…å­˜çš„ malloc å¤´é‡Œã€‚NMT å†…å­˜ä½¿ç”¨ç‡ä¹Ÿè¢« NMT è·Ÿè¸ªã€‚å¯åŠ¨å‘½ä»¤ï¼š -XX:NativeMemoryTracking=[off | summary | detail]ã€‚ offï¼šNMT é»˜è®¤æ˜¯å…³é—­çš„ï¼› summaryï¼šåªæ”¶é›†å­ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨çš„æ€»è®¡æ•°æ®ï¼› detailï¼šæ”¶é›†æ¯ä¸ªè°ƒç”¨ç‚¹çš„å†…å­˜ä½¿ç”¨æ•°æ®ã€‚ 2.3.3 jcmd è®¿é—® NMT æ•°æ®å‘½ä»¤ï¼šjcmd &lt;pid&gt; VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]","tags":["JAVA","Linux"],"categories":["é—®é¢˜æ’æŸ¥"]},{"title":"ä¸ªäººä»‹ç»","path":"/about/index.html","content":"ç®€ä»‹ èŒä¸š: è¿ç»´å¼€å‘å·¥ç¨‹å¸ˆ å‡ºç”Ÿæ—¶é—´: 98å¹´ æ€§åˆ«: ç”· è”ç³»æ–¹å¼: &#x34;&#x34;&#x36;&#x33;&#48;&#50;&#x38;&#54;&#x34;&#64;&#113;&#113;&#46;&#99;&#x6f;&#x6d;&#x2F;&#98;&#97;&#105;&#120;&#105;&#x61;&#111;&#122;&#104;&#111;&#117;&#57;&#x36;&#64;&#103;&#109;&#97;&#x69;&#108;&#46;&#99;&#x6f;&#x6d; å·¥ä½œå±¥å† 2020.7-2023.6 æ­å·é½æ²»ç§‘æŠ€ è½¯ä»¶å¼€å‘å·¥ç¨‹å¸ˆ 2023.7-2024.1 è…¾è®¯äº‘ ES SRE 2024.3- é‡‘å±±äº‘ SRE ä¸ªäººé¡¹ç›® SysStress è‡ªå·±å†™çš„ä¸€ä¸ªæ€§èƒ½å‹æµ‹å·¥å…·ï¼Œè¿˜åœ¨ä¸æ–­å®Œå–„ä¸­"},{"path":"/comments/index.html","content":"ç•™è¨€æ¿ æ¬¢è¿å¤§å®¶åœ¨è¿™é‡Œè¿›è¡Œç•™è¨€ï¼Œè¿›è¡Œé—®é¢˜æ¢è®¨"},{"title":"ä¸ªäººä»‹ç»","path":"/friends/index.html","content":"Test"}]